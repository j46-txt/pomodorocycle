<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PomodoroCycle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.5s ease;
        }
        .timer-text {
            font-size: 6rem; /* Increased font size */
            line-height: 1;
        }
        .tab-button.active {
            border-bottom-width: 4px;
        }
        .achievement-item.unlocked {
            opacity: 1;
        }
        .achievement-item.locked {
            opacity: 0.6;
        }
        .modal {
            display: none; /* Hidden by default */
        }
        .modal.show {
            display: flex; /* Show when active */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .progress-bar-container {
            width: 100%;
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 5px;
        }
        .progress-bar {
            height: 100%;
            background-color: #4caf50;
            border-radius: 5px;
            transition: width 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-slate-900 text-white flex flex-col items-center justify-center min-h-screen p-4 selection:bg-sky-400 selection:text-sky-900">

    <div class="w-full max-w-3xl mx-auto bg-slate-800 shadow-2xl rounded-lg p-6 relative">
        <div class="absolute top-6 right-6 z-10">
            <button id="settingsButton" class="p-2 rounded-full hover:bg-slate-700 transition-colors focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-opacity-50">
                <i class="fas fa-cog text-xl text-sky-400 hover:text-sky-300"></i>
            </button>
        </div>

        <div id="timerDisplay" class="text-center mb-6 pt-8 md:pt-4 pb-8 rounded-lg bg-slate-700 shadow-inner">
            <p id="currentModeDisplay" class="text-2xl font-semibold mb-2 text-sky-300">Current Mode: Study</p>
            <p id="timerText" class="timer-text font-mono font-bold text-sky-500">25:00</p>
            <p id="cycleInfo" class="text-sm text-slate-400 mt-2">Pomodoro Session: 1/4 | Total Cycles Today: 0</p>
            <p id="lastTimerInfo" class="text-xs text-slate-500 mt-1">Last timer: None</p>
        </div>

        <div class="flex justify-center space-x-4 mb-8">
            <button id="startPauseButton" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                <i class="fas fa-play mr-2"></i>Start
            </button>
            <button id="resetButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                <i class="fas fa-undo mr-2"></i>Reset Current
            </button>
        </div>
        
        <div class="flex justify-center space-x-2 mb-8">
            <button data-mode="study" class="manual-timer-select bg-slate-600 hover:bg-slate-500 text-sm py-2 px-4 rounded-md transition-colors">Force Study</button>
            <button data-mode="shortBreak" class="manual-timer-select bg-slate-600 hover:bg-slate-500 text-sm py-2 px-4 rounded-md transition-colors">Force Short Break</button>
            <button data-mode="longBreak" class="manual-timer-select bg-slate-600 hover:bg-slate-500 text-sm py-2 px-4 rounded-md transition-colors">Force Long Break</button>
        </div>

        <div class="mb-6 border-b border-slate-700">
            <nav class="flex space-x-1 -mb-px">
                <button data-tab="stats" class="tab-button active text-sky-400 border-sky-400 py-3 px-4 font-medium text-center hover:text-sky-300 hover:border-sky-300 transition-colors">
                    <i class="fas fa-chart-line mr-2"></i>Statistics
                </button>
                <button data-tab="rewards" class="tab-button text-slate-400 border-transparent py-3 px-4 font-medium text-center hover:text-sky-300 hover:border-sky-300 transition-colors">
                    <i class="fas fa-gift mr-2"></i>Daily Rewards
                </button>
                <button data-tab="achievements" class="tab-button text-slate-400 border-transparent py-3 px-4 font-medium text-center hover:text-sky-300 hover:border-sky-300 transition-colors">
                    <i class="fas fa-trophy mr-2"></i>Achievements
                </button>
            </nav>
        </div>

        <div id="tabContent">
            <div id="statsContent" class="tab-pane active p-4 bg-slate-700 rounded-b-lg">
                <h3 class="text-xl font-semibold mb-4 text-sky-300">Your Statistics</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-slate-600 p-4 rounded-lg shadow">
                        <h4 class="font-bold text-sky-400">Daily:</h4>
                        <p>Cycles Completed Today: <span id="dailyCycles">0</span></p>
                        <p>Pure Study Time Today: <span id="dailyStudyTime">0h 0m</span></p>
                    </div>
                    <div class="bg-slate-600 p-4 rounded-lg shadow">
                        <h4 class="font-bold text-sky-400">General:</h4>
                        <p>Total Days Studied: <span id="totalDaysStudied">0</span></p>
                        <p>Total Cycles Completed: <span id="totalCycles">0</span></p>
                        <p>Total Pure Study Time: <span id="totalStudyTime">0h 0m</span></p>
                        <p>Consecutive Study Days (Streak): <span id="streakCounter">0</span> <i class="fas fa-fire text-orange-400"></i></p>
                    </div>
                </div>
            </div>

            <div id="rewardsContent" class="tab-pane hidden p-4 bg-slate-700 rounded-b-lg">
                <h3 class="text-xl font-semibold mb-4 text-sky-300">Manage Daily Rewards</h3>
                <div class="mb-4 p-3 bg-slate-600 rounded-lg">
                    <input type="text" id="rewardName" placeholder="Reward name" class="w-full md:w-1/3 p-2 rounded bg-slate-500 text-white placeholder-slate-300 mb-2 md:mb-0 md:mr-2">
                    <select id="rewardType" class="w-full md:w-1/4 p-2 rounded bg-slate-500 text-white mb-2 md:mb-0 md:mr-2">
                        <option value="cycles">Completed Cycles</option>
                        <option value="studyHours">Study Hours</option>
                    </select>
                    <input type="number" id="rewardThreshold" placeholder="Value (e.g., 2 or 1.5)" step="0.1" min="0.1" class="w-full md:w-1/4 p-2 rounded bg-slate-500 text-white placeholder-slate-300 mb-2 md:mb-0 md:mr-2">
                    <button id="addRewardButton" class="w-full md:w-auto bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition-colors">Add Reward</button>
                </div>
                <div id="rewardsList" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                    </div>
            </div>

            <div id="achievementsContent" class="tab-pane hidden p-4 bg-slate-700 rounded-b-lg">
                <h3 class="text-xl font-semibold mb-4 text-sky-300">Your Achievements</h3>
                <div id="achievementsList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 max-h-80 overflow-y-auto pr-2">
                    </div>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-50">
        <div class="bg-slate-800 p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-sky-400">Timer Settings</h2>
            <div class="space-y-4">
                <div>
                    <label for="studyTimeInput" class="block text-sm font-medium text-slate-300">Study Time (minutes):</label>
                    <input type="number" id="studyTimeInput" min="1" class="mt-1 block w-full p-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500">
                </div>
                <div>
                    <label for="shortBreakTimeInput" class="block text-sm font-medium text-slate-300">Short Break (minutes):</label>
                    <input type="number" id="shortBreakTimeInput" min="1" class="mt-1 block w-full p-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500">
                </div>
                <div>
                    <label for="longBreakTimeInput" class="block text-sm font-medium text-slate-300">Long Break (minutes):</label>
                    <input type="number" id="longBreakTimeInput" min="1" class="mt-1 block w-full p-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500">
                </div>
                 <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-slate-300">Enable Sounds:</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="soundToggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-slate-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-sky-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-sky-500"></div>
                    </label>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-slate-300">Enable Desktop Notifications:</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="notificationsToggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-slate-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-sky-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-sky-500"></div>
                    </label>
                </div>
            </div>
            <div class="mt-8 flex justify-end space-x-3">
                <button id="cancelSettingsButton" class="px-4 py-2 text-sm font-medium text-slate-300 bg-slate-600 hover:bg-slate-500 rounded-md transition-colors">Cancel</button>
                <button id="saveSettingsButton" class="px-4 py-2 text-sm font-medium text-white bg-sky-500 hover:bg-sky-600 rounded-md transition-colors">Save Settings</button>
            </div>
        </div>
    </div>

    <div id="customAlertModal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-[100]">
        <div class="bg-slate-800 p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
            <div id="customAlertIcon" class="text-4xl mb-4"></div>
            <h3 id="customAlertTitle" class="text-xl font-bold mb-2"></h3>
            <p id="customAlertMessage" class="text-slate-300 mb-6"></p>
            <button id="customAlertCloseButton" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded transition-colors">OK</button>
        </div>
    </div>


    <script>
        // --- DOM Elements ---
        const timerTextEl = document.getElementById('timerText');
        const currentModeDisplayEl = document.getElementById('currentModeDisplay');
        const cycleInfoEl = document.getElementById('cycleInfo');
        const lastTimerInfoEl = document.getElementById('lastTimerInfo');
        const startPauseButton = document.getElementById('startPauseButton');
        const resetButton = document.getElementById('resetButton');
        const manualTimerSelectButtons = document.querySelectorAll('.manual-timer-select');
        
        const settingsButton = document.getElementById('settingsButton');
        const settingsModal = document.getElementById('settingsModal');
        const saveSettingsButton = document.getElementById('saveSettingsButton');
        const cancelSettingsButton = document.getElementById('cancelSettingsButton');
        const studyTimeInput = document.getElementById('studyTimeInput');
        const shortBreakTimeInput = document.getElementById('shortBreakTimeInput');
        const longBreakTimeInput = document.getElementById('longBreakTimeInput');
        const soundToggle = document.getElementById('soundToggle');
        const notificationsToggle = document.getElementById('notificationsToggle');

        const tabButtons = document.querySelectorAll('.tab-button');
        const tabPanes = document.querySelectorAll('.tab-pane');

        const dailyCyclesEl = document.getElementById('dailyCycles');
        const dailyStudyTimeEl = document.getElementById('dailyStudyTime');
        const totalDaysStudiedEl = document.getElementById('totalDaysStudied');
        const totalCyclesEl = document.getElementById('totalCycles');
        const totalStudyTimeEl = document.getElementById('totalStudyTime');
        const streakCounterEl = document.getElementById('streakCounter');

        const rewardNameInput = document.getElementById('rewardName');
        const rewardTypeSelect = document.getElementById('rewardType');
        const rewardThresholdInput = document.getElementById('rewardThreshold');
        const addRewardButton = document.getElementById('addRewardButton');
        const rewardsListEl = document.getElementById('rewardsList');
        const achievementsListEl = document.getElementById('achievementsList');

        const customAlertModal = document.getElementById('customAlertModal');
        const customAlertIconEl = document.getElementById('customAlertIcon');
        const customAlertTitleEl = document.getElementById('customAlertTitle');
        const customAlertMessageEl = document.getElementById('customAlertMessage');
        const customAlertCloseButton = document.getElementById('customAlertCloseButton');

        // --- State Variables ---
        let timerInterval;
        let timeLeft; // in seconds
        let currentMode = 'study'; // 'study', 'shortBreak', 'longBreak'
        let isRunning = false;
        let pomodorosInCycle = 0; // 0-3 study sessions in current cycle before long break
        const POMODOROS_PER_CYCLE = 4;

        let appData = {
            settings: {
                studyTime: 25,
                shortBreakTime: 5,
                longBreakTime: 15,
                soundEnabled: true,
                notificationsEnabled: true,
            },
            timerState: {
                lastTimerUsed: null, // 'study', 'shortBreak', 'longBreak'
            },
            stats: {
                daily: { date: getTodayDateString(), cyclesCompleted: 0, pureStudySeconds: 0, firstStudySessionCompletedToday: false },
                general: { totalDaysStudied: 0, totalCyclesCompleted: 0, totalPureStudySeconds: 0, streak: 0, lastStudyDate: null },
            },
            rewards: [], // { id, name, type: 'cycles'/'studyHours', threshold, earnedToday, notificationShown }
            achievements: [], // { id, name, description, type, threshold, unlocked, unlockedDate, notificationShown, icon }
            appVersion: "1.0.2" // Updated version for English translation
        };
        
        const defaultAchievements = [
            // Days Studied
            { id: "days1", name: "Focused Beginner", description: "Complete your first day of study.", type: "totalDaysStudied", threshold: 1, icon: "fas fa-seedling" },
            { id: "days7", name: "Weekly Commitment", description: "Study for 7 days.", type: "totalDaysStudied", threshold: 7, icon: "fas fa-calendar-check" },
            { id: "days15", name: "Fortnightly Persistence", description: "Study for 15 days.", type: "totalDaysStudied", threshold: 15, icon: "fas fa-medal" },
            { id: "days30", name: "Monthly Habit", description: "Study for 30 days.", type: "totalDaysStudied", threshold: 30, icon: "fas fa-award" },
            { id: "days50", name: "Consistent Student", description: "Study for 50 days.", type: "totalDaysStudied", threshold: 50, icon: "fas fa-star" },
            { id: "days75", name: "Study Marathoner", description: "Study for 75 days.", type: "totalDaysStudied", threshold: 75, icon: "fas fa-running" },
            { id: "days100", name: "Habit Master", description: "Study for 100 days.", type: "totalDaysStudied", threshold: 100, icon: "fas fa-crown" },
            { id: "days120", name: "Academic Legend", description: "Study for 120 days.", type: "totalDaysStudied", threshold: 120, icon: "fas fa-book-reader" },
            { id: "days150", name: "Study Sage", description: "Study for 150 days.", type: "totalDaysStudied", threshold: 150, icon: "fas fa-graduation-cap" },
            // Cycles Completed
            { id: "cycles1", name: "First Full Cycle", description: "Complete 1 Pomodoro cycle.", type: "totalCyclesCompleted", threshold: 1, icon: "fas fa-flag-checkered" },
            { id: "cycles10", name: "Ten Cycles of Focus", description: "Complete 10 Pomodoro cycles.", type: "totalCyclesCompleted", threshold: 10, icon: "fas fa-spinner fa-spin" },
            { id: "cycles25", name: "Twenty-Five Cycles", description: "Complete 25 Pomodoro cycles.", type: "totalCyclesCompleted", threshold: 25, icon: "fas fa-cogs" },
            { id: "cycles50", name: "Fifty Cycles of Productivity", description: "Complete 50 Pomodoro cycles.", type: "totalCyclesCompleted", threshold: 50, icon: "fas fa-rocket" },
            { id: "cycles100", name: "One Hundred Cycles Mastered", description: "Complete 100 Pomodoro cycles.", type: "totalCyclesCompleted", threshold: 100, icon: "fas fa-gem" },
            { id: "cycles200", name: "Two Hundred Relentless Cycles", description: "Complete 200 cycles.", type: "totalCyclesCompleted", threshold: 200, icon: "fas fa-shield-alt" },
            { id: "cycles300", name: "Three Hundred Cycles of Mastery", description: "Complete 300 cycles.", type: "totalCyclesCompleted", threshold: 300, icon: "fas fa-chess-king" },
            { id: "cycles400", name: "Four Hundred Legendary Cycles", description: "Complete 400 cycles.", type: "totalCyclesCompleted", threshold: 400, icon: "fas fa-dragon" },
            { id: "cycles500", name: "Five Hundred Supreme Cycles", description: "Complete 500 cycles.", type: "totalCyclesCompleted", threshold: 500, icon: "fas fa-infinity" },
            // Pure Study Hours
            { id: "hours1", name: "First Hour of Focus", description: "Accumulate 1 hour of pure study.", type: "totalPureStudyHours", threshold: 1, icon: "fas fa-hourglass-start" },
            { id: "hours10", name: "Ten Hours of Immersion", description: "Accumulate 10 hours of pure study.", type: "totalPureStudyHours", threshold: 10, icon: "fas fa-brain" },
            { id: "hours20", name: "Twenty Hours of Concentration", description: "Accumulate 20 hours of pure study.", type: "totalPureStudyHours", threshold: 20, icon: "fas fa-book-open" },
            { id: "hours50", name: "Fifty Hours of Dedication", description: "Accumulate 50 hours of pure study.", type: "totalPureStudyHours", threshold: 50, icon: "fas fa-microscope" },
            { id: "hours100", name: "One Hundred Hours of Knowledge", description: "Accumulate 100 hours of pure study.", type: "totalPureStudyHours", threshold: 100, icon: "fas fa-university" },
            { id: "hours200", name: "Two Hundred Hours of Wisdom", description: "Accumulate 200 hours of pure study.", type: "totalPureStudyHours", threshold: 200, icon: "fas fa-atom" },
            { id: "hours300", name: "Three Hundred Hours of Erudition", description: "Accumulate 300 hours of pure study.", type: "totalPureStudyHours", threshold: 300, icon: "fas fa-lightbulb" },
            { id: "hours400", name: "Four Hundred Hours of Enlightenment", description: "Accumulate 400 hours of pure study.", type: "totalPureStudyHours", threshold: 400, icon: "fas fa-satellite-dish" },
            { id: "hours500", name: "Five Hundred Hours of Genius", description: "Accumulate 500 hours of pure study.", type: "totalPureStudyHours", threshold: 500, icon: "fas fa-user-astronaut" },
             // Streak Achievements
            { id: "streak3", name: "3-Day Combo!", description: "Maintain a 3-day study streak.", type: "streak", threshold: 3, icon: "fas fa-fire" },
            { id: "streak7", name: "7-Day Combo: Unstoppable!", description: "Maintain a 7-day study streak.", type: "streak", threshold: 7, icon: "fas fa-bolt" },
            { id: "streak14", name: "14-Day Combo: Power of Habit!", description: "Maintain a 14-day study streak.", type: "streak", threshold: 14, icon: "fas fa-dumbbell" },
            { id: "streak30", name: "30-Day Combo: Master of Consistency!", description: "Maintain a 30-day study streak.", type: "streak", threshold: 30, icon: "fas fa-calendar-alt" }
        ];

        // --- Sound Synthesis (Tone.js) ---
        let synth;
        if (typeof Tone !== 'undefined') {
            synth = new Tone.Synth().toDestination();
        } else {
            console.warn("Tone.js not loaded. Sound effects will be disabled.");
        }

        function playSound(note = 'C4', duration = '8n', type = 'timerComplete') {
            if (!appData.settings.soundEnabled || !synth) return;
            try {
                if (type === 'timerComplete') synth.triggerAttackRelease(note, duration);
                else if (type === 'achievement') synth.triggerAttackRelease("C5", "4n");
                else if (type === 'reward') synth.triggerAttackRelease("E5", "4n");
            } catch (error) {
                console.error("Error playing sound:", error);
            }
        }
        
        // --- Utility Functions ---
        function getTodayDateString() {
            const today = new Date();
            return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function formatHoursMinutes(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            return `${hours}h ${minutes}m`;
        }
        
        function generateUUID() { // Basic UUID generator
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }


        // --- Data Persistence (localStorage) ---
        const STORAGE_KEY = 'pomodoroGamifiedAppData';

        function loadData() {
            const storedData = localStorage.getItem(STORAGE_KEY);
            if (storedData) {
                const parsedData = JSON.parse(storedData);
                
                if (parsedData.appVersion !== appData.appVersion && parsedData.appVersion === "1.0.1") { // Specific check for migration from PT to EN
                    console.log(`Data is from Portuguese version ${parsedData.appVersion}. Achievements will use new English definitions.`);
                    // User's progress on achievements (unlocked, unlockedDate) will be kept if IDs match.
                    // Rewards are user-defined, so their names will remain as the user entered them (might be in Portuguese).
                } else if (parsedData.appVersion !== appData.appVersion) {
                     console.log(`Migrating data from version ${parsedData.appVersion} to ${appData.appVersion}`);
                }


                const mergedAchievements = defaultAchievements.map(defaultAch => {
                    const userAch = parsedData.achievements?.find(ua => ua.id === defaultAch.id);
                    return { 
                        ...defaultAch, // Takes new English name/description
                        unlocked: userAch?.unlocked || false, 
                        unlockedDate: userAch?.unlockedDate || null,
                        notificationShown: userAch?.notificationShown || false // Reset notification shown for newly translated ones
                    };
                });
                
                // Preserve user-created rewards as they are
                const userRewards = parsedData.rewards || [];

                appData = { ...appData, ...parsedData, achievements: mergedAchievements, rewards: userRewards };


                // Ensure daily stats are for today
                if (appData.stats.daily.date !== getTodayDateString()) {
                    resetDailyStats();
                }
            } else {
                // Initialize achievements if no stored data
                appData.achievements = defaultAchievements.map(ach => ({ ...ach, unlocked: false, unlockedDate: null, notificationShown: false }));
            }
            // Apply loaded settings to inputs
            studyTimeInput.value = appData.settings.studyTime;
            shortBreakTimeInput.value = appData.settings.shortBreakTime;
            longBreakTimeInput.value = appData.settings.longBreakTime;
            soundToggle.checked = appData.settings.soundEnabled;
            notificationsToggle.checked = appData.settings.notificationsEnabled;
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
        }

        // --- Notifications ---
        function requestNotificationPermission() {
            if (!('Notification' in window)) {
                showCustomAlert("Error", "This browser does not support desktop notifications.", "fas fa-exclamation-triangle text-yellow-400");
                appData.settings.notificationsEnabled = false;
                notificationsToggle.checked = false;
                notificationsToggle.disabled = true;
                return;
            }
            if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        appData.settings.notificationsEnabled = true;
                    } else {
                        appData.settings.notificationsEnabled = false;
                        notificationsToggle.checked = false;
                         showCustomAlert("Warning", "Desktop notifications disabled. You can enable them in your browser settings.", "fas fa-info-circle text-blue-400");
                    }
                    saveData(); 
                });
            } else if (Notification.permission === 'denied') {
                 appData.settings.notificationsEnabled = false;
                 notificationsToggle.checked = false;
                 notificationsToggle.disabled = true; 
            }
        }

        function showNotification(title, body) { 
            if (!appData.settings.notificationsEnabled || Notification.permission !== 'granted') return;
            const options = {
                body: body,
                icon: 'https://cdn-icons-png.flaticon.com/512/1384/1384784.png' // Example: tomato icon
            };
            try {
                new Notification(title, options);
            } catch (e) {
                console.error("Error showing notification:", e);
                new Notification(title, {body: body});
            }
        }
        
        // --- Custom Alert Modal ---
        function showCustomAlert(title, message, iconClass = "fas fa-info-circle text-sky-400") {
            customAlertTitleEl.textContent = title;
            customAlertMessageEl.textContent = message;
            customAlertIconEl.className = `text-4xl mb-4 ${iconClass}`; 
            customAlertModal.classList.add('show');
        }
        customAlertCloseButton.addEventListener('click', () => customAlertModal.classList.remove('show'));


        // --- UI Update Functions ---
        function updateTimerDisplay() {
            timerTextEl.textContent = formatTime(timeLeft);
            const currentModeNameElement = currentModeDisplayEl.textContent.split(': ')[1];
            const currentModeName = currentModeNameElement ? currentModeNameElement.trim() : "Pomodoro";
            document.title = `${formatTime(timeLeft)} - ${currentModeName}`;
            
            let modeText = '';
            let bodyClass = 'bg-slate-900'; 
            switch (currentMode) {
                case 'study':
                    modeText = 'Study';
                    bodyClass = 'bg-slate-900'; 
                    timerTextEl.classList.remove('text-green-400', 'text-yellow-400');
                    timerTextEl.classList.add('text-sky-500');
                    break;
                case 'shortBreak':
                    modeText = 'Short Break';
                    bodyClass = 'bg-green-800'; 
                    timerTextEl.classList.remove('text-sky-500', 'text-yellow-400');
                    timerTextEl.classList.add('text-green-400');
                    break;
                case 'longBreak':
                    modeText = 'Long Break';
                    bodyClass = 'bg-yellow-800';
                    timerTextEl.classList.remove('text-sky-500', 'text-green-400');
                    timerTextEl.classList.add('text-yellow-400');
                    break;
            }
            currentModeDisplayEl.textContent = `Current Mode: ${modeText}`;
            document.body.className = document.body.className.replace(/bg-(slate|green|yellow)-(900|800)/g, '') + ` ${bodyClass}`;
            
            updateCycleInfo();
        }

        function updateCycleInfo() {
             cycleInfoEl.textContent = `Pomodoro Session: ${currentMode === 'study' ? pomodorosInCycle + 1 : pomodorosInCycle}/${POMODOROS_PER_CYCLE} | Total Cycles Today: ${appData.stats.daily.cyclesCompleted}`;
        }
        
        function updateLastTimerInfo() {
            let lastTimerText = "None";
            if (appData.timerState.lastTimerUsed) {
                switch(appData.timerState.lastTimerUsed) {
                    case 'study': lastTimerText = "Study"; break;
                    case 'shortBreak': lastTimerText = "Short Break"; break;
                    case 'longBreak': lastTimerText = "Long Break"; break;
                }
            }
            lastTimerInfoEl.textContent = `Last timer: ${lastTimerText}`;
        }

        function updateStatsDisplay() {
            dailyCyclesEl.textContent = appData.stats.daily.cyclesCompleted;
            dailyStudyTimeEl.textContent = formatHoursMinutes(appData.stats.daily.pureStudySeconds);
            totalDaysStudiedEl.textContent = appData.stats.general.totalDaysStudied;
            totalCyclesEl.textContent = appData.stats.general.totalCyclesCompleted;
            totalStudyTimeEl.textContent = formatHoursMinutes(appData.stats.general.totalPureStudySeconds);
            streakCounterEl.textContent = appData.stats.general.streak;
        }
        
        function renderRewards() {
            rewardsListEl.innerHTML = '';
            if (appData.rewards.length === 0) {
                rewardsListEl.innerHTML = '<p class="text-slate-400 italic">No rewards configured.</p>';
                return;
            }
            appData.rewards.forEach(reward => {
                const rewardEl = document.createElement('div');
                rewardEl.className = `p-3 rounded-lg flex justify-between items-center transition-all ${reward.earnedToday ? 'bg-green-600 shadow-lg' : 'bg-slate-500'}`;
                
                let progressText = '';
                let progressPercent = 0;
                const rewardTypeDisplay = reward.type === 'cycles' ? 'Cycles' : 'Hours';
                const rewardUnitDisplay = reward.type === 'cycles' ? 'cycles' : 'hours';

                if (reward.type === 'cycles') {
                    progressText = `${appData.stats.daily.cyclesCompleted}/${reward.threshold} cycles`;
                    progressPercent = Math.min(100, (appData.stats.daily.cyclesCompleted / reward.threshold) * 100);
                } else { // studyHours
                    const currentHours = appData.stats.daily.pureStudySeconds / 3600;
                    progressText = `${currentHours.toFixed(1)}/${reward.threshold} hours`;
                    progressPercent = Math.min(100, (currentHours / reward.threshold) * 100);
                }

                rewardEl.innerHTML = `
                    <div>
                        <p class="font-semibold ${reward.earnedToday ? 'text-white' : 'text-sky-300'}">${reward.name} (${rewardTypeDisplay})</p>
                        <p class="text-xs ${reward.earnedToday ? 'text-green-200' : 'text-slate-300'}">Goal: ${reward.threshold} ${rewardUnitDisplay} | Progress: ${progressText}</p>
                        ${!reward.earnedToday ? `
                            <div class="progress-bar-container mt-1">
                                <div class="progress-bar" style="width: ${progressPercent}%;"></div>
                            </div>
                        ` : '<p class="text-xs text-green-100 font-bold"><i class="fas fa-check-circle mr-1"></i>Reward Earned Today!</p>'}
                    </div>
                    <button data-id="${reward.id}" class="delete-reward-button text-red-300 hover:text-red-500 p-2 rounded-full transition-colors">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                rewardsListEl.appendChild(rewardEl);
            });

            document.querySelectorAll('.delete-reward-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const rewardId = e.currentTarget.dataset.id;
                    appData.rewards = appData.rewards.filter(r => r.id !== rewardId);
                    saveData();
                    renderRewards();
                });
            });
        }

        function renderAchievements() {
            achievementsListEl.innerHTML = '';
            appData.achievements.sort((a,b) => { 
                if (a.unlocked && !b.unlocked) return -1;
                if (!a.unlocked && b.unlocked) return 1;
                return a.threshold - b.threshold;
            });

            appData.achievements.forEach(ach => {
                const achEl = document.createElement('div');
                achEl.className = `achievement-item p-4 rounded-lg shadow-md transition-all transform hover:scale-105 ${ach.unlocked ? 'unlocked bg-sky-600' : 'locked bg-slate-600'}`;
                
                let progressText = '';
                let progressPercent = 0;

                if (!ach.unlocked) {
                    let currentValue = 0;
                    switch (ach.type) {
                        case 'totalDaysStudied': currentValue = appData.stats.general.totalDaysStudied; break;
                        case 'totalCyclesCompleted': currentValue = appData.stats.general.totalCyclesCompleted; break;
                        case 'totalPureStudyHours': currentValue = appData.stats.general.totalPureStudySeconds / 3600; break;
                        case 'streak': currentValue = appData.stats.general.streak; break;
                    }
                    progressPercent = Math.min(100, (currentValue / ach.threshold) * 100);
                    progressText = `<div class="progress-bar-container mt-1">
                                        <div class="progress-bar bg-sky-400" style="width: ${progressPercent}%;"></div>
                                    </div>
                                    <p class="text-xs ${ach.unlocked ? 'text-sky-200' : 'text-slate-400'} mt-1">Progress: ${currentValue.toFixed(ach.type === 'totalPureStudyHours' ? 1: 0)} / ${ach.threshold}</p>`;
                }


                achEl.innerHTML = `
                    <div class="flex items-center mb-2">
                        <i class="${ach.icon || 'fas fa-question-circle'} text-3xl ${ach.unlocked ? 'text-yellow-300' : 'text-slate-400'} mr-3"></i>
                        <div>
                            <h4 class="font-bold ${ach.unlocked ? 'text-white' : 'text-sky-300'}">${ach.name}</h4>
                            <p class="text-xs ${ach.unlocked ? 'text-sky-100' : 'text-slate-300'}">${ach.description}</p>
                        </div>
                    </div>
                    ${ach.unlocked ? `<p class="text-xs text-yellow-200 font-semibold"><i class="fas fa-check-circle mr-1"></i>Unlocked on: ${new Date(ach.unlockedDate).toLocaleDateString()}</p>` : progressText}
                `;
                achievementsListEl.appendChild(achEl);
            });
        }


        // --- Timer Logic ---
        function setTimer(mode) {
            currentMode = mode;
            isRunning = false;
            startPauseButton.innerHTML = '<i class="fas fa-play mr-2"></i>Start';
            clearInterval(timerInterval);

            switch (mode) {
                case 'study':
                    timeLeft = appData.settings.studyTime * 60;
                    break;
                case 'shortBreak':
                    timeLeft = appData.settings.shortBreakTime * 60;
                    break;
                case 'longBreak':
                    timeLeft = appData.settings.longBreakTime * 60;
                    break;
            }
            updateTimerDisplay();
        }

        function startTimer() {
            if (timeLeft <= 0 && currentMode !== 'study' && currentMode !== 'shortBreak' && currentMode !== 'longBreak') { 
                 setTimer('study'); 
            }
            if (timeLeft <= 0) return;

            isRunning = true;
            startPauseButton.innerHTML = '<i class="fas fa-pause mr-2"></i>Pause';
            
            clearInterval(timerInterval); 

            timerInterval = setInterval(() => {
                timeLeft--;
                if (currentMode === 'study') {
                    appData.stats.daily.pureStudySeconds++;
                    appData.stats.general.totalPureStudySeconds++;
                }
                if (timeLeft < 0) {
                    handleTimerEnd();
                } else {
                    updateTimerDisplay();
                }
            }, 1000);
        }

        function pauseTimer() {
            isRunning = false;
            startPauseButton.innerHTML = '<i class="fas fa-play mr-2"></i>Resume';
            clearInterval(timerInterval);
        }
        
        function handleTimerEnd() {
            clearInterval(timerInterval);
            isRunning = false;
            appData.timerState.lastTimerUsed = currentMode;
            updateLastTimerInfo();

            let notificationTitle = "";
            let notificationBody = "";
            let soundNote = 'C4';

            if (currentMode === 'study') {
                notificationTitle = "Study Session Complete!";
                notificationBody = "Time for a break. Good job!";
                soundNote = 'C5';
                pomodorosInCycle++;
                
                if (!appData.stats.daily.firstStudySessionCompletedToday) {
                    appData.stats.daily.firstStudySessionCompletedToday = true;
                    const todayStr = getTodayDateString();
                    if (appData.stats.general.lastStudyDate !== todayStr) { 
                        appData.stats.general.totalDaysStudied++;
                        
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        const yesterdayStr = `${yesterday.getFullYear()}-${String(yesterday.getMonth() + 1).padStart(2, '0')}-${String(yesterday.getDate()).padStart(2, '0')}`;

                        if (appData.stats.general.lastStudyDate === yesterdayStr) {
                            appData.stats.general.streak++;
                        } else if (appData.stats.general.lastStudyDate !== null) { 
                            appData.stats.general.streak = 1; 
                        } else { 
                             appData.stats.general.streak = 1;
                        }
                        appData.stats.general.lastStudyDate = todayStr;
                    }
                }


                if (pomodorosInCycle >= POMODOROS_PER_CYCLE) {
                    setTimer('longBreak');
                    appData.stats.daily.cyclesCompleted++;
                    appData.stats.general.totalCyclesCompleted++;
                    pomodorosInCycle = 0; 
                } else {
                    setTimer('shortBreak');
                }
            } else if (currentMode === 'shortBreak' || currentMode === 'longBreak') {
                notificationTitle = "Break Over!";
                notificationBody = "Time to get back to focus!";
                soundNote = 'E4';
                setTimer('study');
            }
            
            playSound(soundNote, '4n', 'timerComplete');
            showNotification(notificationTitle, notificationBody);
            showCustomAlert(notificationTitle, notificationBody, "fas fa-check-circle text-green-400");
            
            updateTimerDisplay(); 
            updateStatsDisplay(); 
            checkRewards();
            checkAchievements();
            saveData(); 
        }

        function resetCurrentTimer() {
            pauseTimer(); 
            setTimer(currentMode); 
            updateTimerDisplay();
        }

        // --- Stats Logic ---
        function resetDailyStats() {
            appData.stats.daily = {
                date: getTodayDateString(),
                cyclesCompleted: 0,
                pureStudySeconds: 0,
                firstStudySessionCompletedToday: false
            };
            appData.rewards.forEach(reward => {
                reward.earnedToday = false;
                reward.notificationShown = false;
            });
        }

        // --- Rewards Logic ---
        addRewardButton.addEventListener('click', () => {
            const name = rewardNameInput.value.trim();
            const type = rewardTypeSelect.value;
            const threshold = parseFloat(rewardThresholdInput.value);

            if (!name || isNaN(threshold) || threshold <= 0) {
                showCustomAlert("Error", "Please fill in all reward fields correctly.", "fas fa-exclamation-circle text-red-400");
                return;
            }

            appData.rewards.push({
                id: generateUUID(),
                name,
                type,
                threshold,
                earnedToday: false,
                notificationShown: false
            });
            
            rewardNameInput.value = '';
            rewardThresholdInput.value = '';
            saveData();
            renderRewards();
        });

        function checkRewards() {
            let newRewardEarned = false;
            appData.rewards.forEach(reward => {
                if (reward.earnedToday && reward.notificationShown) return; 

                let currentProgress = 0;
                if (reward.type === 'cycles') {
                    currentProgress = appData.stats.daily.cyclesCompleted;
                } else { 
                    currentProgress = appData.stats.daily.pureStudySeconds / 3600;
                }

                if (currentProgress >= reward.threshold && !reward.earnedToday) {
                    reward.earnedToday = true;
                    newRewardEarned = true;
                    if (!reward.notificationShown) {
                        const message = `You earned the reward: "${reward.name}"!`;
                        showNotification("Reward Earned!", message);
                        showCustomAlert("Reward Earned!", message, "fas fa-gift text-yellow-400");
                        playSound('G5', '2n', 'reward');
                        reward.notificationShown = true;
                    }
                }
            });
            if (newRewardEarned) {
                renderRewards(); 
                saveData();
            }
        }

        // --- Achievements Logic ---
        function checkAchievements() {
            let newAchievementUnlocked = false;
            appData.achievements.forEach(ach => {
                if (ach.unlocked && ach.notificationShown) return; 

                let currentValue;
                switch (ach.type) {
                    case 'totalDaysStudied': currentValue = appData.stats.general.totalDaysStudied; break;
                    case 'totalCyclesCompleted': currentValue = appData.stats.general.totalCyclesCompleted; break;
                    case 'totalPureStudyHours': currentValue = appData.stats.general.totalPureStudySeconds / 3600; break;
                    case 'streak': currentValue = appData.stats.general.streak; break;
                    default: return;
                }
                
                if (currentValue >= ach.threshold && !ach.unlocked) {
                    ach.unlocked = true;
                    ach.unlockedDate = new Date().toISOString();
                    newAchievementUnlocked = true;
                    if (!ach.notificationShown) {
                         const message = `You unlocked the achievement: "${ach.name}"!`;
                        showNotification("Achievement Unlocked!", message);
                        showCustomAlert("Achievement Unlocked!", message, `${ach.icon || 'fas fa-trophy'} text-yellow-400`);
                        playSound('A5', '1n', 'achievement');
                        ach.notificationShown = true;
                    }
                }
            });
            if (newAchievementUnlocked) {
                renderAchievements(); 
                saveData();
            }
        }

        // --- Event Listeners ---
        startPauseButton.addEventListener('click', () => {
            if (isRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        });

        resetButton.addEventListener('click', resetCurrentTimer);

        manualTimerSelectButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                pauseTimer(); 
                const selectedMode = e.target.dataset.mode;
                if (selectedMode === 'study' && pomodorosInCycle >= POMODOROS_PER_CYCLE) {
                    pomodorosInCycle = 0; 
                }
                setTimer(selectedMode);
            });
        });

        settingsButton.addEventListener('click', () => settingsModal.classList.add('show'));
        cancelSettingsButton.addEventListener('click', () => {
            studyTimeInput.value = appData.settings.studyTime;
            shortBreakTimeInput.value = appData.settings.shortBreakTime;
            longBreakTimeInput.value = appData.settings.longBreakTime;
            soundToggle.checked = appData.settings.soundEnabled;
            notificationsToggle.checked = appData.settings.notificationsEnabled;
            settingsModal.classList.remove('show');
        });

        saveSettingsButton.addEventListener('click', () => {
            const newStudyTime = parseInt(studyTimeInput.value);
            const newShortBreakTime = parseInt(shortBreakTimeInput.value);
            const newLongBreakTime = parseInt(longBreakTimeInput.value);

            if (isNaN(newStudyTime) || newStudyTime < 1 ||
                isNaN(newShortBreakTime) || newShortBreakTime < 1 ||
                isNaN(newLongBreakTime) || newLongBreakTime < 1) {
                showCustomAlert("Configuration Error", "Times must be positive numbers.", "fas fa-exclamation-circle text-red-400");
                return;
            }

            appData.settings.studyTime = newStudyTime;
            appData.settings.shortBreakTime = newShortBreakTime;
            appData.settings.longBreakTime = newLongBreakTime;
            appData.settings.soundEnabled = soundToggle.checked;
            appData.settings.notificationsEnabled = notificationsToggle.checked;

            if (appData.settings.notificationsEnabled && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                 requestNotificationPermission(); 
            }

            saveData();
            settingsModal.classList.remove('show');
            if (!isRunning) {
                setTimer(currentMode); 
            }
            showCustomAlert("Success", "Settings saved!", "fas fa-check-circle text-green-400");
        });
        

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.dataset.tab;

                tabButtons.forEach(btn => {
                    btn.classList.remove('active', 'text-sky-400', 'border-sky-400');
                    btn.classList.add('text-slate-400', 'border-transparent');
                });
                button.classList.add('active', 'text-sky-400', 'border-sky-400');
                button.classList.remove('text-slate-400', 'border-transparent');

                tabPanes.forEach(pane => {
                    if (pane.id === `${targetTab}Content`) {
                        pane.classList.remove('hidden');
                    } else {
                        pane.classList.add('hidden');
                    }
                });
                updateStatsDisplay();
                renderRewards(); 
                renderAchievements(); 
            });
        });


        // --- Initialization ---
        function initializeApp() {
            loadData(); 
            
            if (appData.stats.daily.date !== getTodayDateString()) {
                resetDailyStats(); 
                saveData(); 
            }

            setTimer(currentMode); 
            updateTimerDisplay();
            updateStatsDisplay();
            updateLastTimerInfo();
            renderRewards();
            renderAchievements();
            
            if (appData.settings.notificationsEnabled && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                requestNotificationPermission(); 
            } else if (Notification.permission === 'denied') {
                appData.settings.notificationsEnabled = false; 
                notificationsToggle.checked = false;
                notificationsToggle.disabled = true;
                saveData();
            }
        }

        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
<head>
    <style>
        .donation-section {
            text-align: center;
            font-size: 0.8em;
            color: #555555;
            margin-top: 10px;
        }

        .donation-section p {
            margin: 0 0 5px 0;
        }

        .donation-section .bmc-btn {
            transform: scale(0.5);
            transform-origin: top center;
        }
    </style>
</head>
<body>
    <div class="donation-section">
        <p>Enjoy the app? Help keep it online</p>
        <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js"
                data-name="bmc-button"
                data-slug="lemonade299792458"
                data-color="#FFDD00"
                data-emoji="☕"
                data-font="Comic"
                data-text="Buy me a coffee"
                data-outline-color="#000000"
                data-font-color="#000000"
                data-coffee-color="#ffffff">
        </script>
    </div>
</body>
</html>