<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gamified Pomodoro Timer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link id="favicon" rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text x="50" y="50" font-size="90" dominant-baseline="middle" text-anchor="middle">üçÖ</text></svg>'>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.5s ease;
            overflow-y: scroll; 
        }
        .timer-text {
            font-size: 6rem; 
            line-height: 1;
        }
        .tab-button.active {
            border-bottom-width: 4px;
        }
        .achievement-item { 
            height: 7rem; 
            display: flex;
            flex-direction: column;
            justify-content: space-between; 
            overflow: hidden; 
        }
        .achievement-item.unlocked {
            opacity: 1;
        }
        .achievement-item.locked {
            opacity: 0.6;
        }
        .modal {
            display: none; 
        }
        .modal.show {
            display: flex; 
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .progress-bar-container {
            width: 100%;
            height: 6px; 
            background-color: #e0e0e0; 
            border-radius: 3px; 
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: #4caf50; 
            border-radius: 3px; 
            transition: width 0.3s ease-in-out;
        }
        .help-content ul {
            list-style-type: none; 
            padding-left: 0; 
            margin-bottom: 10px;
        }
        .help-content li {
            margin-bottom: 5px;
            padding-left: 25px; 
            position: relative;
        }
        .help-content li.break-session {
            color: #a0aec0; 
        }
        /* ### MODIFICATION: More discreet force buttons ### */
        .manual-timer-select {
            background-color: #4a5568; /* slate-700 */
            color: #a0aec0; /* slate-400 */
            border: 1px solid #4a5568; /* slate-700 - same as background for less outline */
        }
        .manual-timer-select:hover {
            background-color: #2d3748; /* slate-800 */
            color: #e2e8f0; /* slate-200 */
            border-color: #2d3748; /* slate-800 - darker border on hover */
        }
    </style>
</head>
<body class="bg-slate-900 text-white flex flex-col items-center min-h-screen p-4 selection:bg-sky-400 selection:text-sky-900">

    <div class="w-full max-w-3xl mx-auto bg-slate-800 shadow-2xl rounded-lg p-6 relative mt-4 mb-4"> 
        <div class="absolute top-6 left-6 z-10">
             <button id="helpButton" title="Help / How to Use" class="p-2 rounded-full text-sky-400 hover:bg-slate-700 hover:text-sky-300 transition-colors focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-opacity-50">
                <i class="fas fa-question-circle text-xl"></i>
            </button>
        </div>
        <div class="absolute top-6 right-6 z-10">
            <button id="settingsButton" title="Settings" class="p-2 rounded-full hover:bg-slate-700 transition-colors focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-opacity-50">
                <i class="fas fa-cog text-xl text-sky-400 hover:text-sky-300"></i>
            </button>
        </div>

        <div id="timerDisplay" class="text-center mb-6 pt-8 md:pt-4 pb-6 rounded-lg bg-slate-700 shadow-inner">
            <p id="currentModeDisplay" class="text-2xl font-semibold mb-2 text-sky-300">Current Mode: Study</p>
            <p id="timerText" class="timer-text font-mono font-bold text-sky-500">25:00</p>
            <div id="cycleInfoContainer" class="text-sm text-slate-400 mt-2 flex items-center justify-center">
                <span id="cycleInfoText">Study Session: 1/4</span>
                <button id="resetCycleCountButton" title="Reset study cycle to 1/4" class="ml-2 text-slate-500 hover:text-sky-400 focus:outline-none focus:ring-1 focus:ring-sky-500 rounded-full p-1">
                    <i class="fas fa-sync-alt fa-xs"></i>
                </button>
            </div>
            <p id="lastTimerInfo" class="text-xs text-slate-500 mt-1">Last timer: None</p>
        </div>

        <div class="flex justify-center space-x-4 mb-8">
            <button id="startPauseButton" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                <i class="fas fa-play mr-2"></i>Start
            </button>
            <button id="resetButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                <i class="fas fa-undo mr-2"></i>Reset Current
            </button>
        </div>
        
        <div class="flex justify-center space-x-2 mb-8">
            <button data-mode="study" class="manual-timer-select text-xs py-1.5 px-3 rounded-md transition-colors">Force Study</button>
            <button data-mode="shortBreak" class="manual-timer-select text-xs py-1.5 px-3 rounded-md transition-colors">Force Short Break</button>
            <button data-mode="longBreak" class="manual-timer-select text-xs py-1.5 px-3 rounded-md transition-colors">Force Long Break</button>
        </div>

        <div class="mb-6 border-b border-slate-700">
            <nav class="flex space-x-1 -mb-px">
                <button data-tab="stats" class="tab-button active text-sky-400 border-sky-400 py-3 px-4 font-medium text-center hover:text-sky-300 hover:border-sky-300 transition-colors">
                    <i class="fas fa-chart-line mr-2"></i>Statistics
                </button>
                <button data-tab="rewards" class="tab-button text-slate-400 border-transparent py-3 px-4 font-medium text-center hover:text-sky-300 hover:border-sky-300 transition-colors">
                    <i class="fas fa-gift mr-2"></i>Daily Rewards
                </button>
                <button data-tab="achievements" class="tab-button text-slate-400 border-transparent py-3 px-4 font-medium text-center hover:text-sky-300 hover:border-sky-300 transition-colors">
                    <i class="fas fa-trophy mr-2"></i>Achievements
                </button>
            </nav>
        </div>

        <div id="tabContent"> 
            <div id="statsContent" class="tab-pane active p-4 bg-slate-700 rounded-b-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-sky-300">Your Statistics</h3>
                    <p id="streakContainerHeader" class="text-base text-slate-300">Study Streak: <span id="streakCounterHeader" class="font-semibold">0</span> <span id="streakFireIconContainer"><i class="fas fa-fire"></i></span></p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-slate-600 p-4 rounded-lg shadow">
                        <h4 class="font-bold text-sky-400">Daily:</h4>
                        <p>Cycles Completed Today: <span id="dailyCycles">0</span></p>
                        <p>Pure Study Time Today: <span id="dailyStudyTime">0h 0m</span></p>
                        <p>Total Time Today: <span id="dailyTotalTime">0h 0m</span></p>
                    </div>
                    <div class="bg-slate-600 p-4 rounded-lg shadow">
                        <h4 class="font-bold text-sky-400">General:</h4>
                        <p>Total Cycles Completed: <span id="totalCycles">0</span></p>
                        <p>Total Pure Study Time: <span id="totalStudyTime">0h 0m</span></p>
                        <p>Total Days Studied: <span id="totalDaysStudied">0</span></p>
                        </div>
                </div>
            </div>

            <div id="rewardsContent" class="tab-pane hidden p-4 bg-slate-700 rounded-b-lg">
                <h3 class="text-xl font-semibold mb-4 text-sky-300">Manage Daily Rewards</h3>
                <div class="mb-4 p-3 bg-slate-600 rounded-lg md:flex md:items-center md:space-x-2 md:flex-wrap">
                    <input type="text" id="rewardName" placeholder="Reward name" class="w-full md:flex-1 p-2 rounded bg-slate-500 text-white placeholder-slate-300 mb-2 md:mb-0">
                    <select id="rewardType" class="w-full md:w-auto p-2 rounded bg-slate-500 text-white mb-2 md:mb-0">
                        <option value="cycles">Completed Cycles</option>
                        <option value="studyHours">Study Hours</option>
                    </select>
                    <input type="number" id="rewardThreshold" placeholder="Value" step="0.5" min="0" class="w-full md:w-28 p-2 rounded bg-slate-500 text-white placeholder-slate-300 mb-2 md:mb-0">
                    <button id="addRewardButton" class="w-full md:w-auto mt-2 md:mt-0 bg-green-500 hover:bg-green-600 text-white font-bold py-1.5 px-3 rounded transition-colors">Add Reward</button>
                </div>
                <div id="rewardsList" class="space-y-2 max-h-[176px] overflow-y-auto pr-2"> 
                    </div>
            </div>

            <div id="achievementsContent" class="tab-pane hidden p-4 bg-slate-700 rounded-b-lg">
                <h3 class="text-xl font-semibold mb-4 text-sky-300">Your Achievements</h3>
                <div id="achievementsList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 max-h-64 overflow-y-auto pr-2"> 
                    </div>
            </div>
        </div>

        <div class="mt-4 text-center">
            <p class="text-xs text-slate-500">
                <i class="fas fa-info-circle mr-1"></i>Your progress is saved in your browser's local storage. Clearing browser data may delete your progress.
            </p>
        </div>

    </div>

    <div id="settingsModal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-50">
        <div class="bg-slate-800 p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-sky-400">Timer Settings</h2>
            <div class="space-y-4">
                <div>
                    <label for="studyTimeInput" class="block text-sm font-medium text-slate-300">Study Time (minutes):</label>
                    <input type="number" id="studyTimeInput" min="1" class="mt-1 block w-full p-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500">
                </div>
                <div>
                    <label for="shortBreakTimeInput" class="block text-sm font-medium text-slate-300">Short Break (minutes):</label>
                    <input type="number" id="shortBreakTimeInput" min="1" class="mt-1 block w-full p-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500">
                </div>
                <div>
                    <label for="longBreakTimeInput" class="block text-sm font-medium text-slate-300">Long Break (minutes):</label>
                    <input type="number" id="longBreakTimeInput" min="1" class="mt-1 block w-full p-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500">
                </div>
                 <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-slate-300">Enable Sounds:</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="soundToggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-slate-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-sky-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-sky-500"></div>
                    </label>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-slate-300">Enable Notifications:</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="notificationsToggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-slate-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-sky-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-sky-500"></div>
                    </label>
                </div>
            </div>
            <div class="mt-8 flex justify-end space-x-3">
                <button id="cancelSettingsButton" class="px-4 py-2 text-sm font-medium text-slate-300 bg-slate-600 hover:bg-slate-500 rounded-md transition-colors">Cancel</button>
                <button id="saveSettingsButton" class="px-4 py-2 text-sm font-medium text-white bg-sky-500 hover:bg-sky-600 rounded-md transition-colors">Save Settings</button>
            </div>
        </div>
    </div>

    <div id="customAlertModal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-[100]">
        <div class="bg-slate-800 p-6 rounded-lg shadow-xl w-full max-w-md text-left"> 
            <div class="flex items-start">
                <div id="customAlertIcon" class="text-3xl mr-4 mt-1"></div> 
                <div>
                    <h3 id="customAlertTitle" class="text-xl font-bold mb-2"></h3>
                    <div id="customAlertMessage" class="text-slate-300 mb-6 help-content text-sm"></div>
                </div>
            </div>
            <div id="customAlertButtons" class="flex justify-end space-x-3"> 
                <button id="customAlertCancelButton" class="px-4 py-2 text-sm font-medium text-slate-300 bg-slate-600 hover:bg-slate-500 rounded-md transition-colors">Cancel</button>
                <button id="customAlertConfirmButton" class="px-4 py-2 text-sm font-medium text-white bg-sky-500 hover:bg-sky-600 rounded-md transition-colors">OK</button>
            </div>
        </div>
    </div>


    <script>
        // --- DOM Elements ---
        const timerTextEl = document.getElementById('timerText');
        const currentModeDisplayEl = document.getElementById('currentModeDisplay');
        const cycleInfoTextEl = document.getElementById('cycleInfoText');
        const resetCycleCountButtonEl = document.getElementById('resetCycleCountButton');

        const lastTimerInfoEl = document.getElementById('lastTimerInfo');
        const startPauseButton = document.getElementById('startPauseButton');
        const resetButton = document.getElementById('resetButton');
        const manualTimerSelectButtons = document.querySelectorAll('.manual-timer-select');
        
        const settingsButton = document.getElementById('settingsButton');
        const helpButton = document.getElementById('helpButton'); 
        const settingsModal = document.getElementById('settingsModal');
        const saveSettingsButton = document.getElementById('saveSettingsButton');
        const cancelSettingsButton = document.getElementById('cancelSettingsButton');
        const studyTimeInput = document.getElementById('studyTimeInput');
        const shortBreakTimeInput = document.getElementById('shortBreakTimeInput');
        const longBreakTimeInput = document.getElementById('longBreakTimeInput');
        const soundToggle = document.getElementById('soundToggle');
        const notificationsToggle = document.getElementById('notificationsToggle');

        const tabButtons = document.querySelectorAll('.tab-button');
        const tabPanes = document.querySelectorAll('.tab-pane');

        const dailyCyclesEl = document.getElementById('dailyCycles'); 
        const dailyStudyTimeEl = document.getElementById('dailyStudyTime');
        const dailyTotalTimeEl = document.getElementById('dailyTotalTime');

        const totalDaysStudiedEl = document.getElementById('totalDaysStudied');
        const totalCyclesEl = document.getElementById('totalCycles');
        const totalStudyTimeEl = document.getElementById('totalStudyTime');
        const streakCounterHeaderEl = document.getElementById('streakCounterHeader'); 
        const streakFireIconContainerEl = document.getElementById('streakFireIconContainer');


        const rewardNameInput = document.getElementById('rewardName');
        const rewardTypeSelect = document.getElementById('rewardType');
        const rewardThresholdInput = document.getElementById('rewardThreshold');
        const addRewardButton = document.getElementById('addRewardButton');
        const rewardsListEl = document.getElementById('rewardsList');
        const achievementsListEl = document.getElementById('achievementsList');

        const customAlertModal = document.getElementById('customAlertModal');
        const customAlertIconEl = document.getElementById('customAlertIcon');
        const customAlertTitleEl = document.getElementById('customAlertTitle');
        const customAlertMessageEl = document.getElementById('customAlertMessage');
        const customAlertConfirmButton = document.getElementById('customAlertConfirmButton');
        const customAlertCancelButton = document.getElementById('customAlertCancelButton');
        const customAlertButtonsContainer = document.getElementById('customAlertButtons');
        
        const faviconEl = document.getElementById('favicon'); 

        // --- State Variables ---
        let timerInterval;
        let timeLeft; 
        let currentMode = 'study'; 
        let isRunning = false;
        let pomodorosInCycle = 0; 
        const POMODOROS_PER_CYCLE = 4;

        let appData = {
            settings: {
                studyTime: 25,
                shortBreakTime: 5,
                longBreakTime: 15,
                soundEnabled: true,
                notificationsEnabled: true,
            },
            timerState: {
                lastTimerUsed: null, 
                persistedCurrentMode: 'study',
                persistedTimeLeft: null, 
                persistedIsRunning: false,
                persistedPomodorosInCycle: 0,
                persistedPreviousPomodorosInCycle: null, 
                forcedBreakContextSession: null 
            },
            stats: {
                daily: { date: getTodayDateString(), cyclesCompleted: 0, pureStudySeconds: 0, totalTimeTodaySeconds: 0, firstStudySessionCompletedToday: false },
                general: { 
                    totalDaysStudied: 0, 
                    totalCyclesCompleted: 0, 
                    totalPureStudySeconds: 0, 
                    streak: 0, 
                    lastStudyDate: null,
                    totalShortBreakSeconds: 0,
                    totalLongBreakSeconds: 0
                },
            },
            rewards: [], 
            achievements: [], 
            appVersion: "1.0.49" 
        };
        
        const defaultAchievements = [
            // Total Days Studied
            { id: "days1", name: "Focused Beginner", description: "Complete your first day of study.", type: "totalDaysStudied", threshold: 1, icon: "fas fa-seedling" },
            { id: "days7", name: "Weekly Commitment", description: "Study for 7 days.", type: "totalDaysStudied", threshold: 7, icon: "fas fa-calendar-check" },
            { id: "days15", name: "Fortnightly Persistence", description: "Study for 15 days.", type: "totalDaysStudied", threshold: 15, icon: "fas fa-medal" },
            { id: "days30", name: "Monthly Habit", description: "Study for 30 days.", type: "totalDaysStudied", threshold: 30, icon: "fas fa-award" },
            { id: "days50", name: "Consistent Student", description: "Study for 50 days.", type: "totalDaysStudied", threshold: 50, icon: "fas fa-star" },
            { id: "days75", name: "Study Marathoner", description: "Study for 75 days.", type: "totalDaysStudied", threshold: 75, icon: "fas fa-running" },
            { id: "days100", name: "Habit Master", description: "Study for 100 days.", type: "totalDaysStudied", threshold: 100, icon: "fas fa-crown" },
            { id: "days120", name: "Academic Legend", description: "Study for 120 days.", type: "totalDaysStudied", threshold: 120, icon: "fas fa-book-reader" },
            { id: "days150", name: "Study Sage", description: "Study for 150 days.", type: "totalDaysStudied", threshold: 150, icon: "fas fa-graduation-cap" },
            // Streak Achievements
            { id: "streak3", name: "3-Day Combo!", description: "Maintain a 3-day study streak.", type: "streak", threshold: 3, icon: "fas fa-fire" },
            { id: "streak7", name: "7-Day Combo: Unstoppable!", description: "Maintain a 7-day study streak.", type: "streak", threshold: 7, icon: "fas fa-bolt" },
            { id: "streak14", name: "14-Day Combo: Power of Habit!", description: "Maintain a 14-day study streak.", type: "streak", threshold: 14, icon: "fas fa-dumbbell" },
            { id: "streak30", name: "30-Day Combo: Master of Consistency!", description: "Maintain a 30-day study streak.", type: "streak", threshold: 30, icon: "fas fa-calendar-alt" },
            { id: "streak50", name: "50-Day Streak: True Dedication!", description: "Maintain a 50-day study streak.", type: "streak", threshold: 50, icon: "fas fa-shield-alt" },
            // Total Cycles Completed
            { id: "cycles1", name: "First Full Cycle", description: "Complete 1 Pomodoro cycle.", type: "totalCyclesCompleted", threshold: 1, icon: "fas fa-flag-checkered" },
            { id: "cycles10", name: "Ten Cycles of Focus", description: "Complete 10 Pomodoro cycles.", type: "totalCyclesCompleted", threshold: 10, icon: "fas fa-spinner fa-spin" },
            { id: "cycles25", name: "Twenty-Five Cycles", description: "Complete 25 Pomodoro cycles.", type: "totalCyclesCompleted", threshold: 25, icon: "fas fa-cogs" },
            { id: "cycles50", name: "Fifty Cycles of Productivity", description: "Complete 50 Pomodoro cycles.", type: "totalCyclesCompleted", threshold: 50, icon: "fas fa-rocket" },
            { id: "cycles100", name: "One Hundred Cycles Mastered", description: "Complete 100 Pomodoro cycles.", type: "totalCyclesCompleted", threshold: 100, icon: "fas fa-gem" },
            // Total Pure Study Hours
            { id: "hours1", name: "First Hour of Focus", description: "Accumulate 1 hour of pure study.", type: "totalPureStudyHours", threshold: 1, icon: "fas fa-hourglass-start" },
            { id: "hours10", name: "Ten Hours of Immersion", description: "Accumulate 10 hours of pure study.", type: "totalPureStudyHours", threshold: 10, icon: "fas fa-brain" },
            { id: "hours50", name: "Fifty Hours of Dedication", description: "Accumulate 50 hours of pure study.", type: "totalPureStudyHours", threshold: 50, icon: "fas fa-microscope" },
            { id: "hours100", name: "One Hundred Hours of Knowledge", description: "Accumulate 100 hours of pure study.", type: "totalPureStudyHours", threshold: 100, icon: "fas fa-university" },
            // Total Short Break Time
            { id: "sb_minutes_30", name: "Quick Breather", description: "Accumulate 30 minutes in short breaks.", type: "totalShortBreakSeconds", threshold: 30 * 60, icon: "fas fa-coffee" },
            { id: "sb_hours_1", name: "Relaxation Adept", description: "Accumulate 1 hour in short breaks.", type: "totalShortBreakSeconds", threshold: 1 * 3600, icon: "fas fa-mug-hot" },
            { id: "sb_hours_5", name: "Short Break Champion", description: "Accumulate 5 hours in short breaks.", type: "totalShortBreakSeconds", threshold: 5 * 3600, icon: "fas fa-couch" },
            // Total Long Break Time
            { id: "lb_hours_1", name: "Well Deserved Rest", description: "Accumulate 1 hour in long breaks.", type: "totalLongBreakSeconds", threshold: 1 * 3600, icon: "fas fa-bed" },
            { id: "lb_hours_3", name: "Recharge Master", description: "Accumulate 3 hours in long breaks.", type: "totalLongBreakSeconds", threshold: 3 * 3600, icon: "fas fa-battery-full" },
            { id: "lb_hours_10", name: "Leisure Expert", description: "Accumulate 10 hours in long breaks.", type: "totalLongBreakSeconds", threshold: 10 * 3600, icon: "fas fa-umbrella-beach" }
        ];


        // --- Sound Synthesis (Tone.js) ---
        let synth;
        if (typeof Tone !== 'undefined') {
            synth = new Tone.Synth().toDestination();
        } else {
            console.warn("Tone.js not loaded. Sound effects will be disabled.");
        }

        function playSound(note = 'C4', duration = '8n', type = 'timerComplete') {
            if (!appData.settings.soundEnabled || !synth) return;
            
            if (Tone.context.state !== 'running') {
                Tone.context.resume().catch(e => console.error("Error resuming AudioContext:", e));
            }

            if (Tone.Transport.state !== "started") {
                Tone.Transport.start();
            }

            try {
                let soundNote = note;
                let soundDuration = duration;
                let soundVolume = 0; 

                if (type === 'achievement') {
                    soundNote = "C5";
                    soundDuration = "4n";
                    soundVolume = -6; 
                } else if (type === 'reward') {
                    soundNote = "E5";
                    soundDuration = "4n";
                    soundVolume = -6; 
                }
                
                const timeToPlay = Tone.now() + 0.1; 
                
                synth.volume.setValueAtTime(soundVolume, timeToPlay);
                synth.triggerAttackRelease(soundNote, soundDuration, timeToPlay);

            } catch (error) {
                console.error(`Error playing sound (type: ${type}):`, error);
            }
        }
        
        // --- Utility Functions ---
        function getTodayDateString() {
            const today = new Date();
            return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function formatHoursMinutes(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            return `${hours}h ${minutes}m`;
        }
        
        function generateUUID() { 
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // --- Data Persistence (localStorage) ---
        const STORAGE_KEY = 'pomodoroGamifiedAppData';

        function saveTimerState() {
            appData.timerState.persistedCurrentMode = currentMode;
            appData.timerState.persistedTimeLeft = timeLeft;
            appData.timerState.persistedIsRunning = isRunning;
            appData.timerState.persistedPomodorosInCycle = pomodorosInCycle;
            saveData();
        }


        function loadData() {
            const storedData = localStorage.getItem(STORAGE_KEY);
            const defaultTimerState = { 
                lastTimerUsed: null, 
                persistedCurrentMode: 'study',
                persistedTimeLeft: appData.settings.studyTime * 60,
                persistedIsRunning: false,
                persistedPomodorosInCycle: 0,
                persistedPreviousPomodorosInCycle: null,
                forcedBreakContextSession: null
            };

            if (storedData) {
                const parsedData = JSON.parse(storedData);
                if (parsedData.appVersion !== appData.appVersion) {
                     console.log(`Data version mismatch. Current: ${appData.appVersion}, Stored: ${parsedData.appVersion}. Merging data.`);
                     if (!parsedData.stats?.general?.totalShortBreakSeconds) {
                        if (!parsedData.stats) parsedData.stats = {};
                        if (!parsedData.stats.general) parsedData.stats.general = {};
                        parsedData.stats.general.totalShortBreakSeconds = 0;
                     }
                     if (!parsedData.stats?.general?.totalLongBreakSeconds) {
                        if (!parsedData.stats) parsedData.stats = {};
                        if (!parsedData.stats.general) parsedData.stats.general = {};
                        parsedData.stats.general.totalLongBreakSeconds = 0;
                     }
                     if (!parsedData.stats?.daily?.totalTimeTodaySeconds) {
                        if (!parsedData.stats) parsedData.stats = {};
                        if (!parsedData.stats.daily) parsedData.stats.daily = {};
                        parsedData.stats.daily.totalTimeTodaySeconds = 0;
                     }
                }
                const mergedAchievements = defaultAchievements.map(defaultAch => {
                    const userAch = parsedData.achievements?.find(ua => ua.id === defaultAch.id);
                    return { 
                        ...defaultAch,
                        unlocked: userAch?.unlocked || false, 
                        unlockedDate: userAch?.unlockedDate || null,
                        notificationShown: userAch?.notificationShown || false
                    };
                });
                const userRewards = parsedData.rewards || [];
                
                const loadedTimerState = { ...defaultTimerState, ...(parsedData.timerState || {}) };
                
                const loadedPomodorosInCycle = loadedTimerState.persistedPomodorosInCycle !== undefined ? 
                                                parseInt(loadedTimerState.persistedPomodorosInCycle, 10) : 0;

                appData = { 
                    ...appData, 
                    ...parsedData, 
                    achievements: mergedAchievements, 
                    rewards: userRewards,
                    timerState: loadedTimerState 
                };
                pomodorosInCycle = isNaN(loadedPomodorosInCycle) ? 0 : loadedPomodorosInCycle;
                
                if (appData.stats.general.totalShortBreakSeconds === undefined) {
                    appData.stats.general.totalShortBreakSeconds = 0;
                }
                if (appData.stats.general.totalLongBreakSeconds === undefined) {
                    appData.stats.general.totalLongBreakSeconds = 0;
                }
                if (appData.stats.daily.totalTimeTodaySeconds === undefined) {
                    appData.stats.daily.totalTimeTodaySeconds = 0;
                }

                if (appData.stats.daily.date !== getTodayDateString()) {
                    resetDailyStats(); 
                }
            } else {
                appData.achievements = defaultAchievements.map(ach => ({ ...ach, unlocked: false, unlockedDate: null, notificationShown: false }));
                pomodorosInCycle = 0; 
                appData.stats.general.totalShortBreakSeconds = 0; 
                appData.stats.general.totalLongBreakSeconds = 0;
                appData.stats.daily.totalTimeTodaySeconds = 0;
                appData.timerState = { ...defaultTimerState }; 
                appData.timerState.persistedTimeLeft = appData.settings.studyTime * 60; 
            }
            studyTimeInput.value = appData.settings.studyTime;
            shortBreakTimeInput.value = appData.settings.shortBreakTime;
            longBreakTimeInput.value = appData.settings.longBreakTime;
            soundToggle.checked = appData.settings.soundEnabled;
            notificationsToggle.checked = appData.settings.notificationsEnabled;
        }

        function saveData() {
            appData.pomodorosInCycle = pomodorosInCycle; 
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
        }

        // --- Notifications ---
        function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.warn("Desktop notifications not supported.");
                appData.settings.notificationsEnabled = false;
                notificationsToggle.checked = false;
                notificationsToggle.disabled = true;
                return;
            }
            if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        appData.settings.notificationsEnabled = true;
                    } else {
                        appData.settings.notificationsEnabled = false;
                        notificationsToggle.checked = false;
                         console.warn("Desktop notifications permission denied.");
                    }
                    saveData(); 
                });
            } else if (Notification.permission === 'denied') {
                 appData.settings.notificationsEnabled = false;
                 notificationsToggle.checked = false;
                 notificationsToggle.disabled = true; 
            }
        }

        function showNotification(title, body) { 
            if (!appData.settings.notificationsEnabled || Notification.permission !== 'granted') return;
            const options = {
                body: body,
                icon: 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÖ</text></svg>'
            };
            try {
                new Notification(title, options);
            } catch (e) {
                console.error("Error showing notification:", e);
                new Notification(title, {body: body});
            }
        }
        
        let currentConfirmCallback = null;
        let currentCancelCallback = null;

        function showCustomAlert(title, message, iconClass = "fas fa-info-circle text-sky-400", confirmText = "OK", cancelText = null, confirmCallback = null, cancelCallback = null) {
            customAlertTitleEl.textContent = title;
            customAlertMessageEl.innerHTML = message; 
            customAlertIconEl.className = `text-3xl mr-4 mt-1 ${iconClass}`; 
            
            customAlertConfirmButton.textContent = confirmText;
            currentConfirmCallback = confirmCallback; 

            if (cancelText && typeof cancelCallback === 'function') {
                customAlertCancelButton.textContent = cancelText;
                customAlertCancelButton.classList.remove('hidden');
                customAlertButtonsContainer.classList.remove('justify-end'); 
                customAlertButtonsContainer.classList.add('justify-center');
                currentCancelCallback = cancelCallback;
            } else {
                customAlertCancelButton.classList.add('hidden');
                customAlertButtonsContainer.classList.remove('justify-center'); 
                customAlertButtonsContainer.classList.add('justify-end');
                currentCancelCallback = null;
            }
            
            customAlertModal.classList.add('show');
        }

        customAlertConfirmButton.addEventListener('click', () => {
            if (typeof currentConfirmCallback === 'function') {
                currentConfirmCallback();
            }
            customAlertModal.classList.remove('show');
            currentConfirmCallback = null; 
            currentCancelCallback = null;
        });

        customAlertCancelButton.addEventListener('click', () => {
            if (typeof currentCancelCallback === 'function') {
                currentCancelCallback();
            }
            customAlertModal.classList.remove('show');
            currentConfirmCallback = null;
            currentCancelCallback = null; 
        });


        // --- UI Update Functions ---
        function updateTimerDisplay() {
            timerTextEl.textContent = formatTime(timeLeft);
            
            let modeText = '';
            let bodyClass = 'bg-slate-900'; 
            switch (currentMode) {
                case 'study':
                    modeText = 'Study';
                    bodyClass = 'bg-slate-900'; 
                    timerTextEl.classList.remove('text-green-400', 'text-purple-400'); // Removed yellow
                    timerTextEl.classList.add('text-sky-500');
                    break;
                case 'shortBreak':
                    modeText = 'Short Break';
                    bodyClass = 'bg-green-800'; 
                    timerTextEl.classList.remove('text-sky-500', 'text-purple-400'); // Removed yellow
                    timerTextEl.classList.add('text-green-400');
                    break;
                case 'longBreak':
                    modeText = 'Long Break';
                    bodyClass = 'bg-purple-800'; // ### MODIFICATION: Changed to purple ###
                    timerTextEl.classList.remove('text-sky-500', 'text-green-400');
                    timerTextEl.classList.add('text-purple-400'); // ### MODIFICATION: Changed to purple ###
                    break;
            }
            currentModeDisplayEl.textContent = `Current Mode: ${modeText}`;
            document.title = `${formatTime(timeLeft)} - ${modeText}`; 
            document.body.className = document.body.className.replace(/bg-(slate|green|yellow|purple)-(900|800)/g, '') + ` ${bodyClass}`;
            
            updateCycleInfo();
        }

        function updateCycleInfo() {
            let displayedSessionNumber;

            if (appData.timerState.forcedBreakContextSession && (currentMode === 'shortBreak' || currentMode === 'longBreak')) {
                displayedSessionNumber = appData.timerState.forcedBreakContextSession;
            } else if (currentMode === 'study') {
                displayedSessionNumber = pomodorosInCycle + 1;
            } else if (currentMode === 'shortBreak') {
                displayedSessionNumber = pomodorosInCycle; 
                if (displayedSessionNumber === 0 && pomodorosInCycle === 0 ) { 
                    displayedSessionNumber = 1;
                } else if (pomodorosInCycle > 0) { 
                    displayedSessionNumber = pomodorosInCycle;
                } else { 
                    displayedSessionNumber = 1;
                }
            } else { 
                displayedSessionNumber = POMODOROS_PER_CYCLE;
            }
            
            displayedSessionNumber = Math.max(1, Math.min(displayedSessionNumber, POMODOROS_PER_CYCLE));
            cycleInfoTextEl.textContent = `Study Session: ${displayedSessionNumber}/${POMODOROS_PER_CYCLE}`;
        }
        
        function updateLastTimerInfo() {
            let lastTimerText = "None";
            if (appData.timerState.lastTimerUsed) {
                switch(appData.timerState.lastTimerUsed) {
                    case 'study': lastTimerText = "Study"; break;
                    case 'shortBreak': lastTimerText = "Short Break"; break;
                    case 'longBreak': lastTimerText = "Long Break"; break;
                }
            }
            lastTimerInfoEl.textContent = `Last timer: ${lastTimerText}`;
        }

        function updateStatsDisplay() {
            dailyCyclesEl.textContent = appData.stats.daily.cyclesCompleted; 
            dailyStudyTimeEl.textContent = formatHoursMinutes(appData.stats.daily.pureStudySeconds);
            if (dailyTotalTimeEl) dailyTotalTimeEl.textContent = formatHoursMinutes(appData.stats.daily.totalTimeTodaySeconds);
            
            totalDaysStudiedEl.textContent = appData.stats.general.totalDaysStudied;
            totalCyclesEl.textContent = appData.stats.general.totalCyclesCompleted;
            totalStudyTimeEl.textContent = formatHoursMinutes(appData.stats.general.totalPureStudySeconds);
            
            if(streakCounterHeaderEl) streakCounterHeaderEl.textContent = appData.stats.general.streak;
            if(streakFireIconContainerEl) {
                const streak = appData.stats.general.streak;
                let fireColorClass = 'text-slate-400'; 
                if (streak >= 50) fireColorClass = 'text-yellow-400';
                else if (streak >= 40) fireColorClass = 'text-teal-400'; 
                else if (streak >= 35) fireColorClass = 'text-sky-400';
                else if (streak >= 30) fireColorClass = 'text-blue-500';
                else if (streak >= 25) fireColorClass = 'text-indigo-500';
                else if (streak >= 20) fireColorClass = 'text-purple-500';
                else if (streak >= 15) fireColorClass = 'text-red-600';
                else if (streak >= 10) fireColorClass = 'text-red-500';
                else if (streak >= 5) fireColorClass = 'text-red-400';
                else if (streak >= 1) fireColorClass = 'text-orange-400';
                
                streakFireIconContainerEl.className = ''; 
                streakFireIconContainerEl.classList.add(fireColorClass); 
                streakFireIconContainerEl.innerHTML = '<i class="fas fa-fire"></i>'; 
            }
        }
        
        function renderRewards() {
            rewardsListEl.innerHTML = '';
            if (appData.rewards.length === 0) {
                rewardsListEl.innerHTML = '<p class="text-slate-400 italic">No rewards configured.</p>';
                return;
            }
            appData.rewards.forEach(reward => {
                const rewardEl = document.createElement('div');
                rewardEl.className = `p-3 rounded-lg flex justify-between items-center transition-all ${reward.earnedToday ? 'bg-green-600 shadow-lg' : 'bg-slate-500'}`;
                let progressText = '';
                let progressPercent = 0;
                const rewardTypeDisplay = reward.type === 'cycles' ? 'Cycles' : 'Hours';
                const rewardUnitDisplay = reward.type === 'cycles' ? 'cycles' : 'hours';
                if (reward.type === 'cycles') {
                    progressText = `${appData.stats.daily.cyclesCompleted}/${reward.threshold} cycles`;
                    progressPercent = Math.min(100, (appData.stats.daily.cyclesCompleted / reward.threshold) * 100);
                } else { 
                    const currentHours = appData.stats.daily.pureStudySeconds / 3600;
                    progressText = `${currentHours.toFixed(1)}/${reward.threshold} hours`;
                    progressPercent = Math.min(100, (currentHours / reward.threshold) * 100);
                }
                rewardEl.innerHTML = `
                    <div>
                        <p class="font-semibold ${reward.earnedToday ? 'text-white' : 'text-sky-300'}">${reward.name} (${rewardTypeDisplay})</p>
                        <p class="text-xs ${reward.earnedToday ? 'text-green-200' : 'text-slate-300'}">Goal: ${reward.threshold} ${rewardUnitDisplay} | Progress: ${progressText}</p>
                        ${!reward.earnedToday ? `
                            <div class="progress-bar-container mt-1">
                                <div class="progress-bar" style="width: ${progressPercent}%;"></div>
                            </div>
                        ` : '<p class="text-xs text-green-100 font-bold"><i class="fas fa-check-circle mr-1"></i>Reward Earned Today!</p>'}
                    </div>
                    <button data-id="${reward.id}" class="delete-reward-button text-red-300 hover:text-red-500 p-2 rounded-full transition-colors">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                rewardsListEl.appendChild(rewardEl);
            });
            document.querySelectorAll('.delete-reward-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const rewardId = e.currentTarget.dataset.id;
                    appData.rewards = appData.rewards.filter(r => r.id !== rewardId);
                    saveData();
                    renderRewards();
                });
            });
        }

        function renderAchievements() {
            achievementsListEl.innerHTML = '';
            appData.achievements.sort((a,b) => { 
                if (a.unlocked && !b.unlocked) return -1;
                if (!a.unlocked && b.unlocked) return 1;
                return a.threshold - b.threshold;
            });
            appData.achievements.forEach(ach => {
                const achEl = document.createElement('div');
                achEl.className = `achievement-item p-3 rounded-lg shadow-md transition-all transform hover:scale-105 ${ach.unlocked ? 'unlocked bg-sky-600' : 'locked bg-slate-600'}`;
                let mainContentHTML = `
                    <div class="flex items-center mb-1">
                        <i class="${ach.icon || 'fas fa-question-circle'} text-xl ${ach.unlocked ? 'text-yellow-300' : 'text-slate-400'} mr-2"></i>
                        <div>
                            <h4 class="font-semibold text-xs ${ach.unlocked ? 'text-white' : 'text-sky-300'}">${ach.name}</h4>
                            <p class="text-xs ${ach.unlocked ? 'text-sky-100' : 'text-slate-300'} leading-tight">${ach.description}</p>
                        </div>
                    </div>`;

                let progressSectionHTML = '<div class="mt-auto">'; 

                if (ach.unlocked) {
                    progressSectionHTML += `
                        <div class="progress-bar-container">
                            <div class="progress-bar bg-green-500" style="width: 100%;"></div>
                        </div>
                        <p class="text-xs text-yellow-200 font-semibold mt-1"><i class="fas fa-check-circle mr-1"></i>Unlocked on: ${new Date(ach.unlockedDate).toLocaleDateString()}</p>`;
                } else {
                    let currentValue = 0;
                    switch (ach.type) {
                        case 'totalDaysStudied': currentValue = appData.stats.general.totalDaysStudied; break;
                        case 'totalCyclesCompleted': currentValue = appData.stats.general.totalCyclesCompleted; break;
                        case 'totalPureStudyHours': currentValue = appData.stats.general.totalPureStudySeconds / 3600; break;
                        case 'streak': currentValue = appData.stats.general.streak; break;
                        case 'totalShortBreakSeconds': currentValue = appData.stats.general.totalShortBreakSeconds; break;
                        case 'totalLongBreakSeconds': currentValue = appData.stats.general.totalLongBreakSeconds; break;
                    }
                    let displayThreshold = ach.threshold;
                    let displayCurrentValue = currentValue;
                    if (ach.type === 'totalShortBreakSeconds' || ach.type === 'totalLongBreakSeconds') {
                        if (ach.threshold >= 3600) { 
                           displayCurrentValue = (currentValue / 3600).toFixed(1);
                           displayThreshold = (ach.threshold / 3600).toFixed(1) + "h";
                        } else { 
                           displayCurrentValue = (currentValue / 60).toFixed(0);
                           displayThreshold = (ach.threshold / 60).toFixed(0) + "m";
                        }
                    } else if (ach.type === 'totalPureStudyHours') {
                         displayCurrentValue = currentValue.toFixed(1); 
                         displayThreshold = ach.threshold + "h";
                    } else {
                        displayCurrentValue = currentValue.toFixed(0);
                        displayThreshold = ach.threshold;
                    }

                    const progressPercent = Math.min(100, (currentValue / ach.threshold) * 100);
                    progressSectionHTML += `
                        <div class="progress-bar-container">
                            <div class="progress-bar bg-sky-400" style="width: ${progressPercent.toFixed(2)}%;"></div>
                        </div>
                        <p class="text-xs text-slate-400 mt-1">Progress: ${displayCurrentValue} / ${displayThreshold}</p>`;
                }
                progressSectionHTML += '</div>'; 
                achEl.innerHTML = mainContentHTML + progressSectionHTML; 
                achievementsListEl.appendChild(achEl);
            });
        }

        // --- Timer Logic ---
        function setTimer(mode) {
            if (mode === 'study' && currentMode !== 'study') { 
                if (!(currentMode === 'shortBreak' && appData.timerState.lastTimerUsed === 'shortBreak')) {
                    appData.timerState.forcedBreakContextSession = null;
                }
            } else if (mode !== 'shortBreak' && mode !== 'longBreak') {
                 appData.timerState.forcedBreakContextSession = null;
            }
            
            currentMode = mode;
            isRunning = false;
            startPauseButton.innerHTML = '<i class="fas fa-play mr-2"></i>Start';
            clearInterval(timerInterval);
            switch (mode) {
                case 'study':
                    timeLeft = appData.settings.studyTime * 60;
                    break;
                case 'shortBreak':
                    timeLeft = appData.settings.shortBreakTime * 60;
                    break;
                case 'longBreak':
                    timeLeft = appData.settings.longBreakTime * 60;
                    break;
            }
            updateTimerDisplay();
            saveTimerState(); 
        }

        function startTimer() {
            if (timeLeft <= 0 && currentMode !== 'study' && currentMode !== 'shortBreak' && currentMode !== 'longBreak') { 
                 setTimer('study'); 
            }
            if (timeLeft <= 0) return;
            isRunning = true;
            startPauseButton.innerHTML = '<i class="fas fa-pause mr-2"></i>Pause';
            clearInterval(timerInterval); 
            appData.timerState.forcedBreakContextSession = null; 
            timerInterval = setInterval(() => {
                timeLeft--;
                if (currentMode === 'study') {
                    appData.stats.daily.pureStudySeconds++;
                    appData.stats.general.totalPureStudySeconds++;
                }
                if (timeLeft < 0) {
                    handleTimerEnd();
                } else {
                    updateTimerDisplay();
                }
            }, 1000);
            saveTimerState(); 
        }

        function pauseTimer() {
            isRunning = false;
            startPauseButton.innerHTML = '<i class="fas fa-play mr-2"></i>Resume';
            clearInterval(timerInterval);
            saveTimerState(); 
        }
        
        function handleTimerEnd() {
            clearInterval(timerInterval);
            isRunning = false; 
            appData.timerState.lastTimerUsed = currentMode; 
            updateLastTimerInfo();
            let notificationTitle = "";
            let notificationBody = "";
            let soundNote = 'C4';
            let autoStartNext = true; 
            let showCycleCompleteAlert = false;
            let completedTime = 0; 

            appData.timerState.forcedBreakContextSession = null;

            if (currentMode === 'study') {
                completedTime = appData.settings.studyTime * 60;
                notificationTitle = "Study Session Complete!";
                notificationBody = "Time for a break. Good job!";
                soundNote = 'C5';
                pomodorosInCycle++; 
                if (!appData.stats.daily.firstStudySessionCompletedToday) {
                    appData.stats.daily.firstStudySessionCompletedToday = true;
                    const todayStr = getTodayDateString();
                    if (appData.stats.general.lastStudyDate !== todayStr) { 
                        appData.stats.general.totalDaysStudied++;
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        const yesterdayStr = `${yesterday.getFullYear()}-${String(yesterday.getMonth() + 1).padStart(2, '0')}-${String(yesterday.getDate()).padStart(2, '0')}`;
                        if (appData.stats.general.lastStudyDate === yesterdayStr) {
                            appData.stats.general.streak++;
                        } else if (appData.stats.general.lastStudyDate !== null) { 
                            appData.stats.general.streak = 1; 
                        } else { 
                             appData.stats.general.streak = 1;
                        }
                        appData.stats.general.lastStudyDate = todayStr;
                    }
                }
                if (pomodorosInCycle >= POMODOROS_PER_CYCLE) { 
                    setTimer('longBreak');
                    appData.stats.daily.cyclesCompleted++;
                    appData.stats.general.totalCyclesCompleted++;
                    showCycleCompleteAlert = true; 
                    // ### MODIFICATION: Long break should also auto-start ###
                    // autoStartNext = false; // Kept as true now
                } else {
                    setTimer('shortBreak');
                }
            } else if (currentMode === 'shortBreak') {
                completedTime = appData.settings.shortBreakTime * 60;
                appData.stats.general.totalShortBreakSeconds += completedTime; 
                notificationTitle = "Break Over!";
                notificationBody = "Time to get back to focus!";
                soundNote = 'E4';
                setTimer('study');
            } else if (currentMode === 'longBreak') { 
                completedTime = appData.settings.longBreakTime * 60;
                appData.stats.general.totalLongBreakSeconds += completedTime; 
                notificationTitle = "Long Break Over!";
                notificationBody = "Cycle complete! Ready for a new one?";
                soundNote = 'E4';
                pomodorosInCycle = 0; 
                setTimer('study');
                autoStartNext = false; 
            }
            
            if (completedTime > 0) {
                appData.stats.daily.totalTimeTodaySeconds += completedTime;
            }

            updateTimerDisplay(); 
            updateStatsDisplay(); 

            playSound(soundNote, '4n', 'timerComplete');
            showNotification(notificationTitle, notificationBody);

            const handlePostAlertActions = () => {
                checkRewards(); 
                checkAchievements(); 
                
                if (autoStartNext) { 
                     startTimer();
                } else {
                    startPauseButton.innerHTML = '<i class="fas fa-play mr-2"></i>Start';
                    saveTimerState();
                }
                saveData();
            };

            if (showCycleCompleteAlert) {
                showCustomAlert(
                    "Cycle Complete!", 
                    "Congratulations! You've completed a full Pomodoro cycle (4 study sessions). Enjoy your long break!",
                    "fas fa-award text-yellow-400", 
                    "Great!",
                    null,
                    handlePostAlertActions
                );
            } else {
                handlePostAlertActions();
            }
            saveData(); 
        }

        function resetCurrentTimer() {
            pauseTimer(); 
            setTimer(currentMode); 
        }

        // --- Stats Logic ---
        function resetDailyStats() {
            appData.stats.daily = {
                date: getTodayDateString(),
                cyclesCompleted: 0,
                pureStudySeconds: 0,
                totalTimeTodaySeconds: 0, 
                firstStudySessionCompletedToday: false
            };
            appData.rewards.forEach(reward => {
                reward.earnedToday = false;
                reward.notificationShown = false;
            });
            pomodorosInCycle = 0; 
            appData.timerState.forcedBreakContextSession = null; 
        }

        // --- Rewards Logic ---
        addRewardButton.addEventListener('click', () => {
            const name = rewardNameInput.value.trim();
            const type = rewardTypeSelect.value;
            const threshold = parseFloat(rewardThresholdInput.value);
            if (!name || isNaN(threshold) || threshold <= 0) {
                showCustomAlert("Error", "Please fill in all reward fields correctly.", "fas fa-exclamation-circle text-red-400", "OK");
                return;
            }
            appData.rewards.push({
                id: generateUUID(),
                name,
                type,
                threshold,
                earnedToday: false,
                notificationShown: false
            });
            rewardNameInput.value = '';
            rewardThresholdInput.value = '';
            saveData();
            renderRewards();
        });

        function checkRewards() {
            let newRewardEarned = false;
            appData.rewards.forEach(reward => {
                if (reward.earnedToday && reward.notificationShown) return; 
                let currentProgress = 0;
                if (reward.type === 'cycles') {
                    currentProgress = appData.stats.daily.cyclesCompleted;
                } else { 
                    currentProgress = appData.stats.daily.pureStudySeconds / 3600;
                }
                if (currentProgress >= reward.threshold && !reward.earnedToday) {
                    reward.earnedToday = true;
                    newRewardEarned = true;
                    if (!reward.notificationShown) {
                        const message = `You earned the reward: "${reward.name}"!`;
                        showNotification("Reward Earned!", message);
                        showCustomAlert("Reward Earned!", message, "fas fa-gift text-yellow-400", "Awesome!"); 
                        playSound('G5', '2n', 'reward');
                        reward.notificationShown = true;
                    }
                }
            });
            if (newRewardEarned) {
                renderRewards(); 
                saveData();
            }
        }

        // --- Achievements Logic ---
        function checkAchievements() {
            let newAchievementUnlocked = false;
            appData.achievements.forEach(ach => {
                if (ach.unlocked && ach.notificationShown) return; 
                let currentValue;
                switch (ach.type) {
                    case 'totalDaysStudied': currentValue = appData.stats.general.totalDaysStudied; break;
                    case 'totalCyclesCompleted': currentValue = appData.stats.general.totalCyclesCompleted; break;
                    case 'totalPureStudyHours': currentValue = appData.stats.general.totalPureStudySeconds / 3600; break;
                    case 'streak': currentValue = appData.stats.general.streak; break;
                    case 'totalShortBreakSeconds': currentValue = appData.stats.general.totalShortBreakSeconds; break;
                    case 'totalLongBreakSeconds': currentValue = appData.stats.general.totalLongBreakSeconds; break;
                    default: return;
                }
                if (currentValue >= ach.threshold && !ach.unlocked) {
                    ach.unlocked = true;
                    ach.unlockedDate = new Date().toISOString();
                    newAchievementUnlocked = true;
                    if (!ach.notificationShown) {
                         const message = `You unlocked the achievement: "${ach.name}"!`;
                        showNotification("Achievement Unlocked!", message);
                        showCustomAlert("Achievement Unlocked!", message, `${ach.icon || 'fas fa-trophy'} text-yellow-400`, "Great!"); 
                        playSound('A5', '1n', 'achievement');
                        ach.notificationShown = true;
                    }
                }
            });
            if (newAchievementUnlocked) {
                renderAchievements(); 
                saveData();
            }
        }

        // --- Event Listeners ---
        startPauseButton.addEventListener('click', () => {
            if (isRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        });

        resetButton.addEventListener('click', resetCurrentTimer);

        resetCycleCountButtonEl.addEventListener('click', () => {
            showCustomAlert(
                "Confirm Reset", 
                "Are you sure you want to reset the current cycle? This will set the Study Session to 1/4 and pause the timer.", 
                "fas fa-exclamation-triangle text-yellow-400",
                "Confirm", 
                "Cancel",
                () => { 
                    if (isRunning) {
                        pauseTimer(); 
                    }
                    pomodorosInCycle = 0;
                    appData.timerState.forcedBreakContextSession = null; 
                    setTimer('study'); 
                    saveData(); 
                    console.log("Study cycle count reset to 1/4 and timer set to Study mode (paused).");
                },
                () => { 
                    console.log("Study cycle reset cancelled.");
                }
            );
        });

        helpButton.addEventListener('click', () => {
            const helpText = `
                <p class="mb-3">The <strong>Pomodoro Technique</strong> is a time management method that uses a timer to break down work into intervals, traditionally 25 minutes in length, separated by short breaks.</p>
                <p class="mb-1 font-semibold">This Timer's Cycle:</p>
                <ul>
                    <li class="study-session" style="--session-number: '1.'">Study Session (e.g., 25 min)</li>
                    <li class="break-session" style="padding-left: 35px;">Short Break (e.g., 5 min)</li>
                    <li class="study-session" style="--session-number: '2.'">Study Session</li>
                    <li class="break-session" style="padding-left: 35px;">Short Break</li>
                    <li class="study-session" style="--session-number: '3.'">Study Session</li>
                    <li class="break-session" style="padding-left: 35px;">Short Break</li>
                    <li class="study-session" style="--session-number: '4.'">Study Session (completes 1 Pomodoro cycle)</li>
                    <li class="break-session" style="padding-left: 35px;">Long Break (e.g., 15 min)</li>
                </ul>
                <p class="mb-3">Timers for study and short/long breaks will start automatically after the previous one ends.</p>
                <p class="mb-3">After a long break, the timer will set up for a new cycle but will NOT start automatically.</p>
                <p class="mb-3">Reset the current cycle using the <i class='fas fa-sync-alt fa-xs'></i> button next to the "Study Session" display.</p>
                <p class="mb-3">The study streak only counts after completing the first study session of the day.</p>
            `;
            showCustomAlert(
                "How This Pomodoro Timer Works",
                helpText,
                "fas fa-question-circle text-sky-400",
                "Got it!"
            );
        });

        manualTimerSelectButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                pauseTimer(); 
                const selectedMode = e.target.dataset.mode;
                const previousMode = currentMode; 
                const previousPomodorosInCycle = pomodorosInCycle; 

                appData.timerState.persistedPreviousPomodorosInCycle = null; 

                if (selectedMode === 'shortBreak') {
                    if (previousMode === 'study') {
                        appData.timerState.forcedBreakContextSession = pomodorosInCycle + 1;
                    } else { 
                         appData.timerState.forcedBreakContextSession = pomodorosInCycle +1 ; 
                         if (appData.timerState.forcedBreakContextSession > POMODOROS_PER_CYCLE) appData.timerState.forcedBreakContextSession = POMODOROS_PER_CYCLE;
                         if(previousMode === 'longBreak' && pomodorosInCycle >= POMODOROS_PER_CYCLE) {
                             appData.timerState.forcedBreakContextSession = 1; 
                         } else if (pomodorosInCycle === 0) {
                             appData.timerState.forcedBreakContextSession = 1;
                         }
                    }
                } else if (selectedMode === 'longBreak') {
                    if (pomodorosInCycle < POMODOROS_PER_CYCLE) { 
                         appData.timerState.persistedPreviousPomodorosInCycle = pomodorosInCycle;
                    }
                    appData.timerState.forcedBreakContextSession = POMODOROS_PER_CYCLE; 
                } else if (selectedMode === 'study') {
                    if (previousMode === 'longBreak') { 
                        if (appData.timerState.persistedPreviousPomodorosInCycle !== null) {
                             pomodorosInCycle = appData.timerState.persistedPreviousPomodorosInCycle;
                        } else { 
                            pomodorosInCycle = 0; 
                        }
                    }
                    appData.timerState.forcedBreakContextSession = null; 
                    appData.timerState.persistedPreviousPomodorosInCycle = null;
                }
                
                setTimer(selectedMode); 
                startPauseButton.innerHTML = '<i class="fas fa-play mr-2"></i>Start';
                isRunning = false; 
            });
        });

        settingsButton.addEventListener('click', () => settingsModal.classList.add('show'));
        cancelSettingsButton.addEventListener('click', () => {
            studyTimeInput.value = appData.settings.studyTime;
            shortBreakTimeInput.value = appData.settings.shortBreakTime;
            longBreakTimeInput.value = appData.settings.longBreakTime;
            soundToggle.checked = appData.settings.soundEnabled;
            notificationsToggle.checked = appData.settings.notificationsEnabled;
            settingsModal.classList.remove('show');
        });

        saveSettingsButton.addEventListener('click', () => {
            const newStudyTime = parseInt(studyTimeInput.value);
            const newShortBreakTime = parseInt(shortBreakTimeInput.value);
            const newLongBreakTime = parseInt(longBreakTimeInput.value);
            const oldStudyTime = appData.settings.studyTime; 
            const oldShortBreakTime = appData.settings.shortBreakTime;
            const oldLongBreakTime = appData.settings.longBreakTime;

            let settingsChanged = false;
            if (!isNaN(newStudyTime) && newStudyTime >=1 && appData.settings.studyTime !== newStudyTime) {
                appData.settings.studyTime = newStudyTime; settingsChanged = true;
            }
            if (!isNaN(newShortBreakTime) && newShortBreakTime >=1 && appData.settings.shortBreakTime !== newShortBreakTime) {
                appData.settings.shortBreakTime = newShortBreakTime; settingsChanged = true;
            }
            if (!isNaN(newLongBreakTime) && newLongBreakTime >=1 && appData.settings.longBreakTime !== newLongBreakTime) {
                appData.settings.longBreakTime = newLongBreakTime; settingsChanged = true;
            }
            if (appData.settings.soundEnabled !== soundToggle.checked) {
                appData.settings.soundEnabled = soundToggle.checked; settingsChanged = true;
            }
             if (appData.settings.notificationsEnabled !== notificationsToggle.checked) {
                appData.settings.notificationsEnabled = notificationsToggle.checked; settingsChanged = true;
            }
            
            settingsModal.classList.remove('show'); 
            if(settingsChanged) {
                saveData();
                 if (!isRunning) { 
                    let durationChangedForCurrentMode = false;
                    if (currentMode === 'study' && oldStudyTime !== newStudyTime) durationChangedForCurrentMode = true;
                    if (currentMode === 'shortBreak' && oldShortBreakTime !== newShortBreakTime) durationChangedForCurrentMode = true;
                    if (currentMode === 'longBreak' && oldLongBreakTime !== newLongBreakTime) durationChangedForCurrentMode = true;
                    
                    if(durationChangedForCurrentMode || timeLeft === 0 || 
                       (currentMode === 'study' && timeLeft === oldStudyTime * 60) ||
                       (currentMode === 'shortBreak' && timeLeft === oldShortBreakTime * 60) ||
                       (currentMode === 'longBreak' && timeLeft === oldLongBreakTime * 60)
                    ) {
                        setTimer(currentMode); 
                    } else {
                        saveTimerState(); 
                    }
                } else {
                    saveTimerState();
                }
                showCustomAlert("Success", "Settings saved!", "fas fa-check-circle text-green-400", "OK");
            }
        });
        
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.dataset.tab;
                tabButtons.forEach(btn => {
                    btn.classList.remove('active', 'text-sky-400', 'border-sky-400');
                    btn.classList.add('text-slate-400', 'border-transparent');
                });
                button.classList.add('active', 'text-sky-400', 'border-sky-400');
                button.classList.remove('text-slate-400', 'border-transparent');
                tabPanes.forEach(pane => {
                    if (pane.id === `${targetTab}Content`) {
                        pane.classList.remove('hidden');
                    } else {
                        pane.classList.add('hidden');
                    }
                });
                updateStatsDisplay();
                renderRewards(); 
                renderAchievements(); 
            });
        });

        // --- Initialization ---
        function initializeApp() {
            const styleEl = document.createElement('style');
            document.head.appendChild(styleEl);
            const styleSheet = styleEl.sheet;
            try {
                let ruleExists = false;
                for (let i = 0; i < styleSheet.cssRules.length; i++) {
                    if (styleSheet.cssRules[i].selectorText === '.help-content li.study-session::before') {
                        ruleExists = true;
                        break;
                    }
                }
                if(!ruleExists) {
                     styleSheet.insertRule('.help-content li.study-session::before { content: var(--session-number); position: absolute; left: 5px; font-weight: bold; }', 0);
                }
            } catch (e) {
                console.error("Could not insert CSS rule for help list during init: ", e);
            }

            loadData(); 
            
            const todayStrInitialize = getTodayDateString();
            if (appData.stats.general.lastStudyDate && appData.stats.general.lastStudyDate !== todayStrInitialize) {
                const lastStudy = new Date(appData.stats.general.lastStudyDate);
                const today = new Date(todayStrInitialize);
                const yesterday = new Date(today);
                yesterday.setDate(today.getDate() - 1);

                lastStudy.setHours(0,0,0,0); 
                yesterday.setHours(0,0,0,0);
                
                if (lastStudy.getTime() < yesterday.getTime()) { 
                    appData.stats.general.streak = 0;
                    console.log("Streak reset to 0 due to inactivity upon app load.");
                }
            }


            if (appData.stats.daily.date !== getTodayDateString()) {
                 resetDailyStats(); 
                 if (appData.timerState) { 
                    appData.timerState.persistedCurrentMode = 'study';
                    appData.timerState.persistedTimeLeft = appData.settings.studyTime * 60;
                    appData.timerState.persistedIsRunning = false;
                    appData.timerState.persistedPomodorosInCycle = 0;
                    appData.timerState.forcedBreakContextSession = null;
                 }
                 saveData(); 
            }

            let initialMode = 'study';
            let initialTimeLeft = appData.settings.studyTime * 60;
            let initialPomodorosInCycle = 0;

            if (appData.timerState && 
                typeof appData.timerState.persistedTimeLeft === 'number' && 
                !isNaN(appData.timerState.persistedTimeLeft) &&
                appData.timerState.persistedCurrentMode &&
                ['study', 'shortBreak', 'longBreak'].includes(appData.timerState.persistedCurrentMode)) {
                
                initialMode = appData.timerState.persistedCurrentMode;
                initialTimeLeft = appData.timerState.persistedTimeLeft;
                initialPomodorosInCycle = typeof appData.timerState.persistedPomodorosInCycle === 'number' ? appData.timerState.persistedPomodorosInCycle : 0;
            }
            
            currentMode = initialMode;
            timeLeft = initialTimeLeft;
            isRunning = false; 
            pomodorosInCycle = initialPomodorosInCycle;
            
            updateTimerDisplay(); 
            
            let fullDurationForMode;
            switch(currentMode) {
                case 'study': fullDurationForMode = appData.settings.studyTime * 60; break;
                case 'shortBreak': fullDurationForMode = appData.settings.shortBreakTime * 60; break;
                case 'longBreak': fullDurationForMode = appData.settings.longBreakTime * 60; break;
                default: fullDurationForMode = appData.settings.studyTime * 60; 
            }

            if (timeLeft < fullDurationForMode && timeLeft > 0) {
                startPauseButton.innerHTML = '<i class="fas fa-play mr-2"></i>Resume';
            } else { 
                startPauseButton.innerHTML = '<i class="fas fa-play mr-2"></i>Start';
            }
            
            updateStatsDisplay();
            updateLastTimerInfo();
            renderRewards();
            renderAchievements();

            if (appData.settings.notificationsEnabled && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                requestNotificationPermission(); 
            } else if (Notification.permission === 'denied') {
                appData.settings.notificationsEnabled = false; 
                notificationsToggle.checked = false;
                notificationsToggle.disabled = true;
                saveData();
            }
        }

        window.addEventListener('beforeunload', saveTimerState);

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
<head>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
        }

        .donation-section {
            text-align: center;
            font-size: 0.75em;
            color: #5a687d;
            margin-top: 20px;
            max-width: 300px;
            opacity: 0.75;
            line-height: 1.4;
        }

        .donation-section a {
            color: #5a687d;
            text-decoration: none;
            white-space: nowrap;
            transition: color 0.3s ease;
        }

        .donation-section a:hover {
            color: #FFDD00;
        }
    </style>
</head>
<body>
    
    <div class="donation-section">
        <p>If you'd like to support this app, you can do so <a href="https://www.buymeacoffee.com/lemonade299792458" target="_blank">here ‚òï</a></p>
    </div>
    
</body>
</html>
