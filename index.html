<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PomodoroCycle Timer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
    <link id="favicon" rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text x="50" y="50" font-size="90" dominant-baseline="middle" text-anchor="middle">üçÖ</text></svg>'>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.5s ease;
            overflow-y: scroll; 
        }
        .timer-text {
            font-family: 'Roboto Mono', monospace;
            font-size: 6rem; 
            line-height: 1;
            letter-spacing: -0.05em;
            font-weight: 700;
        }
        .tab-button.active {
            border-bottom-width: 4px;
        }
        .achievement-item { 
            height: 7rem; 
            display: flex;
            flex-direction: column;
            justify-content: space-between; 
            overflow: hidden; 
            position: relative; 
        }
        .modal { display: none; }
        .modal.show { display: flex; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .progress-bar-container {
            width: 100%;
            height: 6px; 
            background-color: #e0e0e0; 
            border-radius: 3px; 
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: #4caf50; 
            border-radius: 3px; 
            transition: width 0.3s ease-in-out;
        }
        .help-content ul { list-style-type: none; padding-left: 0; margin-bottom: 10px; }
        .help-content li { margin-bottom: 5px; padding-left: 25px; position: relative; }
        .help-content li.break-session { color: #a0aec0; }
        #skipBreakButton {
            background-color: #4a5568; color: #a0aec0; border: 1px solid #4a5568;
        }
        #skipBreakButton:hover {
            background-color: #2d3748; color: #e2e8f0; border-color: #2d3748;
        }
        #toastNotification {
            position: fixed; top: 20px; right: 20px; padding: 1rem; border-radius: 0.5rem;
            color: white; font-size: 0.875rem; z-index: 1000; opacity: 0;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            max-width: 300px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateX(100%);
        }
        #toastNotification.show { opacity: 1; transform: translateX(0); }
        #toastNotification.success { background-color: #34d399; } 
        #toastNotification.error { background-color: #ef4444; } 
        #toastNotification.info { background-color: #3b82f6; } 
        #toastNotification.warning { background-color: #f59e0b; } 
        .tab-badge {
            position: absolute; top: 0.5rem; right: 0.5rem; background-color: #ef4444;
            color: white; border-radius: 9999px; padding: 0.1rem 0.4rem;
            font-size: 0.65rem; font-weight: bold; line-height: 1;
            min-width: 1rem; text-align: center; display: none; 
        }
        .tab-button { position: relative; }
        .new-indicator { font-size: 0.65rem; padding: 0.1rem 0.3rem; border-radius: 0.25rem; line-height: 1; }
        .cycle-dot {
            width: 0.75rem; /* 12px */
            height: 0.75rem; /* 12px */
            border-radius: 9999px;
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="bg-slate-900 text-white flex flex-col items-center min-h-screen p-4 selection:bg-sky-400 selection:text-sky-900">

    <div class="w-full max-w-3xl mx-auto bg-slate-800 shadow-2xl rounded-lg p-6 relative mt-4 mb-4"> 
        <div class="absolute top-6 left-6 z-10">
             <button id="helpButton" title="Help / How to Use" class="p-2 rounded-full text-sky-400 hover:bg-slate-700 hover:text-sky-300 transition-colors focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-opacity-50">
                 <i class="fas fa-question-circle text-xl"></i>
            </button>
        </div>
        <div class="absolute top-6 right-6 z-10">
            <button id="settingsButton" title="Settings" class="p-2 rounded-full hover:bg-slate-700 transition-colors focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-opacity-50">
                <i class="fas fa-cog text-xl text-sky-400 hover:text-sky-300"></i>
            </button>
        </div>

        <!-- Timer Display Updated -->
        <div id="timerDisplay" class="relative text-center mb-6 pt-8 md:pt-4 pb-4 rounded-lg bg-slate-700 shadow-inner">
            <!-- Mode Indicator with Label -->
            <div id="modeIndicator" class="h-8 flex items-center justify-center mb-2 text-slate-300 font-medium">
                <span>Current mode:&nbsp;</span>
                <span id="modePill" class="py-1 px-3 rounded-full text-sm font-semibold transition-all duration-500">Study</span>
            </div>
            
            <!-- Timer Text without shadow -->
            <p id="timerText" class="timer-text text-sky-400 transition-colors duration-500">25:00</p>
            
            <!-- Cycle Info with repositioned reset button -->
            <div class="flex justify-center mt-4 h-8">
                <div class="relative inline-flex items-center">
                    <div id="cycleDotsContainer" class="flex items-center justify-center space-x-2.5" title="Study Sessions in Current Cycle">
                        <div class="cycle-dot"></div>
                        <div class="cycle-dot"></div>
                        <div class="cycle-dot"></div>
                        <div class="cycle-dot"></div>
                    </div>
                    <!-- Discreet Reset Button -->
                    <button id="resetCycleCountButton" title="Reset cycle" class="absolute left-full ml-3 p-1 text-slate-500 hover:text-sky-400 transition-colors focus:outline-none focus:ring-0 text-[10px]">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            
            <button id="skipBreakButton" class="absolute bottom-3 right-3 hidden text-xs py-1 px-2 rounded-md shadow-md transition-transform transform hover:scale-105">
                <i class="fas fa-forward fa-xs mr-1"></i>Skip Break
            </button>
        </div>

        <div class="flex justify-center space-x-4 mb-8">
            <button id="startPauseButton" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                <i class="fas fa-play mr-2"></i>Start
            </button>
            <button id="resetButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                <i class="fas fa-undo mr-2"></i>Reset Current
            </button>
        </div>
        
        <div class="mb-6 border-b border-slate-700">
            <nav class="flex space-x-1 -mb-px">
                <button data-tab="stats" class="tab-button active text-sky-400 border-sky-400 py-3 px-4 font-medium text-center hover:text-sky-300 hover:border-sky-300 transition-colors">
                    <i class="fas fa-chart-line mr-2"></i>Statistics
                </button>
                <button data-tab="rewards" class="tab-button text-slate-400 border-transparent py-3 px-4 font-medium text-center hover:text-sky-300 hover:border-sky-300 transition-colors">
                    <i class="fas fa-gift mr-2"></i>Daily Rewards <span id="rewardsTabBadge" class="tab-badge"></span>
                </button>
                <button data-tab="achievements" class="tab-button text-slate-400 border-transparent py-3 px-4 font-medium text-center hover:text-sky-300 hover:border-sky-300 transition-colors">
                    <i class="fas fa-trophy mr-2"></i>Achievements <span id="achievementsTabBadge" class="tab-badge"></span>
                </button>
            </nav>
        </div>

        <div id="tabContent"> 
            <div id="statsContent" class="tab-pane active p-4 bg-slate-700 rounded-b-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-sky-300">Your Statistics</h3>
                    <p id="streakContainerHeader" class="text-base text-slate-300">Study Streak: <span id="streakCounterHeader" class="font-semibold">0</span> <span id="streakFireIconContainer"><i class="fas fa-fire"></i></span></p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-slate-600 p-4 rounded-lg shadow">
                        <h4 class="font-bold text-sky-400">Daily:</h4>
                        <p>Cycles Completed Today: <span id="dailyCycles">0</span></p>
                        <p>Pure Study Time Today: <span id="dailyStudyTime">0h 0m</span></p>
                        <p>Total Time Today: <span id="dailyTotalTime">0h 0m</span></p>
                    </div>
                    <div class="bg-slate-600 p-4 rounded-lg shadow">
                        <h4 class="font-bold text-sky-400">General:</h4>
                        <p>Total Cycles Completed: <span id="totalCycles">0</span></p>
                        <p>Total Pure Study Time: <span id="totalStudyTime">0h 0m</span></p>
                        <p>Total Days Studied: <span id="totalDaysStudied">0</span></p>
                    </div>
                </div>
            </div>
            <div id="rewardsContent" class="tab-pane hidden p-4 bg-slate-700 rounded-b-lg">
                <h3 class="text-xl font-semibold mb-4 text-sky-300">Manage Daily Rewards</h3>
                <div class="mb-4 p-3 bg-slate-600 rounded-lg md:flex md:items-center md:space-x-2 md:flex-wrap">
                    <input type="text" id="rewardName" placeholder="Reward name" class="w-full md:flex-1 p-2 rounded bg-slate-500 text-white placeholder-slate-300 mb-2 md:mb-0">
                    <select id="rewardType" class="w-full md:w-auto p-2 rounded bg-slate-500 text-white mb-2 md:mb-0">
                        <option value="cycles">Completed Cycles</option>
                        <option value="studyHours">Study Hours</option>
                    </select>
                    <input type="number" id="rewardThreshold" placeholder="Value" step="0.5" min="0" class="w-full md:w-28 p-2 rounded bg-slate-500 text-white placeholder-slate-300 mb-2 md:mb-0">
                    <button id="addRewardButton" class="w-full md:w-auto mt-2 md:mt-0 bg-green-500 hover:bg-green-600 text-white font-bold py-1.5 px-3 rounded transition-colors">Add Reward</button>
                </div>
                <div id="rewardsList" class="space-y-2 max-h-[176px] overflow-y-auto pr-2"></div>
            </div>
            <div id="achievementsContent" class="tab-pane hidden p-4 bg-slate-700 rounded-b-lg">
                <h3 class="text-xl font-semibold mb-4 text-sky-300">Your Achievements</h3>
                <div id="achievementsList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 max-h-64 overflow-y-auto pr-2"></div>
            </div>
        </div>
        <div class="mt-4 text-center">
            <p class="text-xs text-slate-500">
                <i class="fas fa-info-circle mr-1"></i>Your progress is saved in your browser's local storage. Clearing browser data may delete your progress.
            </p>
        </div>
    </div>
    <div id="settingsModal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-50">
        <div class="bg-slate-800 p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-sky-400">Timer Settings</h2>
            <div class="space-y-4">
                <div>
                    <label for="studyTimeInput" class="block text-sm font-medium text-slate-300">Study Time (minutes):</label>
                    <input type="number" id="studyTimeInput" min="1" class="mt-1 block w-full p-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500">
                </div>
                <div>
                    <label for="shortBreakTimeInput" class="block text-sm font-medium text-slate-300">Short Break (minutes):</label>
                    <input type="number" id="shortBreakTimeInput" min="1" class="mt-1 block w-full p-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500">
                </div>
                <div>
                    <label for="longBreakTimeInput" class="block text-sm font-medium text-slate-300">Long Break (minutes):</label>
                    <input type="number" id="longBreakTimeInput" min="1" class="mt-1 block w-full p-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500">
                </div>
                 <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-slate-300">Enable Sounds:</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="soundToggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-slate-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-sky-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-sky-500"></div>
                    </label>
                </div>
            </div>
            <div class="mt-8 flex justify-end space-x-3">
                <button id="cancelSettingsButton" class="px-4 py-2 text-sm font-medium text-slate-300 bg-slate-600 hover:bg-slate-500 rounded-md transition-colors">Cancel</button>
                <button id="saveSettingsButton" class="px-4 py-2 text-sm font-medium text-white bg-sky-500 hover:bg-sky-600 rounded-md transition-colors">Save Settings</button>
            </div>
        </div>
    </div>
    <div id="customAlertModal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-[100]">
        <div class="bg-slate-800 p-6 rounded-lg shadow-xl w-full max-w-md text-left"> 
            <div class="flex items-start">
                <div id="customAlertIcon" class="text-3xl mr-4 mt-1"></div> 
                <div>
                    <h3 id="customAlertTitle" class="text-xl font-bold mb-2"></h3>
                    <div id="customAlertMessage" class="text-slate-300 mb-6 help-content text-sm"></div>
                </div>
            </div>
            <div id="customAlertButtons" class="flex justify-end space-x-3"> 
                <button id="customAlertCancelButton" class="px-4 py-2 text-sm font-medium text-slate-300 bg-slate-600 hover:bg-slate-500 rounded-md transition-colors">Cancel</button>
                <button id="customAlertConfirmButton" class="px-4 py-2 text-sm font-medium text-white bg-sky-500 hover:bg-sky-600 rounded-md transition-colors">OK</button>
            </div>
        </div>
    </div>
    <div id="toastNotification">
        <strong id="toastTitle" class="font-bold"></strong>
        <p id="toastBody"></p>
    </div>
    <script id="timerWorkerScript" type="javascript/worker">
        // Worker script (inalterado)
        let workerTimeLeft; let workerIsRunning=!1; let workerTimerInterval; let workerCurrentMode; let workerSettings={}; function startWorkerTimer(){if(workerIsRunning)return;if(workerTimeLeft<=0){postMessage({type:"end",mode:workerCurrentMode});return}workerIsRunning=!0;workerTimerInterval=setInterval(()=>{if(!workerIsRunning){clearInterval(workerTimerInterval);return}workerTimeLeft--;postMessage({type:"tick",timeLeft:workerTimeLeft,mode:workerCurrentMode});if(workerTimeLeft<=0){clearInterval(workerTimerInterval);workerIsRunning=!1;postMessage({type:"end",mode:workerCurrentMode})}},1e3)}self.onmessage=function(e){const{command:o,mode:t,duration:s,settings:i}=e.data;switch(o){case"start":workerIsRunning||startWorkerTimer();break;case"pause":workerIsRunning=!1;clearInterval(workerTimerInterval);break;case"setMode":workerCurrentMode=t;workerTimeLeft=s;workerIsRunning=!1;clearInterval(workerTimerInterval);postMessage({type:"modeSet",timeLeft:workerTimeLeft,mode:workerCurrentMode});break;case"updateSettings":workerSettings=i;if(!workerIsRunning&&workerCurrentMode){let e;e="study"===workerCurrentMode?workerSettings.studyTime*60:"shortBreak"===workerCurrentMode?workerSettings.shortBreakTime*60:"longBreak"===workerCurrentMode?workerSettings.longBreakTime*60:null;e&&workerTimeLeft!==e&&(workerTimeLeft=e,postMessage({type:"tick",timeLeft:workerTimeLeft,mode:workerCurrentMode}))}}};
    </script>
    <script>
        // --- DOM Elements ---
        const timerTextEl = document.getElementById('timerText');
        const modePillEl = document.getElementById('modePill');
        const cycleDotsContainerEl = document.getElementById('cycleDotsContainer');
        const resetButton = document.getElementById('resetButton');
        const resetCycleCountButtonEl = document.getElementById('resetCycleCountButton');
        const startPauseButton = document.getElementById('startPauseButton');
        const skipBreakButton = document.getElementById('skipBreakButton'); 
        const settingsButton = document.getElementById('settingsButton');
        const helpButton = document.getElementById('helpButton'); 
        const settingsModal = document.getElementById('settingsModal');
        const saveSettingsButton = document.getElementById('saveSettingsButton');
        const cancelSettingsButton = document.getElementById('cancelSettingsButton');
        const studyTimeInput = document.getElementById('studyTimeInput');
        const shortBreakTimeInput = document.getElementById('shortBreakTimeInput');
        const longBreakTimeInput = document.getElementById('longBreakTimeInput');
        const soundToggle = document.getElementById('soundToggle');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabPanes = document.querySelectorAll('.tab-pane');
        const dailyCyclesEl = document.getElementById('dailyCycles'); 
        const dailyStudyTimeEl = document.getElementById('dailyStudyTime');
        const dailyTotalTimeEl = document.getElementById('dailyTotalTime');
        const totalDaysStudiedEl = document.getElementById('totalDaysStudied');
        const totalCyclesEl = document.getElementById('totalCycles');
        const totalStudyTimeEl = document.getElementById('totalStudyTime');
        const streakCounterHeaderEl = document.getElementById('streakCounterHeader'); 
        const streakFireIconContainerEl = document.getElementById('streakFireIconContainer');
        const rewardNameInput = document.getElementById('rewardName');
        const rewardTypeSelect = document.getElementById('rewardType');
        const rewardThresholdInput = document.getElementById('rewardThreshold');
        const addRewardButton = document.getElementById('addRewardButton');
        const rewardsListEl = document.getElementById('rewardsList');
        const achievementsListEl = document.getElementById('achievementsList');
        const customAlertModal = document.getElementById('customAlertModal');
        const customAlertIconEl = document.getElementById('customAlertIcon');
        const customAlertTitleEl = document.getElementById('customAlertTitle');
        const customAlertMessageEl = document.getElementById('customAlertMessage');
        const customAlertConfirmButton = document.getElementById('customAlertConfirmButton');
        const customAlertCancelButton = document.getElementById('customAlertCancelButton');
        const customAlertButtonsContainer = document.getElementById('customAlertButtons');
        const faviconEl = document.getElementById('favicon'); 
        const toastNotificationEl = document.getElementById('toastNotification');
        const toastTitleEl = document.getElementById('toastTitle');
        const toastBodyEl = document.getElementById('toastBody');
        const rewardsTabBadgeEl = document.getElementById('rewardsTabBadge');
        const achievementsTabBadgeEl = document.getElementById('achievementsTabBadge');

        // --- State Variables ---
        let timeLeft;
        let currentMode = 'study';
        let isRunning = false;
        let pomodorosInCycle = 0;
        const POMODOROS_PER_CYCLE = 4;
        let lastSoundScheduledTime = 0;
        const MIN_SOUND_INTERVAL = 0.05, SOUND_BASE_DELAY = 0.05;
        let justSeenRewardIds = [], justSeenAchievementIds = [];
        let appData = {
            settings: { studyTime: 25, shortBreakTime: 5, longBreakTime: 15, soundEnabled: true },
            timerState: { lastTimerUsed: null, persistedCurrentMode: "study", persistedTimeLeft: null, persistedIsRunning: false, persistedPomodorosInCycle: 0, persistedPreviousPomodorosInCycle: null },
            stats: {
                daily: { date: getTodayDateString(), cyclesCompleted: 0, pureStudySeconds: 0, totalTimeTodaySeconds: 0, firstStudySessionCompletedToday: false },
                general: { totalDaysStudied: 0, totalCyclesCompleted: 0, totalPureStudySeconds: 0, streak: 0, lastStudyDate: null, totalShortBreakSeconds: 0, totalLongBreakSeconds: 0 }
            },
            rewards: [],
            achievements: [],
            uiState: { newRewardsCount: 0, newAchievementsCount: 0 },
            appVersion: "1.5.0" // Version updated for fixes
        };
        const defaultAchievements = [{"id":"days1","name":"Focused Beginner","description":"Complete your first day of study.","type":"totalDaysStudied","threshold":1,"icon":"fas fa-seedling","seen":!1},{"id":"days7","name":"Weekly Commitment","description":"Study for 7 days.","type":"totalDaysStudied","threshold":7,"icon":"fas fa-calendar-check","seen":!1},{"id":"days15","name":"Fortnightly Focus","description":"Study for 15 days.","type":"totalDaysStudied","threshold":15,"icon":"fas fa-medal","seen":!1},{"id":"days30","name":"Monthly Landmark","description":"Study for 30 days.","type":"totalDaysStudied","threshold":30,"icon":"fas fa-award","seen":!1},{"id":"days50","name":"Shooting Star","description":"Study for 50 days.","type":"totalDaysStudied","threshold":50,"icon":"fas fa-star","seen":!1},{"id":"days75","name":"Study Marathoner","description":"Study for 75 days.","type":"totalDaysStudied","threshold":75,"icon":"fas fa-running","seen":!1},{"id":"days100","name":"Habit Master","description":"Study for 100 days.","type":"totalDaysStudied","threshold":100,"icon":"fas fa-crown","seen":!1},{"id":"days120","name":"Focus Legend","description":"Study for 120 days.","type":"totalDaysStudied","threshold":120,"icon":"fas fa-book-reader","seen":!1},{"id":"days150","name":"Study Sage","description":"Study for 150 days.","type":"totalDaysStudied","threshold":150,"icon":"fas fa-graduation-cap","seen":!1},{"id":"streak3","name":"3-Day Combo!","description":"Maintain a 3-day study streak.","type":"streak","threshold":3,"icon":"fas fa-fire","seen":!1},{"id":"streak7","name":"A Week Streak","description":"Maintain a 7-day study streak.","type":"streak","threshold":7,"icon":"fas fa-bolt","seen":!1},{"id":"streak14","name":"Habit Power-Up","description":"Maintain a 14-day study streak.","type":"streak","threshold":14,"icon":"fas fa-dumbbell","seen":!1},{"id":"streak30","name":"Simply Unstoppable","description":"Maintain a 30-day study streak.","type":"streak","threshold":30,"icon":"fas fa-calendar-alt","seen":!1},{"id":"streak50","name":"True Dedication","description":"Maintain a 50-day study streak.","type":"streak","threshold":50,"icon":"fas fa-shield-alt","seen":!1},{"id":"cycles1","name":"First Full Cycle","description":"Complete 1 Pomodoro cycle.","type":"totalCyclesCompleted","threshold":1,"icon":"fas fa-flag-checkered","seen":!1},{"id":"cycles10","name":"Ten Cycles of Focus","description":"Complete 10 Pomodoro cycles.","type":"totalCyclesCompleted","threshold":10,"icon":"fas fa-spinner fa-spin","seen":!1},{"id":"cycles25","name":"Productivity Pro","description":"Complete 25 Pomodoro cycles.","type":"totalCyclesCompleted","threshold":25,"icon":"fas fa-cogs","seen":!1},{"id":"cycles50","name":"To The Moon","description":"Complete 50 Pomodoro cycles.","type":"totalCyclesCompleted","threshold":50,"icon":"fas fa-rocket","seen":!1},{"id":"cycles100","name":"Cycle Centurion","description":"Complete 100 Pomodoro cycles.","type":"totalCyclesCompleted","threshold":100,"icon":"fas fa-gem","seen":!1},{"id":"hours1","name":"First Hour of Focus","description":"Accumulate 1 hour of pure study.","type":"totalPureStudyHours","threshold":1,"icon":"fas fa-hourglass-start","seen":!1},{"id":"hours10","name":"Immersive Thinker","description":"Accumulate 10 hours of pure study.","type":"totalPureStudyHours","threshold":10,"icon":"fas fa-brain","seen":!1},{"id":"hours50","name":"Knowledge Fountain","description":"Accumulate 50 hours of pure study.","type":"totalPureStudyHours","threshold":50,"icon":"fas fa-microscope","seen":!1},{"id":"hours100","name":"Pure Scholar","description":"Accumulate 100 hours of pure study.","type":"totalPureStudyHours","threshold":100,"icon":"fas fa-university","seen":!1},{"id":"sb_minutes_30","name":"Quick Breather","description":"Accumulate 30 minutes in short breaks.","type":"totalShortBreakSeconds","threshold":1800,"icon":"fas fa-coffee","seen":!1},{"id":"sb_hours_1","name":"Relaxation Adept","description":"Accumulate 1 hour in short breaks.","type":"totalShortBreakSeconds","threshold":3600,"icon":"fas fa-mug-hot","seen":!1},{"id":"sb_hours_5","name":"Short Break Champion","description":"Accumulate 5 hours in short breaks.","type":"totalShortBreakSeconds","threshold":18e3,"icon":"fas fa-couch","seen":!1},{"id":"lb_hours_1","name":"Well Deserved Rest","description":"Accumulate 1 hour in long breaks.","type":"totalLongBreakSeconds","threshold":3600,"icon":"fas fa-bed","seen":!1},{"id":"lb_hours_3","name":"Recharge Master","description":"Accumulate 3 hours in long breaks.","type":"totalLongBreakSeconds","threshold":10800,"icon":"fas fa-battery-full","seen":!1},{"id":"lb_hours_10","name":"Leisure Expert","description":"Accumulate 10 hours in long breaks.","type":"totalLongBreakSeconds","threshold":36e3,"icon":"fas fa-umbrella-beach","seen":!1}];

        // --- Sound Synthesis (Tone.js) ---
        let synth;
        if (typeof Tone !== 'undefined') {
            synth = new Tone.Synth().toDestination();
        } else {
            console.warn("Tone.js not loaded. Sound effects will be disabled.");
        }

        function playSound(note = 'C4', duration = '8n', type = 'timerComplete') {
            if (!appData.settings.soundEnabled || !synth) return;
            if (Tone.context.state !== 'running') {
                Tone.context.resume().catch(e => console.error("Error resuming AudioContext:", e));
            }
            if (Tone.Transport.state !== "started") {
                Tone.Transport.start();
            }
            try {
                let soundNote = note, soundDuration = duration, soundVolume = 0;
                if (type === 'achievement') { soundNote = "C5"; soundDuration = "4n"; soundVolume = -6; } 
                else if (type === 'reward') { soundNote = "E5"; soundDuration = "4n"; soundVolume = -6; }
                const currentTime = Tone.now();
                const scheduledTime = Math.max(currentTime + SOUND_BASE_DELAY, lastSoundScheduledTime + MIN_SOUND_INTERVAL);
                lastSoundScheduledTime = scheduledTime;
                synth.volume.setValueAtTime(soundVolume, scheduledTime);
                synth.triggerAttackRelease(soundNote, soundDuration, scheduledTime);
            } catch (error) {
                console.error(`Error playing sound (type: ${type}):`, error);
            }
        }
        
        // --- Utility Functions ---
        function getTodayDateString() {
            const today = new Date();
            return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        }
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
        function formatHoursMinutes(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            return `${hours}h ${minutes}m`;
        }
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // --- Data Persistence (localStorage) ---
        const STORAGE_KEY = 'pomodoroGamifiedAppData';
        function saveTimerState() {
            appData.timerState.persistedCurrentMode = currentMode;
            appData.timerState.persistedTimeLeft = timeLeft;
            appData.timerState.persistedIsRunning = isRunning;
            appData.timerState.persistedPomodorosInCycle = pomodorosInCycle;
            saveData();
        }
        function loadData() {
            const storedData = localStorage.getItem(STORAGE_KEY);
            const defaultTimerState = { lastTimerUsed: null, persistedCurrentMode: 'study', persistedTimeLeft: appData.settings.studyTime * 60, persistedIsRunning: false, persistedPomodorosInCycle: 0, persistedPreviousPomodorosInCycle: null, forcedBreakContextSession: null };
            const defaultUiState = { newRewardsCount: 0, newAchievementsCount: 0 };
            if (storedData) {
                const parsedData = JSON.parse(storedData);
                if (parsedData.appVersion !== appData.appVersion) {
                    console.log(`Data version mismatch. Current: ${appData.appVersion}, Stored: ${parsedData.appVersion}. Merging data.`);
                    if (!parsedData.stats?.general?.totalShortBreakSeconds) {
                        if (!parsedData.stats) parsedData.stats = {};
                        if (!parsedData.stats.general) parsedData.stats.general = {};
                        parsedData.stats.general.totalShortBreakSeconds = 0;
                    }
                    if (!parsedData.stats?.general?.totalLongBreakSeconds) {
                        if (!parsedData.stats) parsedData.stats = {};
                        if (!parsedData.stats.general) parsedData.stats.general = {};
                        parsedData.stats.general.totalLongBreakSeconds = 0;
                    }
                    if (!parsedData.stats?.daily?.totalTimeTodaySeconds) {
                        if (!parsedData.stats) parsedData.stats = {};
                        if (!parsedData.stats.daily) parsedData.stats.daily = {};
                        parsedData.stats.daily.totalTimeTodaySeconds = 0;
                    }
                }
                const mergedAchievements = defaultAchievements.map(defaultAch => {
                    const userAch = parsedData.achievements?.find(ua => ua.id === defaultAch.id);
                    return { ...defaultAch, unlocked: userAch?.unlocked || false, unlockedDate: userAch?.unlockedDate || null, seen: userAch?.seen || (userAch?.unlocked || false) };
                });
                const userRewards = (parsedData.rewards || []).map(reward => ({ ...reward, seen: reward.seen || (reward.earnedToday || false) }));
                const loadedTimerState = { ...defaultTimerState, ...(parsedData.timerState || {}) };
                const loadedUiState = { ...defaultUiState, ...(parsedData.uiState || {}) };
                const loadedPomodorosInCycle = loadedTimerState.persistedPomodorosInCycle !== undefined ? parseInt(loadedTimerState.persistedPomodorosInCycle, 10) : 0;
                appData = { ...appData, ...parsedData, achievements: mergedAchievements, rewards: userRewards, timerState: loadedTimerState, uiState: loadedUiState };
                pomodorosInCycle = isNaN(loadedPomodorosInCycle) ? 0 : loadedPomodorosInCycle;
                if (appData.stats.general.totalShortBreakSeconds === undefined) { appData.stats.general.totalShortBreakSeconds = 0; }
                if (appData.stats.general.totalLongBreakSeconds === undefined) { appData.stats.general.totalLongBreakSeconds = 0; }
                if (appData.stats.daily.totalTimeTodaySeconds === undefined) { appData.stats.daily.totalTimeTodaySeconds = 0; }
                if (appData.stats.daily.date !== getTodayDateString()) {
                    resetDailyStats();
                    appData.uiState.newRewardsCount = 0;
                    appData.rewards.forEach(r => r.seen = false);
                }
            } else {
                appData.achievements = defaultAchievements.map(ach => ({ ...ach, unlocked: false, unlockedDate: null, seen: false }));
                pomodorosInCycle = 0;
                appData.stats.general.totalShortBreakSeconds = 0;
                appData.stats.general.totalLongBreakSeconds = 0;
                appData.stats.daily.totalTimeTodaySeconds = 0;
                appData.timerState = { ...defaultTimerState };
                appData.timerState.persistedTimeLeft = appData.settings.studyTime * 60;
                appData.uiState = { ...defaultUiState };
            }
            studyTimeInput.value = appData.settings.studyTime;
            shortBreakTimeInput.value = appData.settings.shortBreakTime;
            longBreakTimeInput.value = appData.settings.longBreakTime;
            soundToggle.checked = appData.settings.soundEnabled;
            updateRewardTabNotificationBadge();
            updateAchievementTabNotificationBadge();
        }
        function saveData() {
            appData.pomodorosInCycle = pomodorosInCycle;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
        }

        // --- Toast & Alerts ---
        let toastTimeout;
        function showToast(title, body, type = 'info', duration = 4000) {
            clearTimeout(toastTimeout);
            toastTitleEl.textContent = title;
            toastBodyEl.textContent = body;
            toastNotificationEl.className = 'fixed top-5 right-5 p-4 rounded-md text-white z-[1000] transition-all duration-500 max-w-xs shadow-lg';
            switch (type) {
                case 'success': toastNotificationEl.classList.add('bg-green-500', 'show'); break;
                case 'error': toastNotificationEl.classList.add('bg-red-500', 'show'); break;
                case 'warning': toastNotificationEl.classList.add('bg-yellow-500', 'show'); break;
                default: toastNotificationEl.classList.add('bg-sky-500', 'show');
            }
            toastTimeout = setTimeout(() => { toastNotificationEl.classList.remove('show'); }, duration);
        }
        function updateRewardTabNotificationBadge() {
            const unseenRewards = appData.rewards.filter(r => r.earnedToday && !r.seen).length;
            appData.uiState.newRewardsCount = unseenRewards;
            rewardsTabBadgeEl.style.display = unseenRewards > 0 ? 'inline-block' : 'none';
            if (unseenRewards > 0) rewardsTabBadgeEl.textContent = unseenRewards;
        }
        function updateAchievementTabNotificationBadge() {
            const unseenAchievements = appData.achievements.filter(ach => ach.unlocked && !ach.seen).length;
            appData.uiState.newAchievementsCount = unseenAchievements;
            achievementsTabBadgeEl.style.display = unseenAchievements > 0 ? 'inline-block' : 'none';
            if (unseenAchievements > 0) achievementsTabBadgeEl.textContent = unseenAchievements;
        }
        let currentConfirmCallback = null, currentCancelCallback = null;
        function showCustomAlert(title, message, iconClass = "fas fa-info-circle text-sky-400", confirmText = "OK", cancelText = null, confirmCallback = null, cancelCallback = null) {
            customAlertTitleEl.textContent = title;
            customAlertMessageEl.innerHTML = message;
            customAlertIconEl.className = `text-3xl mr-4 mt-1 ${iconClass}`;
            customAlertConfirmButton.textContent = confirmText;
            currentConfirmCallback = confirmCallback;
            if (cancelText && typeof cancelCallback === 'function') {
                customAlertCancelButton.textContent = cancelText;
                customAlertCancelButton.classList.remove('hidden');
                customAlertButtonsContainer.classList.remove('justify-end');
                customAlertButtonsContainer.classList.add('justify-center');
                currentCancelCallback = cancelCallback;
            } else {
                customAlertCancelButton.classList.add('hidden');
                customAlertButtonsContainer.classList.remove('justify-center');
                customAlertButtonsContainer.classList.add('justify-end');
                currentCancelCallback = null;
            }
            customAlertModal.classList.add('show');
        }
        customAlertConfirmButton.addEventListener('click', () => {
            if (typeof currentConfirmCallback === 'function') currentConfirmCallback();
            customAlertModal.classList.remove('show');
            currentConfirmCallback = null; currentCancelCallback = null;
        });
        customAlertCancelButton.addEventListener('click', () => {
            if (typeof currentCancelCallback === 'function') currentCancelCallback();
            customAlertModal.classList.remove('show');
            currentConfirmCallback = null; currentCancelCallback = null;
        });

        // --- UI Update Functions ---
        function updateTimerDisplay() {
            timerTextEl.textContent = formatTime(timeLeft);
            let modeText = '', bodyClass = 'bg-slate-900', timerColorClass = 'text-sky-400', pillClass = 'bg-sky-400/10 text-sky-400';
            
            switch (currentMode) {
                case 'study':
                    modeText = 'Study';
                    bodyClass = 'bg-slate-900';
                    timerColorClass = 'text-sky-400';
                    pillClass = 'bg-sky-400/10 text-sky-400';
                    skipBreakButton.classList.add('hidden'); 
                    break;
                case 'shortBreak':
                    modeText = 'Short Break';
                    bodyClass = 'bg-green-900';
                    timerColorClass = 'text-green-400';
                    pillClass = 'bg-green-400/10 text-green-400';
                    skipBreakButton.classList.remove('hidden'); 
                    break;
                case 'longBreak':
                    modeText = 'Long Break';
                    bodyClass = 'bg-purple-900';
                    timerColorClass = 'text-purple-400';
                    pillClass = 'bg-purple-400/10 text-purple-400';
                    skipBreakButton.classList.remove('hidden'); 
                    break;
            }
            modePillEl.textContent = modeText;
            modePillEl.className = `py-1 px-3 rounded-full text-sm font-semibold transition-all duration-500 ${pillClass}`;
            timerTextEl.className = `timer-text transition-colors duration-500 ${timerColorClass}`;
            document.body.className = document.body.className.replace(/bg-(slate|green|purple)-(900)/g, '') + ` ${bodyClass}`;
            document.title = `${formatTime(timeLeft)} - ${modeText}`; 
            updateCycleInfo();
        }

        function updateCycleInfo() {
            const dots = cycleDotsContainerEl.children;
            for (let i = 0; i < dots.length; i++) {
                const dot = dots[i];
                dot.className = 'cycle-dot'; // Reset classes
                let borderColorClass = 'border-sky-400';
                 if(currentMode === 'shortBreak') borderColorClass = 'border-green-400';
                 else if(currentMode === 'longBreak') borderColorClass = 'border-purple-400';

                if (i < pomodorosInCycle) {
                    dot.classList.add('bg-sky-500'); // Completed
                } else if (i === pomodorosInCycle && currentMode === 'study') {
                    // Corrected: use a clean border instead of ring for active session
                    dot.classList.add('bg-transparent', 'border-2', borderColorClass);
                } else {
                    dot.classList.add('bg-slate-600'); // Pending
                }
            }
        }
        
        function updateStatsDisplay() {
            dailyCyclesEl.textContent = appData.stats.daily.cyclesCompleted;
            dailyStudyTimeEl.textContent = formatHoursMinutes(appData.stats.daily.pureStudySeconds);
            if (dailyTotalTimeEl) dailyTotalTimeEl.textContent = formatHoursMinutes(appData.stats.daily.totalTimeTodaySeconds);
            totalDaysStudiedEl.textContent = appData.stats.general.totalDaysStudied;
            totalCyclesEl.textContent = appData.stats.general.totalCyclesCompleted;
            totalStudyTimeEl.textContent = formatHoursMinutes(appData.stats.general.totalPureStudySeconds);
            if (streakCounterHeaderEl) streakCounterHeaderEl.textContent = appData.stats.general.streak;
            if (streakFireIconContainerEl) {
                const streak = appData.stats.general.streak;
                let fireColorClass = 'text-slate-400';
                if (streak >= 50) fireColorClass = 'text-yellow-400';
                else if (streak >= 40) fireColorClass = 'text-teal-400';
                else if (streak >= 35) fireColorClass = 'text-sky-400';
                else if (streak >= 30) fireColorClass = 'text-blue-500';
                else if (streak >= 25) fireColorClass = 'text-indigo-500';
                else if (streak >= 20) fireColorClass = 'text-purple-500';
                else if (streak >= 15) fireColorClass = 'text-red-600';
                else if (streak >= 10) fireColorClass = 'text-red-500';
                else if (streak >= 5) fireColorClass = 'text-red-400';
                else if (streak >= 1) fireColorClass = 'text-orange-400';
                streakFireIconContainerEl.className = '';
                streakFireIconContainerEl.classList.add(fireColorClass);
                streakFireIconContainerEl.innerHTML = '<i class="fas fa-fire"></i>';
            }
        }
        function renderRewards() {
            rewardsListEl.innerHTML = "";
            if (appData.rewards.length === 0) {
                rewardsListEl.innerHTML = '<p class="text-slate-400 italic">No rewards configured.</p>';
                return;
            }
            appData.rewards.forEach(reward => {
                const isNew = justSeenRewardIds.includes(reward.id);
                const newIndicatorHTML = isNew ? '<span class="ml-2 text-xs font-bold text-yellow-300 animate-pulse new-indicator">NEW!</span>' : '';
                const rewardEl = document.createElement('div');
                rewardEl.className = `p-2 rounded-lg flex justify-between items-center transition-all ${reward.earnedToday ? 'bg-green-600 shadow-lg' : 'bg-slate-500'} ${isNew ? 'ring-1 ring-yellow-400 ring-inset' : ''}`;
                let progressText = '';
                let progressPercent = 0;
                const rewardTypeDisplay = reward.type === 'cycles' ? 'Cycles' : 'Hours';
                const rewardUnitDisplay = reward.type === 'cycles' ? 'cycles' : 'hours';
                if (reward.type === 'cycles') {
                    progressText = `${appData.stats.daily.cyclesCompleted}/${reward.threshold} cycles`;
                    progressPercent = Math.min(100, (appData.stats.daily.cyclesCompleted / reward.threshold) * 100);
                } else {
                    const currentHours = appData.stats.daily.pureStudySeconds / 3600;
                    progressText = `${currentHours.toFixed(1)}/${reward.threshold} hours`;
                    progressPercent = Math.min(100, (currentHours / reward.threshold) * 100);
                }
                rewardEl.innerHTML = `<div class="flex-grow overflow-hidden"><div class="flex items-baseline"><p class="font-semibold ${reward.earnedToday ? 'text-white' : 'text-sky-300'} truncate mr-1">${reward.name} (${rewardTypeDisplay})</p>${newIndicatorHTML}</div><p class="text-xs ${reward.earnedToday ? 'text-green-200' : 'text-slate-300'}">Goal: ${reward.threshold} ${rewardUnitDisplay} | Progress: ${progressText}</p><div class="mt-1 h-4 flex items-center">${!reward.earnedToday ? `<div class="progress-bar-container w-full"><div class="progress-bar" style="width: ${progressPercent}%;"></div></div>` : '<p class="text-xs text-green-100 font-bold"><i class="fas fa-check-circle mr-1"></i>Reward Earned Today!</p>'}</div></div><button data-id="${reward.id}" class="delete-reward-button text-red-300 hover:text-red-500 p-2 rounded-full transition-colors flex-shrink-0 ml-2"><i class="fas fa-trash-alt"></i></button>`;
                rewardsListEl.appendChild(rewardEl);
            });
            document.querySelectorAll('.delete-reward-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const rewardId = e.currentTarget.dataset.id;
                    appData.rewards = appData.rewards.filter(r => r.id !== rewardId);
                    saveData();
                    renderRewards();
                    updateRewardTabNotificationBadge();
                });
            });
        }
        function renderAchievements() {
            achievementsListEl.innerHTML = "";
            appData.achievements.sort((a, b) => {
                const aIsNewlyUnlocked = justSeenAchievementIds.includes(a.id), bIsNewlyUnlocked = justSeenAchievementIds.includes(b.id);
                if (aIsNewlyUnlocked && !bIsNewlyUnlocked) return -1;
                if (!aIsNewlyUnlocked && bIsNewlyUnlocked) return 1;
                const aIsUnlocked = a.unlocked, bIsUnlocked = b.unlocked;
                if (!aIsUnlocked && !bIsUnlocked) {
                    let currentValueA = 0;
                    switch (a.type) {
                        case 'totalDaysStudied': currentValueA = appData.stats.general.totalDaysStudied; break;
                        case 'totalCyclesCompleted': currentValueA = appData.stats.general.totalCyclesCompleted; break;
                        case 'totalPureStudyHours': currentValueA = appData.stats.general.totalPureStudySeconds / 3600; break;
                        case 'streak': currentValueA = appData.stats.general.streak; break;
                        case 'totalShortBreakSeconds': currentValueA = appData.stats.general.totalShortBreakSeconds; break;
                        case 'totalLongBreakSeconds': currentValueA = appData.stats.general.totalLongBreakSeconds; break;
                    }
                    const progressA = a.threshold > 0 ? (currentValueA / a.threshold) : -1;
                    let currentValueB = 0;
                    switch (b.type) {
                        case 'totalDaysStudied': currentValueB = appData.stats.general.totalDaysStudied; break;
                        case 'totalCyclesCompleted': currentValueB = appData.stats.general.totalCyclesCompleted; break;
                        case 'totalPureStudyHours': currentValueB = appData.stats.general.totalPureStudySeconds / 3600; break;
                        case 'streak': currentValueB = appData.stats.general.streak; break;
                        case 'totalShortBreakSeconds': currentValueB = appData.stats.general.totalShortBreakSeconds; break;
                        case 'totalLongBreakSeconds': currentValueB = appData.stats.general.totalLongBreakSeconds; break;
                    }
                    const progressB = b.threshold > 0 ? (currentValueB / b.threshold) : -1;
                    if (progressA > progressB) return -1;
                    if (progressA < progressB) return 1;
                    if (a.threshold < b.threshold) return -1;
                    if (a.threshold > b.threshold) return 1;
                    return 0;
                }
                if (!aIsUnlocked && bIsUnlocked && !bIsNewlyUnlocked) return -1;
                if (aIsUnlocked && !aIsNewlyUnlocked && !bIsUnlocked) return 1;
                if (aIsUnlocked && !aIsNewlyUnlocked && bIsUnlocked && !bIsNewlyUnlocked) {
                    return new Date(a.unlockedDate) - new Date(b.unlockedDate);
                }
                return 0;
            });
            appData.achievements.forEach(ach => {
                const isNew = justSeenAchievementIds.includes(ach.id);
                const newIndicatorHTML = isNew ? '<span class="ml-1 text-xs font-bold text-yellow-300 animate-pulse new-indicator">NEW!</span>' : '';
                const achEl = document.createElement('div');
                achEl.className = `achievement-item p-3 rounded-lg shadow-md transition-all ${ach.unlocked ? 'unlocked bg-sky-600' : 'locked bg-slate-600'} ${isNew ? 'ring-1 ring-yellow-400 ring-inset' : ''}`;
                let mainContentHTML = `<div class="flex items-start mb-1"><i class="${ach.icon || 'fas fa-question-circle'} text-xl ${ach.unlocked ? 'text-yellow-300' : 'text-slate-400'} mr-2 mt-1"></i><div class="flex-grow overflow-hidden"><div class="flex items-baseline"><h4 class="font-semibold text-sm ${ach.unlocked ? 'text-white' : 'text-sky-300'} truncate mr-1">${ach.name}</h4>${newIndicatorHTML}</div><p class="text-xs ${ach.unlocked ? 'text-sky-100' : 'text-slate-300'} leading-tight">${ach.description}</p></div></div>`;
                let progressSectionHTML = '<div class="mt-auto">';
                if (ach.unlocked) {
                    progressSectionHTML += `<div class="progress-bar-container"><div class="progress-bar bg-green-500" style="width: 100%;"></div></div><p class="text-xs text-yellow-200 font-semibold mt-1"><i class="fas fa-check-circle mr-1"></i>Unlocked on: ${new Date(ach.unlockedDate).toLocaleDateString()}</p>`;
                } else {
                    let currentValue = 0;
                    switch (ach.type) {
                        case 'totalDaysStudied': currentValue = appData.stats.general.totalDaysStudied; break;
                        case 'totalCyclesCompleted': currentValue = appData.stats.general.totalCyclesCompleted; break;
                        case 'totalPureStudyHours': currentValue = appData.stats.general.totalPureStudySeconds / 3600; break;
                        case 'streak': currentValue = appData.stats.general.streak; break;
                        case 'totalShortBreakSeconds': currentValue = appData.stats.general.totalShortBreakSeconds; break;
                        case 'totalLongBreakSeconds': currentValue = appData.stats.general.totalLongBreakSeconds; break;
                    }
                    let displayThreshold = ach.threshold, displayCurrentValue = currentValue;
                    if (ach.type === 'totalShortBreakSeconds' || ach.type === 'totalLongBreakSeconds') {
                        if (ach.threshold >= 3600) { displayCurrentValue = (currentValue / 3600).toFixed(1); displayThreshold = (ach.threshold / 3600).toFixed(1) + "h"; }
                        else { displayCurrentValue = (currentValue / 60).toFixed(0); displayThreshold = (ach.threshold / 60).toFixed(0) + "m"; }
                    } else if (ach.type === 'totalPureStudyHours') {
                        displayCurrentValue = currentValue.toFixed(1); displayThreshold = ach.threshold + "h";
                    } else {
                        displayCurrentValue = currentValue.toFixed(0); displayThreshold = ach.threshold;
                    }
                    const progressPercent = ach.threshold > 0 ? Math.min(100, (currentValue / ach.threshold) * 100) : 0;
                    progressSectionHTML += `<div class="progress-bar-container"><div class="progress-bar bg-sky-400" style="width: ${progressPercent.toFixed(2)}%;"></div></div><p class="text-xs text-slate-400 mt-1">Progress: ${displayCurrentValue} / ${displayThreshold}</p>`;
                }
                progressSectionHTML += '</div>';
                achEl.innerHTML = mainContentHTML + progressSectionHTML;
                achievementsListEl.appendChild(achEl);
            });
        }

        // --- Timer Logic ---
        function setTimer(mode) {
            appData.timerState.forcedBreakContextSession = null;
            currentMode = mode;
            isRunning = false;
            startPauseButton.innerHTML = '<i class="fas fa-play mr-2"></i>Start';
            if (timerWorker) timerWorker.postMessage({ command: 'pause' });
            switch (mode) {
                case 'study': timeLeft = appData.settings.studyTime * 60; break;
                case 'shortBreak': timeLeft = appData.settings.shortBreakTime * 60; break;
                case 'longBreak': timeLeft = appData.settings.longBreakTime * 60; break;
                default: console.error("Unknown mode in setTimer:", mode); timeLeft = appData.settings.studyTime * 60; currentMode = 'study';
            }
            if (timerWorker) timerWorker.postMessage({ command: 'setMode', mode: currentMode, duration: timeLeft });
            updateTimerDisplay();
            saveTimerState();
        }
        function startTimer() {
            if (timeLeft <= 0) {
                setTimer(currentMode);
                if (timeLeft <= 0) {
                    console.error(`startTimer: Cannot start timer for ${currentMode}, timeLeft is still ${timeLeft} after reset. Check settings.`);
                    startPauseButton.innerHTML = '<i class="fas fa-play mr-2"></i>Start';
                    isRunning = false;
                    return;
                }
            }
            isRunning = true;
            startPauseButton.innerHTML = '<i class="fas fa-pause mr-2"></i>Pause';
            if (timerWorker) timerWorker.postMessage({ command: 'start' });
            saveTimerState();
        }
        function pauseTimer() {
            isRunning = false;
            startPauseButton.innerHTML = '<i class="fas fa-play mr-2"></i>Resume';
            if (timerWorker) timerWorker.postMessage({ command: 'pause' });
            saveTimerState();
        }
        function handleTimerEnd() {
            isRunning = false;
            const endedMode = currentMode;
            appData.timerState.lastTimerUsed = endedMode;
            let notificationTitleForEndedMode = "", notificationBodyForEndedMode = "", soundNoteForEndedMode = 'C4';
            let nextModeToTransitionTo = null, showCycleCompleteNotification = false, completedTime = 0, shouldAutoStart = true;
            if (endedMode === 'study') {
                completedTime = appData.settings.studyTime * 60;
                appData.stats.daily.pureStudySeconds += completedTime;
                appData.stats.general.totalPureStudySeconds += completedTime;
                pomodorosInCycle++;
                notificationTitleForEndedMode = "Study Session Complete!";
                notificationBodyForEndedMode = "Time for a break. Good job!";
                soundNoteForEndedMode = 'C5';
                if (!appData.stats.daily.firstStudySessionCompletedToday) {
                    appData.stats.daily.firstStudySessionCompletedToday = true;
                    const todayStr = getTodayDateString();
                    if (appData.stats.general.lastStudyDate !== todayStr) {
                        appData.stats.general.totalDaysStudied++;
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        const yesterdayStr = `${yesterday.getFullYear()}-${String(yesterday.getMonth() + 1).padStart(2, '0')}-${String(yesterday.getDate()).padStart(2, '0')}`;
                        appData.stats.general.streak = appData.stats.general.lastStudyDate === yesterdayStr ? appData.stats.general.streak + 1 : 1;
                        appData.stats.general.lastStudyDate = todayStr;
                    }
                }
                if (pomodorosInCycle >= POMODOROS_PER_CYCLE) {
                    nextModeToTransitionTo = 'longBreak';
                    appData.stats.daily.cyclesCompleted++;
                    appData.stats.general.totalCyclesCompleted++;
                    showCycleCompleteNotification = true;
                } else {
                    nextModeToTransitionTo = 'shortBreak';
                }
            } else if (endedMode === 'shortBreak') {
                completedTime = appData.settings.shortBreakTime * 60;
                appData.stats.general.totalShortBreakSeconds += completedTime;
                notificationTitleForEndedMode = "Break Over!";
                notificationBodyForEndedMode = "Time to get back to focus!";
                soundNoteForEndedMode = 'E4';
                nextModeToTransitionTo = 'study';
            } else if (endedMode === 'longBreak') {
                completedTime = appData.settings.longBreakTime * 60;
                appData.stats.general.totalLongBreakSeconds += completedTime;
                notificationTitleForEndedMode = "Long Break Over!";
                notificationBodyForEndedMode = "Cycle complete! Ready for a new one?";
                soundNoteForEndedMode = 'E4';
                pomodorosInCycle = 0;
                nextModeToTransitionTo = 'study';
                shouldAutoStart = false;
            }
            if (completedTime > 0) {
                appData.stats.daily.totalTimeTodaySeconds += completedTime;
            }
            updateStatsDisplay();
            checkRewards();
            checkAchievements();
            saveData();
            playSound(soundNoteForEndedMode, '4n', 'timerComplete');
            showToast(notificationTitleForEndedMode, notificationBodyForEndedMode, 'info');
            if (showCycleCompleteNotification) {
                showToast("Cycle Complete!", "Congratulations! You've completed a full Pomodoro cycle.", 'success', 5000);
            }
            if (nextModeToTransitionTo) {
                setTimer(nextModeToTransitionTo);
                if (shouldAutoStart) startTimer();
            } else {
                startPauseButton.innerHTML = '<i class="fas fa-play mr-2"></i>Start';
            }
        }
        function resetCurrentTimer() {
            if (isRunning && timerWorker) timerWorker.postMessage({ command: 'pause' });
            isRunning = false;
            let newTimeLeft;
            switch(currentMode) {
                case 'study': newTimeLeft = appData.settings.studyTime * 60; break;
                case 'shortBreak': newTimeLeft = appData.settings.shortBreakTime * 60; break;
                case 'longBreak': newTimeLeft = appData.settings.longBreakTime * 60; break;
                default: newTimeLeft = appData.settings.studyTime * 60;
            }
            timeLeft = newTimeLeft;
            if (timerWorker) timerWorker.postMessage({ command: 'setMode', mode: currentMode, duration: timeLeft });
            startPauseButton.innerHTML = '<i class="fas fa-play mr-2"></i>Start';
            updateTimerDisplay();
            saveTimerState();
        }

        // --- Stats, Rewards, Achievements Logic & Event Listeners ---
        function resetDailyStats() {
            appData.stats.daily = { date: getTodayDateString(), cyclesCompleted: 0, pureStudySeconds: 0, totalTimeTodaySeconds: 0, firstStudySessionCompletedToday: false };
            appData.rewards.forEach(reward => { reward.earnedToday = false; reward.notificationShown = false; reward.seen = false; });
            appData.achievements.forEach(ach => { ach.seen = ach.unlocked; });
            appData.uiState.newRewardsCount = 0;
            appData.uiState.newAchievementsCount = 0;
            updateRewardTabNotificationBadge();
            updateAchievementTabNotificationBadge();
            pomodorosInCycle = 0;
            appData.timerState.forcedBreakContextSession = null;
        }
        addRewardButton.addEventListener('click', () => {
            const name = rewardNameInput.value.trim();
            const type = rewardTypeSelect.value;
            const threshold = parseFloat(rewardThresholdInput.value);
            if (!name || isNaN(threshold) || threshold < 0) {
                showToast("Error", "Please fill in all reward fields correctly. Value must be 0 or greater.", "error");
                return;
            }
            appData.rewards.push({ id: generateUUID(), name, type, threshold, earnedToday: false, notificationShown: false, seen: false });
            rewardNameInput.value = '';
            rewardThresholdInput.value = '';
            saveData();
            renderRewards();
        });
        function checkRewards() {
            let newRewardEarnedThisCheck = false;
            appData.rewards.forEach(reward => {
                if (reward.earnedToday && reward.notificationShown && reward.seen) return;
                let currentProgress = reward.type === 'cycles' ? appData.stats.daily.cyclesCompleted : appData.stats.daily.pureStudySeconds / 3600;
                if (currentProgress >= reward.threshold && !reward.earnedToday) {
                    reward.earnedToday = true;
                    reward.seen = false;
                    newRewardEarnedThisCheck = true;
                    if (!reward.notificationShown) {
                        showToast("Reward Earned!", `You earned the reward: "${reward.name}"!`, 'success');
                        playSound('G5', '2n', 'reward');
                        reward.notificationShown = true;
                    }
                }
            });
            if (newRewardEarnedThisCheck) {
                renderRewards();
                updateRewardTabNotificationBadge();
                saveData();
            }
        }
        function checkAchievements() {
            let newAchievementUnlockedThisCheck = false;
            appData.achievements.forEach(ach => {
                if (ach.unlocked && ach.notificationShown && ach.seen) return;
                let currentValue;
                switch (ach.type) {
                    case 'totalDaysStudied': currentValue = appData.stats.general.totalDaysStudied; break;
                    case 'totalCyclesCompleted': currentValue = appData.stats.general.totalCyclesCompleted; break;
                    case 'totalPureStudyHours': currentValue = appData.stats.general.totalPureStudySeconds / 3600; break;
                    case 'streak': currentValue = appData.stats.general.streak; break;
                    case 'totalShortBreakSeconds': currentValue = appData.stats.general.totalShortBreakSeconds; break;
                    case 'totalLongBreakSeconds': currentValue = appData.stats.general.totalLongBreakSeconds; break;
                    default: return;
                }
                if (currentValue >= ach.threshold && !ach.unlocked) {
                    ach.unlocked = true;
                    ach.unlockedDate = new Date().toISOString();
                    ach.seen = false;
                    newAchievementUnlockedThisCheck = true;
                    if (!ach.notificationShown) {
                        showToast("Achievement Unlocked!", `You unlocked the achievement: "${ach.name}"!`, 'success');
                        playSound('A5', '1n', 'achievement');
                        ach.notificationShown = true;
                    }
                }
            });
            if (newAchievementUnlockedThisCheck) {
                renderAchievements();
                updateAchievementTabNotificationBadge();
                saveData();
            }
        }
        startPauseButton.addEventListener('click', () => { isRunning ? pauseTimer() : startTimer(); });
        resetButton.addEventListener('click', resetCurrentTimer);
        resetCycleCountButtonEl.addEventListener('click', () => {
            showCustomAlert("Confirm Reset", "Are you sure you want to reset the current cycle? This will set the Study Session to 1/4 and pause the timer.", "fas fa-exclamation-triangle text-yellow-400", "Confirm", "Cancel", () => {
                if (isRunning) pauseTimer();
                pomodorosInCycle = 0;
                appData.timerState.forcedBreakContextSession = null;
                setTimer('study');
                saveData();
                console.log("Study cycle count reset to 1/4 and timer set to Study mode (paused).");
            }, () => { console.log("Study cycle reset cancelled."); });
        });
        helpButton.addEventListener('click', () => {
            const helpText = `<p class="mb-3">The <strong>Pomodoro Technique</strong> is a time management method that uses a timer to break down work into intervals, traditionally 25 minutes in length, separated by short breaks.</p><p class="mb-1 font-semibold">This Timer's Cycle:</p><ul><li class="study-session" style="--session-number: '1.'">Study Session (e.g., 25 min)</li><li class="break-session" style="padding-left: 35px;">Short Break (e.g., 5 min)</li><li class="study-session" style="--session-number: '2.'">Study Session</li><li class="break-session" style="padding-left: 35px;">Short Break</li><li class="study-session" style="--session-number: '3.'">Study Session</li><li class="break-session" style="padding-left: 35px;">Short Break</li><li class="study-session" style="--session-number: '4.'">Study Session (completes 1 Pomodoro cycle)</li><li class="break-session" style="padding-left: 35px;">Long Break (e.g., 15 min)</li></ul><p class="mb-3">Study sessions and breaks begin automatically. After the long break, however, you'll need to start the new cycle manually.</p><p class="mb-3">The study streak only increases after completing the first study session of the day.</p><p>Reset the current cycle using the <i class='fas fa-sync-alt fa-xs'></i> button.</p>`;
            showCustomAlert("How This Pomodoro Timer Works", helpText, "fas fa-question-circle text-sky-400", "Got it!");
        });
        skipBreakButton.addEventListener('click', () => {
            if (currentMode === 'shortBreak' || currentMode === 'longBreak') {
                const skippedMode = currentMode;
                if (timerWorker) timerWorker.postMessage({ command: 'pause' });
                isRunning = false;
                let nextModeAfterSkip = 'study';
                if (skippedMode === 'longBreak') pomodorosInCycle = 0;
                appData.timerState.forcedBreakContextSession = null;
                appData.timerState.persistedPreviousPomodorosInCycle = null;
                appData.timerState.lastTimerUsed = skippedMode;
                setTimer(nextModeAfterSkip);
            }
        });
        settingsButton.addEventListener('click', () => settingsModal.classList.add('show'));
        cancelSettingsButton.addEventListener('click', () => {
            studyTimeInput.value = appData.settings.studyTime;
            shortBreakTimeInput.value = appData.settings.shortBreakTime;
            longBreakTimeInput.value = appData.settings.longBreakTime;
            soundToggle.checked = appData.settings.soundEnabled;
            settingsModal.classList.remove('show');
        });
        saveSettingsButton.addEventListener('click', () => {
            settingsModal.classList.remove('show');
            const newStudyTime = parseInt(studyTimeInput.value), newShortBreakTime = parseInt(shortBreakTimeInput.value), newLongBreakTime = parseInt(longBreakTimeInput.value);
            const oldStudyTime = appData.settings.studyTime, oldShortBreakTime = appData.settings.shortBreakTime, oldLongBreakTime = appData.settings.longBreakTime;
            let settingsChanged = false;
            if (!isNaN(newStudyTime) && newStudyTime >= 1 && appData.settings.studyTime !== newStudyTime) { appData.settings.studyTime = newStudyTime; settingsChanged = true; }
            if (!isNaN(newShortBreakTime) && newShortBreakTime >= 1 && appData.settings.shortBreakTime !== newShortBreakTime) { appData.settings.shortBreakTime = newShortBreakTime; settingsChanged = true; }
            if (!isNaN(newLongBreakTime) && newLongBreakTime >= 1 && appData.settings.longBreakTime !== newLongBreakTime) { appData.settings.longBreakTime = newLongBreakTime; settingsChanged = true; }
            if (appData.settings.soundEnabled !== soundToggle.checked) { appData.settings.soundEnabled = soundToggle.checked; settingsChanged = true; }
            if (settingsChanged) {
                saveData();
                if (timerWorker) timerWorker.postMessage({ command: 'updateSettings', settings: appData.settings });
                if (!isRunning) {
                    let durationChangedForCurrentMode = false;
                    if (currentMode === 'study' && oldStudyTime !== appData.settings.studyTime) durationChangedForCurrentMode = true;
                    if (currentMode === 'shortBreak' && oldShortBreakTime !== appData.settings.shortBreakTime) durationChangedForCurrentMode = true;
                    if (currentMode === 'longBreak' && oldLongBreakTime !== appData.settings.longBreakTime) durationChangedForCurrentMode = true;
                    let fullDurationForCurrentModeBeforeChange;
                    switch(currentMode) {
                        case 'study': fullDurationForCurrentModeBeforeChange = oldStudyTime * 60; break;
                        case 'shortBreak': fullDurationForCurrentModeBeforeChange = oldShortBreakTime * 60; break;
                        case 'longBreak': fullDurationForCurrentModeBeforeChange = oldLongBreakTime * 60; break;
                        default: fullDurationForCurrentModeBeforeChange = oldStudyTime * 60;
                    }
                    if (durationChangedForCurrentMode || timeLeft === 0 || timeLeft === fullDurationForCurrentModeBeforeChange) {
                        setTimer(currentMode);
                    } else {
                        saveTimerState();
                    }
                } else {
                    saveTimerState();
                }
                showToast("Settings Saved", "Your new timer durations have been applied.", "success");
            }
        });
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                justSeenRewardIds = []; justSeenAchievementIds = [];
                const targetTab = button.dataset.tab;
                tabButtons.forEach(btn => {
                    btn.classList.remove('active', 'text-sky-400', 'border-sky-400');
                    btn.classList.add('text-slate-400', 'border-transparent');
                });
                button.classList.add('active', 'text-sky-400', 'border-sky-400');
                button.classList.remove('text-slate-400', 'border-transparent');
                tabPanes.forEach(pane => {
                    pane.style.display = pane.id === `${targetTab}Content` ? 'block' : 'none';
                });
                if (targetTab === 'rewards') {
                    appData.rewards.forEach(r => { if (r.earnedToday && !r.seen) justSeenRewardIds.push(r.id); if (r.earnedToday) r.seen = true; });
                    appData.uiState.newRewardsCount = 0;
                    updateRewardTabNotificationBadge();
                } else if (targetTab === 'achievements') {
                    appData.achievements.forEach(ach => { if (ach.unlocked && !ach.seen) justSeenAchievementIds.push(ach.id); if (ach.unlocked) ach.seen = true; });
                    appData.uiState.newAchievementsCount = 0;
                    updateAchievementTabNotificationBadge();
                }
                saveData();
                renderRewards();
                renderAchievements();
                updateStatsDisplay();
            });
        });

        // --- Web Worker Setup ---
        let timerWorker;
        if (window.Worker) {
            try {
                const workerScript = document.getElementById('timerWorkerScript').textContent;
                const blob = new Blob([workerScript], { type: 'application/javascript' });
                timerWorker = new Worker(URL.createObjectURL(blob));
                timerWorker.onmessage = function(e) {
                    const { type, timeLeft: workerTimeLeftUpdate, mode: workerMode } = e.data;
                    if (type === 'tick') {
                        timeLeft = workerTimeLeftUpdate;
                        if (currentMode === workerMode) updateTimerDisplay();
                    } else if (type === 'end') {
                        if (currentMode === workerMode) handleTimerEnd();
                    } else if (type === 'modeSet') {
                        timeLeft = workerTimeLeftUpdate;
                        updateTimerDisplay();
                    }
                };
                timerWorker.onerror = function(error) { console.error('Worker Error:', error); timerWorker = null; };
            } catch (e) {
                console.error('Error creating worker:', e);
                timerWorker = null;
            }
        } else {
            console.warn('Web Workers not supported. Timer will run on main thread.');
        }

        // --- Initialization ---
        function initializeApp() {
            loadData();
            const todayStrInitialize = getTodayDateString();
            if (appData.stats.general.lastStudyDate && appData.stats.general.lastStudyDate !== todayStrInitialize) {
                const lastStudy = new Date(appData.stats.general.lastStudyDate), today = new Date(todayStrInitialize), yesterday = new Date(today);
                yesterday.setDate(today.getDate() - 1);
                lastStudy.setHours(0, 0, 0, 0);
                yesterday.setHours(0, 0, 0, 0);
                if (lastStudy.getTime() < yesterday.getTime()) {
                    appData.stats.general.streak = 0;
                    console.log("Streak reset to 0 due to inactivity upon app load.");
                }
            }
            if (appData.stats.daily.date !== getTodayDateString()) {
                resetDailyStats();
                if (appData.timerState) {
                    appData.timerState.persistedCurrentMode = 'study';
                    appData.timerState.persistedTimeLeft = appData.settings.studyTime * 60;
                    appData.timerState.persistedIsRunning = false;
                    appData.timerState.persistedPomodorosInCycle = 0;
                    appData.timerState.forcedBreakContextSession = null;
                }
                saveData();
            }
            let initialMode = 'study', initialTimeLeft = appData.settings.studyTime * 60, initialPomodorosInCycle = 0;
            if (appData.timerState && typeof appData.timerState.persistedTimeLeft === 'number' && !isNaN(appData.timerState.persistedTimeLeft) && appData.timerState.persistedCurrentMode && ['study', 'shortBreak', 'longBreak'].includes(appData.timerState.persistedCurrentMode)) {
                initialMode = appData.timerState.persistedCurrentMode;
                initialTimeLeft = appData.timerState.persistedTimeLeft;
                initialPomodorosInCycle = typeof appData.timerState.persistedPomodorosInCycle === 'number' ? appData.timerState.persistedPomodorosInCycle : 0;
            }
            currentMode = initialMode;
            timeLeft = initialTimeLeft;
            isRunning = false;
            pomodorosInCycle = initialPomodorosInCycle;
            if (timerWorker) {
                timerWorker.postMessage({ command: 'updateSettings', settings: appData.settings });
                timerWorker.postMessage({ command: 'setMode', mode: currentMode, duration: timeLeft });
            }
            updateTimerDisplay();
            let fullDurationForMode;
            switch(currentMode) {
                case 'study': fullDurationForMode = appData.settings.studyTime * 60; break;
                case 'shortBreak': fullDurationForMode = appData.settings.shortBreakTime * 60; break;
                case 'longBreak': fullDurationForMode = appData.settings.longBreakTime * 60; break;
                default: fullDurationForMode = appData.settings.studyTime * 60;
            }
            if (appData.timerState.persistedIsRunning && timeLeft > 0) {
                isRunning = true;
                startPauseButton.innerHTML = '<i class="fas fa-pause mr-2"></i>Pause';
                if (timerWorker) timerWorker.postMessage({ command: 'start' });
            } else if (timeLeft < fullDurationForMode && timeLeft > 0) {
                startPauseButton.innerHTML = '<i class="fas fa-play mr-2"></i>Resume';
            } else {
                startPauseButton.innerHTML = '<i class="fas fa-play mr-2"></i>Start';
            }
            updateStatsDisplay();
            renderRewards();
            renderAchievements();
            updateRewardTabNotificationBadge();
            updateAchievementTabNotificationBadge();
        }
        window.addEventListener('beforeunload', saveTimerState);
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
<head>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            font-family: 'Inter', sans-serif;
        }

        .donation-section {
            text-align: center;
            font-size: 0.75em;
            color: #5a687d;
            margin-top: 20px;
            max-width: 300px;
            opacity: 0.75;
            line-height: 1.4;
        }

        .donation-section a {
            color: #5a687d;
            text-decoration: none;
            white-space: nowrap;
            transition: color 0.3s ease;
        }

        .donation-section a:hover {
            color: #FFDD00;
        }
    </style>
</head>
<body>
    
    <div class="donation-section">
        <p>If you'd like to support this app, you can do so <a href="https://www.buymeacoffee.com/lemonade299792458" target="_blank">here ‚òï</a></p>
    </div>
    
</body>
</html>
