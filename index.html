<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PomodoroCycle Timer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
    <link id="favicon" rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text x="50" y="50" font-size="90" dominant-baseline="middle" text-anchor="middle">üçÖ</text></svg>'>
    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.5s ease; overflow-y: scroll; }
        .timer-text { font-family: 'Roboto Mono', monospace; font-size: 5rem; line-height: 1; letter-spacing: -0.05em; font-weight: 700; }
        @media (min-width: 640px) { .timer-text { font-size: 6rem; } }
        .tab-button { position: relative; border-bottom: 4px solid transparent; min-height: 54px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease-in-out; }
        .tab-button.active { border-bottom-color: #38bdf8; }
        #tabContent { height: 21rem; overflow: hidden; transition: height 0.35s ease-in-out; }
        .tab-pane { display: flex; flex-direction: column; width: 100%; height: 100%; }
        #tabContent.collapsed { height: 0; }
        #achievementsListContainer { max-height: 17rem; overflow-y: auto; padding-right: 0.5rem; }
        #achievementsContent { padding-bottom: 1rem; }
        .achievement-item { display: flex; flex-direction: column; justify-content: space-between; overflow: hidden; position: relative; min-height: 7rem; }
        .progress-bar-container { width: 100%; background-color: #334155; height: 6px; border-radius: 3px; overflow: hidden; }
        .progress-bar { height: 100%; transition: width 0.4s ease-in-out; border-radius: 3px; }
        .modal { display: none; }
        .modal.show { display: flex; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #475569; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }
        @keyframes gradient-flow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        #goalProgressBar { background: linear-gradient(90deg, #06b6d4, #38bdf8, #06b6d4); background-size: 200% 200%; animation: gradient-flow 3s ease infinite; transition: width 0.5s cubic-bezier(0.25, 1, 0.5, 1); }
        #goalProgressBar.completed { box-shadow: 0 0 15px #38bdf8, 0 0 5px #06b6d4; }
        .help-content ul { list-style-type: none; padding-left: 0; margin-bottom: 10px; }
        .help-content li { margin-bottom: 5px; }
        .help-content li.break-session { color: #a0aec0; }
        #toastNotification { position: fixed; top: 20px; right: 20px; padding: 1rem; border-radius: 0.5rem; color: white; font-size: 0.875rem; z-index: 1000; opacity: 0; transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out; max-width: 300px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transform: translateX(100%); }
        #toastNotification.show { opacity: 1; transform: translateX(0); }
        #toastNotification.success { background-color: #34d399; }
        #toastNotification.error { background-color: #ef4444; }
        #toastNotification.info { background-color: #3b82f6; }
        #toastNotification.warning { background-color: #f59e0b; }
        .tab-badge { position: absolute; top: 0.2rem; right: 0.2rem; height: 0.65rem; width: 0.65rem; background-color: #ef4444; border-radius: 9999px; display: none; }
        .new-indicator { font-size: 0.65rem; padding: 0.1rem 0.3rem; border-radius: 0.25rem; line-height: 1; }
        .cycle-dot { width: 0.75rem; height: 0.75rem; border-radius: 9999px; transition: all 0.3s ease; }
        @media (max-width: 639px) {
            #tabContent { height: 20rem; }
            .tab-button { flex-direction: column; padding-top: 0.5rem; padding-bottom: 0.5rem; font-size: 0.75rem; line-height: 1.2; min-height: 58px; }
            .tab-button i { margin-right: 0; margin-bottom: 0.25rem; font-size: 1rem; }
            .stats-grid-container { gap: 1rem; }
            #statsContent h4 { font-size: 1rem; }
            .stats-text-size { font-size: 0.875rem; }
            .stats-text-size > p { margin-bottom: 0.25rem; }
            .stats-bottom-warning { padding-bottom: 0.5rem; }
        }
        .donation-section { text-align: center; font-size: 0.75em; color: #5a687d; margin-top: 20px; max-width: 320px; opacity: 0.75; line-height: 1.4; }
        .donation-section a { color: #5a687d; text-decoration: none; white-space: nowrap; transition: color 0.3s ease; }
        .donation-section a:hover { color: #FFDD00; }
        #goalProgressText { font-family: 'Inter', sans-serif; }
        #statsContent { overflow-y: auto; overflow-x: hidden; }
        #goalEditView { overflow-y: auto; padding-bottom: 0.5rem; }
        /* CORRE√á√ÉO: Margem inferior do seletor de modo reduzida */
        .goal-mode-selector { display: flex; border-radius: 0.5rem; border: 1px solid #475569; overflow: hidden; margin-bottom: 1rem; }
        .goal-mode-selector label { flex: 1; padding: 0.75rem 0.5rem; text-align: center; cursor: pointer; transition: background-color 0.2s ease-in-out; font-size: 0.8rem; color: #cbd5e1; position: relative; line-height: 1.2; }
        .goal-mode-selector input[type=radio] { display: none; }
        .goal-mode-selector input[type=radio]:checked+label { background-color: #38bdf8; color: #fff; font-weight: 600; }
        .goal-mode-selector label:not(:last-child) { border-right: 1px solid #475569; }
        .custom-day-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(60px,1fr)); gap: .75rem; }
        .custom-day-input-group { text-align: center; }
        .custom-day-input-group label { font-size: .75rem; color: #94a3b8; }
    </style>
</head>
<body class="bg-slate-900 text-white flex flex-col items-center min-h-screen p-4 selection:bg-sky-400 selection:text-sky-900">

    <div id="languageModal" class="modal fixed inset-0 bg-slate-900 bg-opacity-95 items-center justify-center p-4 z-[200]">
        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl w-full max-w-lg text-center">
            <h2 class="text-2xl font-bold mb-2 text-sky-300">Select Your Language</h2>
            <p class="text-slate-400 mb-6">Choose your preferred language to continue.</p>
            <div id="languageButtonsContainer" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
            </div>
            <p class="text-xs text-slate-500 mt-6"><i class="fas fa-info-circle fa-fw mr-1.5 opacity-70"></i>You can change this choice later in the settings.</p>
        </div>
    </div>

    <div id="app-container" class="w-full hidden">
        <div class="w-full max-w-3xl mx-auto bg-slate-800 shadow-2xl rounded-lg p-4 sm:p-6 relative mt-4 mb-4">
            <div class="absolute top-4 sm:top-6 left-4 sm:left-6 z-10">
                <button id="helpButton" data-translate-key="help_tooltip" title="Help / How to Use" class="p-2 rounded-full text-sky-400 hover:bg-slate-700 hover:text-sky-300 transition-colors focus:outline-none">
                    <i class="fas fa-question-circle text-xl"></i>
                </button>
            </div>
            <div class="absolute top-4 sm:top-6 right-4 sm:right-6 z-10">
                <button id="settingsButton" data-translate-key="settings_tooltip" title="Settings" class="p-2 rounded-full hover:bg-slate-700 transition-colors focus:outline-none">
                    <i class="fas fa-cog text-xl text-sky-400 hover:text-sky-300"></i>
                </button>
            </div>

            <div id="timerDisplay" class="relative text-center mb-6 pt-8 md:pt-4 pb-4 rounded-lg bg-slate-700 shadow-inner">
                <div id="modeIndicator" class="h-8 flex items-center justify-center mb-2 text-slate-300 font-medium">
                    <span data-translate-key="current_timer_label">Current Timer:</span>&nbsp;
                    <span id="modePill" class="py-1 px-3 rounded-full text-sm font-semibold transition-all duration-500" data-translate-key="mode_study">Focus</span>
                </div>
                <p id="timerText" class="timer-text text-sky-400 transition-colors duration-500">25:00</p>
                <div class="flex justify-center items-center mt-4 h-8">
                    <div id="cycleDotsContainer" data-translate-key="cycle_tooltip" title="Focus Sessions in Current Cycle" class="flex items-center justify-center space-x-2.5">
                        <div class="cycle-dot"></div>
                        <div class="cycle-dot"></div>
                        <div class="cycle-dot"></div>
                        <div class="cycle-dot"></div>
                    </div>
                    <button id="resetCycleCountButton" data-translate-key="reset_cycle_tooltip" title="Reset Cycle" class="ml-3 text-slate-500 hover:text-sky-400 transition-colors focus:outline-none focus:ring-0 text-[11px]">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <button id="skipBreakButton" class="absolute bottom-3 right-3 hidden bg-slate-600 hover:bg-slate-500 text-slate-300 text-xs py-1.5 px-3 rounded-md shadow-md transition-colors">
                    <i class="fas fa-forward fa-xs mr-1"></i><span data-translate-key="skip_break_button">Skip Break</span>
                </button>
            </div>

            <div class="flex justify-center items-center space-x-4 mb-8">
                <button id="startPauseButton" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-transform transform hover:scale-105">
                    <i class="fas fa-play mr-2"></i><span data-translate-key="start_button">Start</span>
                </button>
                <button id="resetButton" class="bg-slate-600 hover:bg-slate-500 text-slate-300 py-2 px-4 rounded-lg shadow-md transition-colors text-xs">
                    <i class="fas fa-undo fa-sm mr-1"></i><span data-translate-key="reset_current_button">Reset Current</span>
                </button>
            </div>

            <div class="mb-6 border-b border-slate-700">
                <nav class="flex space-x-1 -mb-px">
                    <button data-tab="stats" class="tab-button active text-sky-400 py-3 px-3 md:px-4 text-sm md:text-base font-medium text-center hover:text-sky-300 transition-colors">
                        <i class="fas fa-chart-line mr-2"></i><span data-translate-key="tab_stats">Statistics</span>
                    </button>
                    <button data-tab="dailyGoal" class="tab-button text-slate-400 py-3 px-3 md:px-4 text-sm md:text-base font-medium text-center hover:text-sky-300 transition-colors">
                        <i class="fas fa-bullseye mr-2"></i><span data-translate-key="tab_daily_goal">Daily Goal</span> <span id="rewardsTabBadge" class="tab-badge"></span>
                    </button>
                    <button data-tab="achievements" class="tab-button text-slate-400 py-3 px-3 md:px-4 text-sm md:text-base font-medium text-center hover:text-sky-300 transition-colors">
                        <i class="fas fa-trophy mr-2"></i><span data-translate-key="tab_achievements">Achievements</span> <span id="achievementsTabBadge" class="tab-badge"></span>
                    </button>
                    <div class="flex-grow"></div>
                    <button id="collapseTabsButton" title="Collapse/Expand Tabs" class="py-3 px-3 md:px-4 text-slate-400 hover:text-sky-300 transition-colors">
                        <i id="collapseIcon" class="fas fa-chevron-up"></i>
                    </button>
                </nav>
            </div>

            <div id="tabContent">
                <div id="statsContent" class="tab-pane active p-2 sm:p-4 bg-slate-700 rounded-b-lg justify-center">
                    <div class="w-full flex flex-col h-full">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                            <h3 class="text-base sm:text-lg font-semibold text-sky-300 mb-2 sm:mb-0" data-translate-key="stats_title">Your Statistics</h3>
                            <p id="streakContainerHeader" class="text-sm text-slate-300">
                                <span data-translate-key="stats_streak">Daily Streak</span>: <span id="streakCounterHeader" class="font-semibold">0</span> <span id="streakFireIconContainer"><i class="fas fa-fire"></i></span>
                            </p>
                        </div>
                        <div class="flex-grow flex justify-center items-center">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl mx-auto stats-grid-container">
                                <div class="bg-slate-600 p-5 rounded-lg shadow">
                                    <h4 class="font-bold text-sky-400 mb-3 text-lg flex items-center"><i class="fas fa-chart-simple mr-2 opacity-80"></i><span data-translate-key="stats_general_title">General:</span></h4>
                                    <div class="stats-text-size space-y-3">
                                        <p><span data-translate-key="stats_general_days">Total Focus Days</span>: <span id="totalDaysStudied" class="font-semibold">0</span></p>
                                        <p><span data-translate-key="stats_general_study_time">Total Focus Time</span>: <span id="totalStudyTime" class="font-semibold">0h 0m</span></p>
                                        <p><span data-translate-key="stats_general_sessions">Total Focus Sessions</span>: <span id="totalFocusSessions" class="font-semibold">0</span></p>
                                        <p><span data-translate-key="stats_general_cycles">Total Cycles Completed</span>: <span id="totalCycles" class="font-semibold">0</span></p>
                                    </div>
                                </div>
                                <div class="bg-slate-600 p-5 rounded-lg shadow">
                                    <h4 class="font-bold text-sky-400 mb-3 text-lg flex items-center"><i class="fas fa-calendar-day mr-2 opacity-80"></i><span data-translate-key="stats_daily_title">Daily:</span></h4>
                                    <div class="stats-text-size space-y-3">
                                        <p><span data-translate-key="stats_daily_total_time">Total Time Today</span>: <span id="dailyTotalTime" class="font-semibold">0h 0m</span></p>
                                        <p><span data-translate-key="stats_daily_study_time">Focus Time Today</span>: <span id="dailyStudyTime" class="font-semibold">0h 0m</span></p>
                                        <p><span data-translate-key="stats_daily_focus_sessions">Focus Sessions Today</span>: <span id="dailyFocusSessions" class="font-semibold">0</span></p>
                                        <p><span data-translate-key="stats_daily_cycles">Cycles Completed Today</span>: <span id="dailyCycles" class="font-semibold">0</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-auto pt-4 text-center stats-bottom-warning">
                            <p class="text-xs text-slate-400">
                                <i class="fas fa-info-circle mr-1"></i><span data-translate-key="storage_warning">Your progress is saved in your browser's local storage. Clearing browser data may delete your progress.</span>
                            </p>
                        </div>
                    </div>
                </div>
                <div id="dailyGoalContent" class="tab-pane hidden p-2 sm:p-4 bg-slate-700 rounded-b-lg justify-between">
                    <div id="goalDisplayView" class="h-full flex flex-col">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-base sm:text-lg font-semibold text-sky-300" data-translate-key="daily_goal_title">Today's Goal</h3>
                            <button id="editGoalButton" class="text-sm text-sky-400 hover:text-sky-300"><i class="fas fa-edit mr-1"></i> <span data-translate-key="edit_goal_button">Edit Goal</span></button>
                        </div>
                        <div id="goalProgressContainer" class="bg-slate-600 p-4 rounded-lg mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <p id="goalText" class="font-semibold text-base leading-tight"></p>
                                <p id="goalProgressText" class="text-sm text-slate-300"></p>
                            </div>
                            <div class="w-full bg-slate-800/70 rounded-full h-3 shadow-inner">
                                <div id="goalProgressBar" class="h-3 rounded-full"></div>
                            </div>
                        </div>
                        <div class="relative flex-grow min-h-0">
                            <canvas id="goalHistoryChart"></canvas>
                        </div>
                    </div>
                    <div id="goalEditView" class="hidden flex flex-col items-center p-2 pt-4">
                        <div class="w-full max-w-sm">
                            <h3 class="text-lg font-semibold mb-3 text-sky-300 text-center" data-translate-key="set_goal_title">Set Your Daily Goal</h3>
                            <div id="goalModeSelector" class="goal-mode-selector">
                                <input type="radio" id="goalModeAllDays" name="goalMode" value="all_days" checked>
                                <label for="goalModeAllDays" data-translate-key="goal_mode_all">All Days</label>
                                <input type="radio" id="goalModeWeekend" name="goalMode" value="weekend">
                                <label for="goalModeWeekend" data-translate-key="goal_mode_week_weekend">Week/Weekend</label>
                                <input type="radio" id="goalModeCustom" name="goalMode" value="custom">
                                <label for="goalModeCustom" data-translate-key="goal_mode_custom">Custom Days</label>
                            </div>
                            <div id="goalInputsAllDays" class="space-y-4">
                                <div>
                                    <label for="goalValueInputAll" class="block text-sm font-medium text-slate-300 mb-1" data-translate-key="goal_sessions_per_day">Sessions per day:</label>
                                    <input type="number" id="goalValueInputAll" min="1" class="w-full p-2 rounded bg-slate-600 text-white border border-slate-500 focus:ring-sky-500 focus:border-sky-500">
                                </div>
                            </div>
                            <div id="goalInputsWeekend" class="hidden space-y-3">
                                <div>
                                    <label for="goalValueInputWeekday" class="block text-sm font-medium text-slate-300 mb-1" data-translate-key="goal_sessions_weekdays">Sessions on Weekdays:</label>
                                    <input type="number" id="goalValueInputWeekday" min="1" class="w-full p-2 rounded bg-slate-600 text-white border border-slate-500 focus:ring-sky-500 focus:border-sky-500">
                                </div>
                                <div>
                                    <label for="goalValueInputWeekend" class="block text-sm font-medium text-slate-300 mb-1" data-translate-key="goal_sessions_weekends">Sessions on Weekends:</label>
                                    <input type="number" id="goalValueInputWeekend" min="1" class="w-full p-2 rounded bg-slate-600 text-white border border-slate-500 focus:ring-sky-500 focus:border-sky-500">
                                </div>
                            </div>
                            <div id="goalInputsCustom" class="hidden space-y-4">
                                <div class="custom-day-grid">
                                </div>
                            </div>
                             <div class="flex justify-end space-x-2 pt-4">
                                <button id="cancelGoalButton" class="bg-slate-600 hover:bg-slate-500 text-slate-300 font-bold py-2 px-4 rounded transition-colors" data-translate-key="cancel_button">Cancel</button>
                                <button id="saveGoalButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition-colors" data-translate-key="save_goal_button">Save Goal</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="achievementsContent" class="tab-pane hidden p-2 sm:p-4 bg-slate-700 rounded-b-lg">
                    <div class="flex-grow flex flex-col min-h-0">
                        <h3 class="text-base sm:text-lg font-semibold mb-4 text-sky-300" data-translate-key="achievements_title">Your Achievements</h3>
                        <div id="achievementsListContainer">
                            <div id="achievementsList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="donation-section mx-auto">
             <p data-translate-key="donation_text">If you'd like to support this app, you can do so <a href="https://www.buymeacoffee.com/lemonade299792458" target="_blank">here ‚òï</a></p>
        </div>
    </div>

    <div id="settingsModal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-50 max-h-screen overflow-y-auto md:overflow-y-visible">
        <div class="bg-slate-800 p-6 rounded-2xl shadow-2xl w-full max-w-md my-8">
            <div class="p-4 bg-slate-700 rounded-lg mb-4">
                <h3 class="text-lg font-semibold mb-3 text-sky-400" data-translate-key="settings_section_timer">Timer Durations</h3>
                <div class="space-y-3">
                    <div>
                        <label for="studyTimeInput" class="block text-sm font-medium text-slate-300 mb-1" data-translate-key="settings_study_time">Focus Time (minutes):</label>
                        <input type="number" id="studyTimeInput" min="1" class="w-full p-2 bg-slate-600 border border-slate-500 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500">
                    </div>
                    <div>
                        <label for="shortBreakTimeInput" class="block text-sm font-medium text-slate-300 mb-1" data-translate-key="settings_short_break">Short Break (minutes):</label>
                        <input type="number" id="shortBreakTimeInput" min="1" class="w-full p-2 bg-slate-600 border border-slate-500 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500">
                    </div>
                    <div>
                        <label for="longBreakTimeInput" class="block text-sm font-medium text-slate-300 mb-1" data-translate-key="settings_long_break">Long Break (minutes):</label>
                        <input type="number" id="longBreakTimeInput" min="1" class="w-full p-2 bg-slate-600 border border-slate-500 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500">
                    </div>
                </div>
            </div>
            <div class="p-4 bg-slate-700 rounded-lg mb-4">
                <h3 class="text-lg font-semibold mb-3 text-sky-400" data-translate-key="settings_section_prefs">Preferences</h3>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-slate-300" data-translate-key="settings_enable_sounds">Enable Sounds:</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="soundToggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-slate-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-sky-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-sky-500"></div>
                        </label>
                    </div>
                    <div>
                        <label for="languageSelect" class="block text-sm font-medium text-slate-300 mb-1" data-translate-key="settings_language">Language:</label>
                        <select id="languageSelect" class="w-full p-2 bg-slate-600 border border-slate-500 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500">
                        </select>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-slate-700 rounded-lg">
                <h3 class="text-lg font-semibold mb-2 text-sky-400" data-translate-key="settings_data_management">Data Management</h3>
                <p class="text-xs text-slate-400 mb-3" data-translate-key="settings_data_info">Save your progress to a file or load it on another device.</p>
                <div class="flex flex-col sm:flex-row gap-3">
                    <button id="exportDataButton" class="flex-1 px-4 py-2 text-sm font-medium text-white bg-slate-600 hover:bg-slate-500 rounded-md transition-colors flex items-center justify-center gap-2">
                        <i class="fas fa-download"></i><span data-translate-key="settings_export_button">Export Data</span>
                    </button>
                    <button id="importDataButton" class="flex-1 px-4 py-2 text-sm font-medium text-white bg-slate-600 hover:bg-slate-500 rounded-md transition-colors flex items-center justify-center gap-2">
                        <i class="fas fa-upload"></i><span data-translate-key="settings_import_button">Import Data</span>
                    </button>
                    <input type="file" id="importFileInput" class="hidden" accept=".json">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancelSettingsButton" class="px-4 py-2 text-sm font-medium text-slate-300 bg-slate-600 hover:bg-slate-500 rounded-md transition-colors" data-translate-key="cancel_button">Cancel</button>
                <button id="saveSettingsButton" class="px-4 py-2 text-sm font-medium text-white bg-sky-500 hover:bg-sky-600 rounded-md transition-colors" data-translate-key="save_button">Save Settings</button>
            </div>
        </div>
    </div>
    <div id="customAlertModal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-[100]">
        <div id="customAlertContent" class="bg-slate-800 p-6 rounded-lg shadow-xl w-full max-w-md text-left">
            <div class="flex items-start">
                <div id="customAlertIcon" class="text-3xl mr-4 mt-1"></div>
                <div>
                    <h3 id="customAlertTitle" class="text-xl font-bold mb-2"></h3>
                    <div id="customAlertMessage" class="text-slate-300 mb-6 help-content text-sm"></div>
                </div>
            </div>
            <div id="customAlertButtons" class="flex justify-end space-x-3">
                <button id="customAlertCancelButton" class="px-4 py-2 text-sm font-medium text-slate-300 bg-slate-600 hover:bg-slate-500 rounded-md transition-colors">Cancel</button>
                <button id="customAlertConfirmButton" class="px-4 py-2 text-sm font-medium text-white bg-sky-500 hover:bg-sky-600 rounded-md transition-colors">OK</button>
            </div>
        </div>
    </div>
    <div id="toastNotification">
        <strong id="toastTitle" class="font-bold"></strong>
        <p id="toastBody"></p>
    </div>

    <script id="timerWorkerScript" type="javascript/worker">
        let workerTimeLeft;let workerIsRunning=!1;let workerTimerInterval;let workerCurrentMode;let workerSettings={};function startWorkerTimer(){if(workerIsRunning)return;if(workerTimeLeft<=0){postMessage({type:"end",mode:workerCurrentMode});return}workerIsRunning=!0;workerTimerInterval=setInterval(()=>{if(!workerIsRunning){clearInterval(workerTimerInterval);return}workerTimeLeft--;postMessage({type:"tick",timeLeft:workerTimeLeft,mode:workerCurrentMode});if(workerTimeLeft<=0){clearInterval(workerTimerInterval);workerIsRunning=!1;postMessage({type:"end",mode:workerCurrentMode})}},1e3)}self.onmessage=function(e){const{command:o,mode:t,duration:s,settings:i}=e.data;switch(o){case"start":workerIsRunning||startWorkerTimer();break;case"pause":workerIsRunning=!1;clearInterval(workerTimerInterval);break;case"setMode":workerCurrentMode=t;workerTimeLeft=s;workerIsRunning=!1;clearInterval(workerTimerInterval);postMessage({type:"modeSet",timeLeft:workerTimeLeft,mode:workerCurrentMode});break;case"updateSettings":workerSettings=i;if(!workerIsRunning&&workerCurrentMode){let e;e="study"===workerCurrentMode?workerSettings.studyTime*60:"shortBreak"===workerCurrentMode?workerSettings.shortBreakTime*60:"longBreak"===workerCurrentMode?workerSettings.longBreakTime*60:null;e&&workerTimeLeft!==e&&(workerTimeLeft=e,postMessage({type:"tick",timeLeft:workerTimeLeft,mode:workerCurrentMode}))}}};
    </script>

    <script>
        const baseAchievements = [{id:"days1",type:"totalDaysStudied",threshold:1,icon:"fas fa-seedling"},{id:"days7",type:"totalDaysStudied",threshold:7,icon:"fas fa-calendar-check"},{id:"days15",type:"totalDaysStudied",threshold:15,icon:"fas fa-medal"},{id:"days30",type:"totalDaysStudied",threshold:30,icon:"fas fa-award"},{id:"days50",type:"totalDaysStudied",threshold:50,icon:"fas fa-star"},{id:"days75",type:"totalDaysStudied",threshold:75,icon:"fas fa-running"},{id:"days100",type:"totalDaysStudied",threshold:100,icon:"fas fa-crown"},{id:"days120",type:"totalDaysStudied",threshold:120,icon:"fas fa-book-reader"},{id:"days150",type:"totalDaysStudied",threshold:150,icon:"fas fa-graduation-cap"},{id:"streak3",type:"streak",threshold:3,icon:"fas fa-fire"},{id:"streak7",type:"streak",threshold:7,icon:"fas fa-bolt"},{id:"streak14",type:"streak",threshold:14,icon:"fas fa-dumbbell"},{id:"streak30",type:"streak",threshold:30,icon:"fas fa-calendar-alt"},{id:"streak50",type:"streak",threshold:50,icon:"fas fa-shield-alt"},{id:"cycles1",type:"totalCyclesCompleted",threshold:1,icon:"fas fa-flag-checkered"},{id:"cycles10",type:"totalCyclesCompleted",threshold:10,icon:"fas fa-history"},{id:"cycles25",type:"totalCyclesCompleted",threshold:25,icon:"fas fa-cogs"},{id:"cycles50",type:"totalCyclesCompleted",threshold:50,icon:"fas fa-rocket"},{id:"cycles100",type:"totalCyclesCompleted",threshold:100,icon:"fas fa-gem"},{id:"hours1",type:"totalPureStudyHours",threshold:1,icon:"fas fa-hourglass-start"},{id:"hours10",type:"totalPureStudyHours",threshold:10,icon:"fas fa-brain"},{id:"hours50",type:"totalPureStudyHours",threshold:50,icon:"fas fa-microscope"},{id:"hours100",type:"totalPureStudyHours",threshold:100,icon:"fas fa-university"},{id:"sb_hours_1",type:"totalShortBreakSeconds",threshold:3600,icon:"fas fa-coffee"},{id:"sb_hours_5",type:"totalShortBreakSeconds",threshold:18e3,icon:"fas fa-mug-hot"},{id:"sb_hours_15",type:"totalShortBreakSeconds",threshold:54e3,icon:"fas fa-couch"},{id:"lb_hours_3",type:"totalLongBreakSeconds",threshold:10800,icon:"fas fa-bed"},{id:"lb_hours_10",type:"totalLongBreakSeconds",threshold:36e3,icon:"fas fa-battery-full"},{id:"lb_hours_25",type:"totalLongBreakSeconds",threshold:9e4,icon:"fas fa-umbrella-beach"},{id:"dailySessions5",type:"dailyFocusSessions",threshold:5,icon:"fas fa-bolt"},{id:"dailySessions10",type:"dailyFocusSessions",threshold:10,icon:"fas fa-rocket"},{id:"dailyCycles3",type:"dailyCyclesCompleted",threshold:3,icon:"fas fa-cogs"},{id:"dailyHours6",type:"dailyPureStudyHours",threshold:6,icon:"fas fa-brain"}];
        const translations = {
            en: {
                app_title: "PomodoroCycle Timer", goal_mode_all: "All Days", goal_mode_week_weekend: "Week/Weekend", goal_mode_custom: "Custom Days", goal_sessions_per_day: "Sessions per day:", goal_sessions_weekdays: "Sessions on Weekdays:", goal_sessions_weekends: "Sessions on Weekends:", toast_goal_too_long_title: "Goal Exceeds 24 Hours", toast_goal_too_long_body: "A daily goal cannot exceed 24 hours of focus time. Please adjust your values.", help_tooltip:"Help / How to Use",settings_tooltip:"Settings",current_timer_label:"Current Timer:",mode_study:"Focus",mode_short_break:"Short Break",mode_long_break:"Long Break",cycle_tooltip:"Focus Sessions in Current Cycle",reset_cycle_tooltip:"Reset Cycle",skip_break_button:"Skip Break",start_button:"Start",pause_button:"Pause",resume_button:"Resume",reset_current_button:"Reset Current",tab_stats:"Statistics",tab_daily_goal:"Daily Goal",tab_achievements:"Achievements",stats_title:"Your Statistics",stats_streak:"Daily Streak",stats_daily_title:"Daily:",stats_daily_total_time:"Total Time Today",stats_daily_focus_sessions:"Focus Sessions Today",stats_daily_cycles:"Cycles Completed Today",stats_daily_study_time:"Focus Time Today",stats_general_title:"General:",stats_general_cycles:"Total Cycles Completed",stats_general_sessions:"Total Focus Sessions",stats_general_study_time:"Total Focus Time",stats_general_days:"Total Focus Days",storage_warning:"Your progress is saved in your browser's local storage. Clearing browser data may delete your progress.",donation_text:"If you'd like to support this app, you can do so {0}",donation_link_text:"here ‚òï",settings_title:"Timer Settings",settings_section_timer:"Timer Durations",settings_section_prefs:"Preferences",settings_study_time:"Focus Time (minutes):",settings_short_break:"Short Break (minutes):",settings_long_break:"Long Break (minutes):",settings_language:"Language:",settings_enable_sounds:"Enable Sounds:",settings_data_management:"Data Management",settings_data_info:"Save your progress to a file or load it on another device.",settings_export_button:"Export Data",settings_import_button:"Import Data",cancel_button:"Cancel",save_button:"Save Settings",save_goal_button:"Save Goal",confirm_button:"Confirm",ok_button:"OK",got_it_button:"Got it!",new_badge:"NEW!",unlocked_on_date:"Unlocked on: {0}",progress_label:"Progress",chart_target_label:"Target",daily_goal_title:"Today's Goal",edit_goal_button:"Edit Goal",set_goal_button:"Set Goal",set_goal_title:"Set Your Daily Goal",no_goal_set:"No goal set for today.",goal_type_label:"Goal Type:",goal_type_sessions:"Focus Sessions",goal_type_cycles:"Completed Cycles",goal_value_label:"Target Value:",goal_completed_toast_title:"Goal Achieved!",goal_completed_toast_body:"Congratulations! You've reached your daily goal!",toast_goal_saved_body:"Your new daily goals have been saved.",achievements_title:"Your Achievements",toast_error_title:"Error",toast_goal_error:"Please enter a valid target value (must be a number greater than 0).",toast_settings_saved_title:"Settings Saved",toast_settings_saved_body:"Your new timer durations have been applied.",toast_achievement_unlocked_title:"Achievement Unlocked!",toast_achievement_unlocked_body:'You unlocked the achievement: "{0}"!',toast_study_complete_title:"Focus Session Complete!",toast_study_complete_body:"Time for a break. Good job!",toast_break_over_title:"Break Over!",toast_break_over_body:"Time to get back to focus!",toast_long_break_over_title:"Long Break Over!",toast_long_break_over_body:"Cycle complete! Ready for a new one?",toast_cycle_complete_title:"Cycle Complete!",toast_cycle_complete_body:"Congratulations! You've completed a full Pomodoro cycle.",toast_new_day_title:"A New Day!",toast_new_day_body:"Your daily statistics have been reset.",toast_import_success_title:"Import Successful",toast_import_success_body:"Your progress has been restored. The page will now reload.",toast_import_error_title:"Import Failed",toast_import_error_body:"The selected file is not a valid backup file or is corrupted.",alert_reset_cycle_title:"Confirm Reset",alert_reset_cycle_body:"Are you sure you want to reset the current cycle? This will set the focus session to 1/4.",alert_help_title:"How This Pomodoro Timer Works",alert_help_body:'<p class="mb-3">The <strong>Pomodoro Technique</strong> is a time management method that uses a timer to break down work into intervals, traditionally 25 minutes in length, separated by short breaks.</p><p class="mb-1 font-semibold">The timer\'s cycle:</p><ul><li>1. Focus Session (e.g., 25 min)</li><li class="break-session" style="padding-left: 35px;">Short Break (e.g., 5 min)</li><li>2. Focus Session</li><li class="break-session" style="padding-left: 35px;">Short Break</li><li>3. Focus Session</li><li class="break-session" style="padding-left: 35px;">Short Break</li><li>4. Focus Session (completes 1 cycle)</li><li class="break-session" style="padding-left: 35px;">Long Break (e.g., 15 min)</li></ul><p class="mb-3">Focus sessions and breaks begin automatically. After the long break, however, you\'ll need to start the new cycle manually.</p><p class="mb-3">The daily streak only increases after completing the first session of the day.</p><p>Reset the cycle using the <i class=\'fas fa-sync-alt fa-xs\'></i> button.</p>',alert_import_title:"Import Progress?",alert_import_body:"This will overwrite all your current progress, achievements, and settings. This action cannot be undone. Are you sure you want to continue?",alert_goal_type_change_title:"Change Goal Type?",alert_goal_type_change_body:"Changing the goal type will reset your goal history chart for the past 7 days to provide a clean slate for the new metric. Are you sure you want to proceed?",today_label:"Today",achievements:{"days1":{name:"Focused Beginner",description:"Complete your first day of focus."},"days7":{name:"Weekly Commitment",description:"Focus for 7 days."},"days15":{name:"Fortnightly Focus",description:"Focus for 15 days."},"days30":{name:"Monthly Landmark",description:"Focus for 30 days."},"days50":{name:"Shooting Star",description:"Focus for 50 days."},"days75":{name:"Focus Marathoner",description:"Focus for 75 days."},"days100":{name:"Habit Master",description:"Focus for 100 days."},"days120":{name:"Focus Legend",description:"Focus for 120 days."},"days150":{name:"Focus Sage",description:"Focus for 150 days."},"streak3":{name:"3-Day Combo!",description:"Maintain a 3-day daily streak."},"streak7":{name:"A Week Streak",description:"Maintain a 7-day daily streak."},"streak14":{name:"Habit Power-Up",description:"Maintain a 14-day daily streak."},"streak30":{name:"Unstoppable",description:"Maintain a 30-day daily streak."},"streak50":{name:"True Dedication",description:"Maintain a 50-day daily streak."},"cycles1":{name:"First Full Cycle",description:"Complete 1 Pomodoro cycle."},"cycles10":{name:"Ten Cycles of Focus",description:"Complete 10 Pomodoro cycles."},"cycles25":{name:"Productivity Pro",description:"Complete 25 Pomodoro cycles."},"cycles50":{name:"To The Moon",description:"Complete 50 Pomodoro cycles."},"cycles100":{name:"Cycle Centurion",description:"Complete 100 Pomodoro cycles."},"hours1":{name:"First Hour of Focus",description:"Accumulate 1 hour of focus."},"hours10":{name:"Immersive Thinker",description:"Accumulate 10 hours of focus."},"hours50":{name:"Knowledge Fountain",description:"Accumulate 50 hours of focus."},"hours100":{name:"Focus Scholar",description:"Accumulate 100 hours of focus."},"sb_hours_1":{name:"Quick Breather",description:"Accumulate 1 hour in short breaks."},"sb_hours_5":{name:"Relaxation Adept",description:"Accumulate 5 hours in short breaks."},"sb_hours_15":{name:"Short Break Pro",description:"Accumulate 15 hours in short breaks."},"lb_hours_3":{name:"Well Deserved Rest",description:"Accumulate 3 hours in long breaks."},"lb_hours_10":{name:"Recharge Master",description:"Accumulate 10 hours in long breaks."},"lb_hours_25":{name:"Leisure Expert",description:"Accumulate 25 hours in long breaks."},"dailySessions5":{name:"Daily Sprinter",description:"5 focus sessions in one day."},"dailySessions10":{name:"Focus Machine",description:"10 focus sessions in one day."},"dailyCycles3":{name:"Tricycler",description:"3 full cycles in one day."},"dailyHours6":{name:"Deep Work",description:"6 focus hours in one day."}},goal_text:{focusSessions_one:"{0} Focus Session",focusSessions_other:"{0} Focus Sessions",completedCycles_one:"{0} Cycle",completedCycles_other:"{0} Cycles"}},
            'pt-BR': {
                app_title: "PomodoroCycle Timer", goal_mode_all: "Todos os Dias", goal_mode_week_weekend: "Semana/Fim de Semana", goal_mode_custom: "Dias Customizados", goal_sessions_per_day: "Sess√µes por dia:", goal_sessions_weekdays: "Sess√µes na Semana:", goal_sessions_weekends: "Sess√µes no Fim de Semana:", toast_goal_too_long_title: "Meta Excede 24 Horas", toast_goal_too_long_body: "A meta di√°ria n√£o pode exceder 24h de foco. Por favor, ajuste os valores.", help_tooltip:"Ajuda / Como Usar",settings_tooltip:"Configura√ß√µes",current_timer_label:"Timer Atual:",mode_study:"Foco",mode_short_break:"Pausa Curta",mode_long_break:"Pausa Longa",cycle_tooltip:"Sess√µes de foco no ciclo atual",reset_cycle_tooltip:"Reiniciar Ciclo",skip_break_button:"Pular Pausa",start_button:"Iniciar",pause_button:"Pausar",resume_button:"Retomar",reset_current_button:"Resetar Atual",tab_stats:"Estat√≠sticas",tab_daily_goal:"Meta Di√°ria",tab_achievements:"Conquistas",stats_title:"Suas Estat√≠sticas",stats_streak:"Sequ√™ncia Di√°ria",stats_daily_title:"Hoje:",stats_daily_total_time:"Tempo Total Hoje",stats_daily_focus_sessions:"Sess√µes de Foco Hoje",stats_daily_cycles:"Ciclos Completos Hoje",stats_daily_study_time:"Tempo de Foco Hoje",stats_general_title:"Geral:",stats_general_cycles:"Total de Ciclos Completos",stats_general_sessions:"Total de Sess√µes de Foco",stats_general_study_time:"Total de Tempo de Foco",stats_general_days:"Total de Dias de Foco",storage_warning:"Seu progresso √© salvo no armazenamento local do navegador. Limpar os dados pode apagar seu progresso.",donation_text:"Se quiser apoiar este app, voc√™ pode faz√™-lo {0}",donation_link_text:"aqui ‚òï",settings_title:"Configura√ß√µes do Timer",settings_section_timer:"Dura√ß√µes do Timer",settings_section_prefs:"Prefer√™ncias",settings_study_time:"Tempo de Foco (minutos):",settings_short_break:"Pausa Curta (minutos):",settings_long_break:"Pausa Longa (minutos):",settings_language:"Idioma:",settings_enable_sounds:"Habilitar Sons:",settings_data_management:"Gest√£o de Dados",settings_data_info:"Salve seu progresso em um arquivo ou carregue-o em outro dispositivo.",settings_export_button:"Exportar Dados",settings_import_button:"Importar Dados",cancel_button:"Cancelar",save_button:"Salvar",save_goal_button:"Salvar Meta",confirm_button:"Confirmar",ok_button:"OK",got_it_button:"Entendi!",new_badge:"NOVO!",unlocked_on_date:"Desbloqueado em: {0}",progress_label:"Progresso",chart_target_label:"Meta",daily_goal_title:"Meta de Hoje",edit_goal_button:"Editar Meta",set_goal_button:"Definir Meta",set_goal_title:"Defina Sua Meta Di√°ria",no_goal_set:"Nenhuma meta definida para hoje.",goal_type_label:"Tipo de Meta:",goal_type_sessions:"Sess√µes de Foco",goal_type_cycles:"Ciclos Completos",goal_value_label:"Valor Alvo:",goal_completed_toast_title:"Meta Alcan√ßada!",goal_completed_toast_body:"Parab√©ns! Voc√™ atingiu sua meta di√°ria!",toast_goal_saved_body:"Suas novas metas di√°rias foram salvas.",achievements_title:"Suas Conquistas",toast_error_title:"Erro",toast_goal_error:"Por favor, insira um valor alvo v√°lido (deve ser um n√∫mero maior que 0).",toast_settings_saved_title:"Configura√ß√µes Salvas",toast_settings_saved_body:"As novas dura√ß√µes do timer foram aplicadas.",toast_achievement_unlocked_title:"Conquista Desbloqueada!",toast_achievement_unlocked_body:'Voc√™ desbloqueou a conquista: "{0}"!',toast_study_complete_title:"Sess√£o de Foco Completa!",toast_study_complete_body:"Hora de uma pausa. Bom trabalho!",toast_break_over_title:"Pausa Terminada!",toast_break_over_body:"Hora de voltar ao foco!",toast_long_break_over_title:"Pausa Longa Terminada!",toast_long_break_over_body:"Ciclo completo! Pronto para um novo?",toast_cycle_complete_title:"Ciclo Completo!",toast_cycle_complete_body:"Parab√©ns! Voc√™ completou um ciclo Pomodoro.",toast_new_day_title:"Um Novo Dia!",toast_new_day_body:"Suas estat√≠sticas di√°rias foram reiniciadas.",toast_import_success_title:"Importa√ß√£o Conclu√≠da",toast_import_success_body:"Seu progresso foi restaurado. A p√°gina ser√° recarregada.",toast_import_error_title:"Falha na Importa√ß√£o",toast_import_error_body:"O arquivo selecionado n√£o √© um backup v√°lido ou est√° corrompido.",alert_reset_cycle_title:"Confirmar Rein√≠cio",alert_reset_cycle_body:"Tem certeza que quer reiniciar o ciclo atual? A sess√£o de foco voltar√° para 1/4.",alert_help_title:"Como o Timer Pomodoro Funciona",alert_help_body:'<p class="mb-3">A <strong>T√©cnica Pomodoro</strong> √© um m√©todo de gerenciamento de tempo que usa um timer para dividir o trabalho em intervalos, tradicionalmente de 25 minutos, separados por pausas curtas.</p><p class="mb-1 font-semibold">O ciclo deste timer:</p><ul><li>1. Sess√£o de Foco (ex: 25 min)</li><li class="break-session" style="padding-left: 35px;">Pausa Curta (ex: 5 min)</li><li>2. Sess√£o de Foco</li><li class="break-session" style="padding-left: 35px;">Pausa Curta</li><li>3. Sess√£o de Foco</li><li class="break-session" style="padding-left: 35px;">Pausa Curta</li><li>4. Sess√£o de Foco (completa 1 ciclo)</li><li class="break-session" style="padding-left: 35px;">Pausa Longa (ex: 15 min)</li></ul><p class="mb-3">As sess√µes de foco e pausas come√ßam automaticamente. Ap√≥s a pausa longa, no entanto, voc√™ precisar√° iniciar o novo ciclo manualmente.</p><p class="mb-3">A sequ√™ncia di√°ria s√≥ aumenta ap√≥s completar a primeira sess√£o de foco do dia.</p><p>Reinicie o ciclo usando o bot√£o <i class=\'fas fa-sync-alt fa-xs\'></i>.</p>',alert_import_title:"Importar Progresso?",alert_import_body:"Isso ir√° sobrescrever todo o seu progresso, conquistas e configura√ß√µes atuais. Esta a√ß√£o n√£o pode ser desfeita. Voc√™ tem certeza que deseja continuar?",alert_goal_type_change_title:"Mudar tipo de meta?",alert_goal_type_change_body:"Mudar o tipo da meta ir√° reiniciar o hist√≥rico do seu gr√°fico dos √∫ltimos 7 dias para uma melhor visualiza√ß√£o da nova m√©trica. Tem certeza que deseja prosseguir?",today_label:"Hoje",achievements:{"days1":{name:"Iniciante Focado",description:"Complete seu primeiro dia de foco."},"days7":{name:"Compromisso Semanal",description:"Foque por 7 dias."},"days15":{name:"Foco Quinzenal",description:"Foque por 15 dias."},"days30":{name:"Marco Mensal",description:"Foque por 30 dias."},"days50":{name:"Estrela Cadente",description:"Foque por 50 dias."},"days75":{name:"Maratonista do Foco",description:"Foque por 75 dias."},"days100":{name:"Mestre do H√°bito",description:"Foque por 100 dias."},"days120":{name:"Lenda do Foco",description:"Foque por 120 dias."},"days150":{name:"S√°bio do Foco",description:"Foque por 150 dias."},"streak3":{name:"Combo de 3 Dias!",description:"Mantenha uma sequ√™ncia de 3 dias."},"streak7":{name:"Sequ√™ncia Semanal",description:"Mantenha uma sequ√™ncia de 7 dias."},"streak14":{name:"H√°bito Turbinado",description:"Mantenha uma sequ√™ncia de 14 dias."},"streak30":{name:"Impar√°vel",description:"Mantenha uma sequ√™ncia de 30 dias."},"streak50":{name:"Dedica√ß√£o Pura",description:"Mantenha uma sequ√™ncia de 50 dias."},"cycles1":{name:"Primeiro Ciclo",description:"Complete 1 ciclo Pomodoro."},"cycles10":{name:"Dez Ciclos de Foco",description:"Complete 10 ciclos Pomodoro."},"cycles25":{name:"Pro da Produtividade",description:"Complete 25 ciclos Pomodoro."},"cycles50":{name:"Para a Lua",description:"Complete 50 ciclos Pomodoro."},"cycles100":{name:"Centuri√£o de Ciclos",description:"Complete 100 ciclos Pomodoro."},"hours1":{name:"Primeira Hora de Foco",description:"Acumule 1 hora de foco."},"hours10":{name:"Pensador Imersivo",description:"Acumule 10 horas de foco."},"hours50":{name:"Fonte de Sabedoria",description:"Acumule 50 horas de foco."},"hours100":{name:"Erudito do Foco",description:"Acumule 100 horas de foco."},"sb_hours_1":{name:"Respiro R√°pido",description:"Acumule 1 hora em pausas curtas."},"sb_hours_5":{name:"Mestre do Relax",description:"Acumule 5 horas em pausas curtas."},"sb_hours_15":{name:"Campe√£o da Pausa",description:"Acumule 15 horas em pausas curtas."},"lb_hours_3":{name:"Descanso Merecido",description:"Acumule 3 horas em pausas longas."},"lb_hours_10":{name:"Mestre da Recarga",description:"Acumule 10 horas em pausas longas."},"lb_hours_25":{name:"Expert do Lazer",description:"Acumule 25 horas em pausas longas."},"dailySessions5":{name:"Velocista Di√°rio",description:"5 sess√µes de foco em um dia."},"dailySessions10":{name:"M√°quina de Foco",description:"10 sess√µes de foco em um dia."},"dailyCycles3":{name:"Triciclista",description:"3 ciclos completos em um dia."},"dailyHours6":{name:"Trabalho Intenso",description:"6 horas de foco em um dia."}},goal_text:{focusSessions_one:"{0} Sess√£o de Foco",focusSessions_other:"{0} Sess√µes de Foco",completedCycles_one:"{0} Ciclo",completedCycles_other:"{0} Ciclos"}}
        };

        const timerTextEl = document.getElementById('timerText');
        const modePillEl = document.getElementById('modePill');
        const cycleDotsContainerEl = document.getElementById('cycleDotsContainer');
        const resetButton = document.getElementById('resetButton');
        const resetCycleCountButtonEl = document.getElementById('resetCycleCountButton');
        const startPauseButton = document.getElementById('startPauseButton');
        const skipBreakButton = document.getElementById('skipBreakButton');
        const settingsButton = document.getElementById('settingsButton');
        const helpButton = document.getElementById('helpButton');
        const settingsModal = document.getElementById('settingsModal');
        const saveSettingsButton = document.getElementById('saveSettingsButton');
        const cancelSettingsButton = document.getElementById('cancelSettingsButton');
        const studyTimeInput = document.getElementById('studyTimeInput');
        const shortBreakTimeInput = document.getElementById('shortBreakTimeInput');
        const longBreakTimeInput = document.getElementById('longBreakTimeInput');
        const languageSelect = document.getElementById('languageSelect');
        const soundToggle = document.getElementById('soundToggle');
        const exportDataButton = document.getElementById('exportDataButton');
        const importDataButton = document.getElementById('importDataButton');
        const importFileInput = document.getElementById('importFileInput');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabPanes = document.querySelectorAll('.tab-pane');
        const tabContentEl = document.getElementById('tabContent');
        const collapseTabsButton = document.getElementById('collapseTabsButton');
        const collapseIcon = document.getElementById('collapseIcon');
        const dailyFocusSessionsEl = document.getElementById('dailyFocusSessions');
        const dailyCyclesEl = document.getElementById('dailyCycles');
        const dailyStudyTimeEl = document.getElementById('dailyStudyTime');
        const dailyTotalTimeEl = document.getElementById('dailyTotalTime');
        const totalFocusSessionsEl = document.getElementById('totalFocusSessions');
        const totalDaysStudiedEl = document.getElementById('totalDaysStudied');
        const totalCyclesEl = document.getElementById('totalCycles');
        const totalStudyTimeEl = document.getElementById('totalStudyTime');
        const streakCounterHeaderEl = document.getElementById('streakCounterHeader');
        const streakFireIconContainerEl = document.getElementById('streakFireIconContainer');
        const achievementsListEl = document.getElementById('achievementsList');
        const customAlertModal = document.getElementById('customAlertModal');
        const customAlertContentEl = document.getElementById('customAlertContent');
        const customAlertIconEl = document.getElementById('customAlertIcon');
        const customAlertTitleEl = document.getElementById('customAlertTitle');
        const customAlertMessageEl = document.getElementById('customAlertMessage');
        const customAlertConfirmButton = document.getElementById('customAlertConfirmButton');
        const customAlertCancelButton = document.getElementById('customAlertCancelButton');
        const customAlertButtonsContainer = document.getElementById('customAlertButtons');
        const faviconEl = document.getElementById('favicon');
        const toastNotificationEl = document.getElementById('toastNotification');
        const toastTitleEl = document.getElementById('toastTitle');
        const toastBodyEl = document.getElementById('toastBody');
        const rewardsTabBadgeEl = document.getElementById('rewardsTabBadge');
        const achievementsTabBadgeEl = document.getElementById('achievementsTabBadge');
        const languageModal = document.getElementById('languageModal');
        const languageButtonsContainer = document.getElementById('languageButtonsContainer');
        const appContainer = document.getElementById('app-container');
        const goalDisplayView = document.getElementById('goalDisplayView');
        const goalEditView = document.getElementById('goalEditView');
        const editGoalButton = document.getElementById('editGoalButton');
        const saveGoalButton = document.getElementById('saveGoalButton');
        const cancelGoalButton = document.getElementById('cancelGoalButton');
        const goalProgressContainer = document.getElementById('goalProgressContainer');
        const goalTextEl = document.getElementById('goalText');
        const goalProgressTextEl = document.getElementById('goalProgressText');
        const goalProgressBarEl = document.getElementById('goalProgressBar');
        const goalHistoryChartCanvas = document.getElementById('goalHistoryChart');

        let goalHistoryChart;
        const POMODOROS_PER_CYCLE = 4;
        let lastSoundScheduledTime = 0;
        const MIN_SOUND_INTERVAL = 0.05, SOUND_BASE_DELAY = 0.05;
        let justSeenAchievementIds = [];
        let blockUnloadSave = false;
        let currentTimerInitialDuration = 0;
        let activeTabId = 'stats';
        
        function getTodayDateString() {
            const today = new Date();
            return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        }

        function getDefaultAppData() {
            return {
                settings: { studyTime: 25, shortBreakTime: 5, longBreakTime: 15, soundEnabled: true, language: 'en' },
                timerState: { currentMode: "study", timeLeft: 25 * 60, isRunning: false, pomodorosInCycle: 0, lastTimerUsed: null },
                stats: {
                    daily: { date: getTodayDateString(), focusSessions: 0, cyclesCompleted: 0, pureStudySeconds: 0, totalTimeSeconds: 0, firstStudySessionCompletedToday: false },
                    general: { totalDaysStudied: 0, totalCyclesCompleted: 0, totalFocusSessions: 0, totalPureStudySeconds: 0, streak: 0, lastStudyDate: null, totalShortBreakSeconds: 0, totalLongBreakSeconds: 0 },
                    goalHistory: []
                },
                dailyGoal: {
                    settings: { mode: 'all_days', targetAll: 4, targetWeekday: 4, targetWeekend: 2, targetsCustom: [2, 4, 4, 4, 4, 4, 2] },
                    target: 0, progress: 0, completed: false, notificationShown: false
                },
                achievements: [],
                uiState: { newAchievementsCount: 0, tabsCollapsed: false },
                appVersion: "3.7.0"
            };
        }

        let appData = getDefaultAppData();
        let synth;
        if (typeof Tone !== 'undefined') {
            synth = new Tone.Synth().toDestination();
        } else {
            console.warn("Tone.js not loaded. Sound effects will be disabled.");
        }
        
        function playSound(note = 'C4', duration = '8n', type = 'timerComplete') {
            if (!appData.settings.soundEnabled || !synth) return;
            if (Tone.context.state !== 'running') {
                Tone.context.resume().catch(e => console.error("Error resuming AudioContext:", e));
            }
            if (Tone.Transport.state !== "started") {
                Tone.Transport.start();
            }
            try {
                let soundNote = note, soundDuration = duration, soundVolume = 0;
                if (type === 'achievement') { soundNote = "C5"; soundDuration = "4n"; soundVolume = -6; }
                else if (type === 'goal') { soundNote = "E5"; soundDuration = "4n"; soundVolume = -6; }
                const currentTime = Tone.now();
                const scheduledTime = Math.max(currentTime + SOUND_BASE_DELAY, lastSoundScheduledTime + MIN_SOUND_INTERVAL);
                lastSoundScheduledTime = scheduledTime;
                synth.volume.setValueAtTime(soundVolume, scheduledTime);
                synth.triggerAttackRelease(soundNote, soundDuration, scheduledTime);
            } catch (error) {
                console.error(`Error playing sound (type: ${type}):`, error);
            }
        }
        
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
        
        function formatHoursMinutes(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            return `${hours}h ${minutes}m`;
        }
        
        function getText(key, ...args) {
            const lang = appData.settings.language || 'en';
            let text = (translations[lang] && translations[lang][key]) || translations['en'][key];
            if (!text) {
                for (const langKey in translations) {
                    if (translations[langKey] && translations[langKey][key]) {
                        text = translations[langKey][key];
                        break;
                    }
                }
            }
            if (!text) return key;
            if (args.length > 0) {
                args.forEach((arg, index) => {
                    text = text.replace(`{${index}}`, arg);
                });
            }
            return text;
        }
        
        function getPluralText(key, count) {
            const lang = appData.settings.language || 'en';
            const rules = new Intl.PluralRules(lang);
            const pluralCategory = rules.select(count);
            const keyToUse = `${key}_${pluralCategory}`;
            let text = (translations[lang]?.goal_text?.[keyToUse]) || (translations['en']?.goal_text?.[keyToUse]);
            if (!text) text = (translations[lang]?.goal_text?.[`${key}_other`]) || (translations['en']?.goal_text?.[`${key}_other`]);
            if (!text) return `${count} ${key}`;
            return text.replace(`{0}`, count);
        }
        
        function applyTranslations() {
            document.documentElement.lang = appData.settings.language || 'en';
            document.title = getText('app_title');
            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.dataset.translateKey;
                const translation = getText(key);
                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    if (el.placeholder) el.placeholder = translation;
                } else if (el.title) {
                    el.title = translation;
                } else {
                    const targetEl = el.querySelector('span') || el;
                    if(targetEl && targetEl.innerHTML !== translation) {
                        targetEl.innerHTML = translation;
                    }
                }
            });
            const donationEl = document.querySelector('[data-translate-key="donation_text"]');
            if(donationEl) {
                const linkHtml = `<a href="https://www.buymeacoffee.com/lemonade299792458" target="_blank" class="donation-section-link">${getText('donation_link_text')}</a>`;
                donationEl.innerHTML = getText('donation_text', linkHtml);
            }
        }
        
        const STORAGE_KEY = 'pomodoroGamifiedAppData_v3';
        function buildAchievements(lang, savedAchievements = []) {
           const achievementTexts = (translations[lang] && translations[lang].achievements) ? translations[lang].achievements : translations['en'].achievements;
           return baseAchievements.map(baseAch => {
               const userAchData = savedAchievements.find(ua => ua.id === baseAch.id) || {};
               const translatedText = achievementTexts[baseAch.id] || { name: baseAch.id, description: '' };
               return {
                   ...baseAch, name: translatedText.name, description: translatedText.description,
                   unlocked: userAchData.unlocked || false, unlockedDate: userAchData.unlockedDate || null, seen: userAchData.seen || (userAchData.unlocked || false)
               };
           });
        }
        
        function isObject(item) {
            return (item && typeof item === 'object' && !Array.isArray(item));
        }
        
        function mergeDeep(target, ...sources) {
            if (!sources.length) return target;
            const source = sources.shift();
            if (isObject(target) && isObject(source)) {
                for (const key in source) {
                    if (isObject(source[key])) {
                        if (!target[key]) Object.assign(target, { [key]: {} });
                        mergeDeep(target[key], source[key]);
                    } else {
                        Object.assign(target, { [key]: source[key] });
                    }
                }
            }
            return mergeDeep(target, ...sources);
        }
        
        function sanitizeLoadedData(data) {
            const stats = data.stats;
            stats.daily.focusSessions=parseInt(stats.daily.focusSessions)||0;
            stats.daily.cyclesCompleted=parseInt(stats.daily.cyclesCompleted)||0;
            stats.daily.pureStudySeconds=parseFloat(stats.daily.pureStudySeconds)||0;
            stats.daily.totalTimeSeconds=parseFloat(stats.daily.totalTimeSeconds)||0;
            stats.general.totalDaysStudied=parseInt(stats.general.totalDaysStudied)||0;
            stats.general.totalCyclesCompleted=parseInt(stats.general.totalCyclesCompleted)||0;
            stats.general.totalFocusSessions=parseInt(stats.general.totalFocusSessions)||0;
            stats.general.totalPureStudySeconds=parseFloat(stats.general.totalPureStudySeconds)||0;
            stats.general.streak=parseInt(stats.general.streak)||0;
            stats.general.totalShortBreakSeconds=parseFloat(stats.general.totalShortBreakSeconds)||0;
            stats.general.totalLongBreakSeconds=parseFloat(stats.general.totalLongBreakSeconds)||0;
            data.timerState.pomodorosInCycle=parseInt(data.timerState.pomodorosInCycle)||0;
            data.timerState.timeLeft=parseFloat(data.timerState.timeLeft)||data.settings.studyTime*60;
            if (!data.stats.goalHistory) data.stats.goalHistory = [];
            if (data.dailyGoal.target === undefined) data.dailyGoal.target = 0;
            return data;
        }
        
        function loadData() {
            const storedData = localStorage.getItem(STORAGE_KEY);
            const defaultData = getDefaultAppData();
            if (storedData) {
                try {
                    const parsedData = JSON.parse(storedData);
                    appData = mergeDeep(defaultData, parsedData);
                    appData = sanitizeLoadedData(appData);
                    if (!appData.dailyGoal.settings) {
                        const oldTarget = appData.dailyGoal.target || 4;
                        appData.dailyGoal.settings={mode:'all_days',targetAll:oldTarget,targetWeekday:oldTarget,targetWeekend:2,targetsCustom:[2,oldTarget,oldTarget,oldTarget,oldTarget,oldTarget,2]};
                    }
                    const lang = appData.settings.language || 'en';
                    appData.achievements = buildAchievements(lang, parsedData.achievements || []);
                } catch (e) {
                    appData = getDefaultAppData();
                    appData.achievements = buildAchievements(appData.settings.language);
                }
            } else {
               appData = defaultData;
               appData.achievements = buildAchievements(appData.settings.language);
            }
            if (appData.stats.daily.date !== getTodayDateString()) {
                archiveGoalProgress();
                resetDailyStats();
            }
            studyTimeInput.value=appData.settings.studyTime;
            shortBreakTimeInput.value=appData.settings.shortBreakTime;
            longBreakTimeInput.value=appData.settings.longBreakTime;
            soundToggle.checked=appData.settings.soundEnabled;
            languageSelect.value=appData.settings.language;
            updateNotificationBadges();
        }
        
        function saveData() {
            const achievementsToSave = appData.achievements.map(ach => ({ id: ach.id, unlocked: ach.unlocked, unlockedDate: ach.unlockedDate, seen: ach.seen }));
            const dataToSave = { ...appData, achievements: achievementsToSave };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
        }
        
        let toastTimeout;
        function showToast(title, body, type = 'info', duration = 4000) {
            clearTimeout(toastTimeout);
            toastTitleEl.textContent=title;
            toastBodyEl.textContent=body;
            toastNotificationEl.className='fixed top-5 right-5 p-4 rounded-md text-white z-[1000] transition-all duration-500 max-w-xs shadow-lg';
            switch (type) {
                case 'success': toastNotificationEl.classList.add('bg-green-500','show'); break;
                case 'error': toastNotificationEl.classList.add('bg-red-500','show'); break;
                case 'warning': toastNotificationEl.classList.add('bg-yellow-500','show'); break;
                default: toastNotificationEl.classList.add('bg-sky-500','show');
            }
            toastTimeout = setTimeout(() => { toastNotificationEl.classList.remove('show'); }, duration);
        }
        
        function updateNotificationBadges() {
            const unseenAchievements = appData.achievements.filter(ach => ach.unlocked && !ach.seen).length;
            achievementsTabBadgeEl.style.display = unseenAchievements > 0 ? 'inline-block' : 'none';
            rewardsTabBadgeEl.style.display = (appData.dailyGoal.completed && !appData.dailyGoal.notificationShown) ? 'inline-block' : 'none';
        }
        
        let currentConfirmCallback=null, currentCancelCallback=null;
        function showCustomAlert(title, message, iconClass="fas fa-info-circle text-sky-400", confirmText="OK", cancelText=null, confirmCallback=null, cancelCallback=null, isHelp=false) {
            customAlertTitleEl.textContent=title;
            customAlertMessageEl.innerHTML=message;
            customAlertIconEl.className=`text-3xl mr-4 mt-1 ${iconClass}`;
            customAlertConfirmButton.textContent=confirmText;
            currentConfirmCallback=confirmCallback;
            if (isHelp) {
                customAlertContentEl.classList.remove('max-w-md'); customAlertContentEl.classList.add('max-w-lg');
            } else {
                customAlertContentEl.classList.remove('max-w-lg'); customAlertContentEl.classList.add('max-w-md');
            }
            if (cancelText && typeof cancelCallback === 'function') {
                customAlertCancelButton.textContent=cancelText;
                customAlertCancelButton.classList.remove('hidden');
                currentCancelCallback=cancelCallback;
            } else {
                customAlertCancelButton.classList.add('hidden');
                currentCancelCallback=null;
            }
            customAlertModal.classList.add('show');
        }
        
        function updateTimerDisplay() {
            timerTextEl.textContent = formatTime(appData.timerState.timeLeft);
            let modeKey = '', bodyClass = 'bg-slate-900', timerColorClass = 'text-sky-400', pillClass = 'bg-sky-400/10 text-sky-400';
            switch (appData.timerState.currentMode) {
                case 'study':
                    modeKey='mode_study'; bodyClass='bg-slate-900'; timerColorClass='text-sky-400'; pillClass='bg-sky-400/10 text-sky-400'; skipBreakButton.classList.add('hidden'); break;
                case 'shortBreak':
                    modeKey='mode_short_break'; bodyClass='bg-green-900'; timerColorClass='text-green-400'; pillClass='bg-green-400/10 text-green-400'; skipBreakButton.classList.remove('hidden'); break;
                case 'longBreak':
                    modeKey='mode_long_break'; bodyClass='bg-purple-900'; timerColorClass='text-purple-400'; pillClass='bg-purple-400/10 text-purple-400'; skipBreakButton.classList.remove('hidden'); break;
            }
            modePillEl.textContent=getText(modeKey);
            modePillEl.className=`py-1 px-3 rounded-full text-sm font-semibold transition-all duration-500 ${pillClass}`;
            timerTextEl.className=`timer-text transition-colors duration-500 ${timerColorClass}`;
            document.body.className = document.body.className.replace(/bg-(slate|green|purple)-900/g, '') + ` ${bodyClass}`;
            document.title = `${formatTime(appData.timerState.timeLeft)} - ${getText(modeKey)}`;
            updateCycleInfo();
        }
        
        function updateCycleInfo() {
            const dots = cycleDotsContainerEl.children;
            const currentMode = appData.timerState.currentMode;
            const pomodorosInCycle = appData.timerState.pomodorosInCycle;
            for (let i = 0; i < dots.length; i++) {
                const dot = dots[i];
                dot.className = 'cycle-dot';
                let borderColorClass = 'border-sky-400';
                if(currentMode === 'shortBreak') borderColorClass = 'border-green-400';
                else if(currentMode === 'longBreak') borderColorClass = 'border-purple-400';
                if (i < pomodorosInCycle) {
                    dot.classList.add('bg-sky-500');
                } else if (i === pomodorosInCycle && currentMode === 'study') {
                    dot.classList.add('bg-transparent', 'border-2', borderColorClass);
                } else {
                    dot.classList.add('bg-slate-600');
                }
            }
        }
        
        function updateStatsDisplay() {
            dailyFocusSessionsEl.textContent=appData.stats.daily.focusSessions; dailyCyclesEl.textContent=appData.stats.daily.cyclesCompleted; dailyStudyTimeEl.textContent=formatHoursMinutes(appData.stats.daily.pureStudySeconds); dailyTotalTimeEl.textContent=formatHoursMinutes(appData.stats.daily.totalTimeSeconds); totalFocusSessionsEl.textContent=appData.stats.general.totalFocusSessions; totalDaysStudiedEl.textContent=appData.stats.general.totalDaysStudied; totalCyclesEl.textContent=appData.stats.general.totalCyclesCompleted; totalStudyTimeEl.textContent=formatHoursMinutes(appData.stats.general.totalPureStudySeconds);
            if (streakCounterHeaderEl) streakCounterHeaderEl.textContent = appData.stats.general.streak;
            if (streakFireIconContainerEl) {
                const streak = appData.stats.general.streak; let fireColorClass = 'text-slate-400';
                if(streak>=50)fireColorClass='text-yellow-400';else if(streak>=40)fireColorClass='text-teal-400';else if(streak>=35)fireColorClass='text-sky-400';else if(streak>=30)fireColorClass='text-blue-500';else if(streak>=25)fireColorClass='text-indigo-500';else if(streak>=20)fireColorClass='text-purple-500';else if(streak>=15)fireColorClass='text-red-600';else if(streak>=10)fireColorClass='text-red-500';else if(streak>=5)fireColorClass='text-red-400';else if(streak>=1)fireColorClass='text-orange-400';
                streakFireIconContainerEl.className = ''; streakFireIconContainerEl.classList.add(fireColorClass); streakFireIconContainerEl.innerHTML = '<i class="fas fa-fire"></i>';
            }
        }
        
        function renderAchievements() {
            achievementsListEl.innerHTML = "";
            appData.achievements.sort((a,b)=>{const c=justSeenAchievementIds.includes(a.id),d=justSeenAchievementIds.includes(b.id);if(c&&!d)return-1;if(!c&&d)return 1;const e=a.unlocked,f=b.unlocked;if(!e&&!f){let c=getAchievementProgress(a.type).current,d=a.threshold>0?c/a.threshold:-1,e=getAchievementProgress(b.type).current,g=b.threshold>0?e/b.threshold:-1;return d>g?-1:d<g?1:a.threshold<b.threshold?-1:a.threshold>b.threshold?1:0}return!e&&f&&!d?-1:e&&!c&&!f?1:e&&!c&&f&&!d?new Date(b.unlockedDate)-new Date(a.unlockedDate):0});
            appData.achievements.forEach(ach => {
                const isNew = justSeenAchievementIds.includes(ach.id);
                const newIndicatorHTML = isNew ? `<span class="ml-1 text-xs font-bold text-yellow-300 animate-pulse new-indicator">${getText('new_badge')}</span>` : '';
                const achEl = document.createElement('div');
                achEl.className = `achievement-item p-3 rounded-lg shadow-md transition-all ${ach.unlocked ? 'unlocked bg-sky-600' : 'locked bg-slate-600'} ${isNew ? 'ring-1 ring-yellow-400 ring-inset' : ''}`;
                let mainContentHTML = `<div class="flex items-start mb-1"><i class="${ach.icon||"fas fa-question-circle"} text-xl ${ach.unlocked?'text-yellow-300':'text-slate-400'} mr-2 mt-1"></i><div class="flex-grow overflow-hidden"><div class="flex items-baseline"><h4 class="font-semibold text-sm ${ach.unlocked?'text-white':'text-sky-300'} truncate mr-1">${ach.name}</h4>${newIndicatorHTML}</div><p class="text-xs ${ach.unlocked?'text-sky-100':'text-slate-300'} leading-tight">${ach.description}</p></div></div>`;
                let progressSectionHTML = '<div class="mt-auto">';
                if (ach.unlocked) {
                    const unlockedDate = new Date(ach.unlockedDate).toLocaleDateString(appData.settings.language.replace('_', '-'));
                    progressSectionHTML += `<p class="text-xs text-yellow-200 font-semibold mt-1"><i class="fas fa-check-circle mr-1"></i>${getText('unlocked_on_date', unlockedDate)}</p>`;
                } else {
                    const { current, displayCurrent, displayTarget } = getAchievementProgress(ach.type, ach.threshold);
                    const progressPercent = ach.threshold > 0 ? Math.min(100, (current / ach.threshold) * 100) : 0;
                    progressSectionHTML += `<div class="progress-bar-container mt-2"><div class="progress-bar bg-sky-400" style="width: ${progressPercent.toFixed(2)}%;"></div></div><p class="text-xs text-slate-400 mt-1">${displayCurrent} / ${displayTarget}</p>`;
                }
                progressSectionHTML += '</div>';
                achEl.innerHTML = mainContentHTML + progressSectionHTML;
                achievementsListEl.appendChild(achEl);
            });
        }
        
        function getAchievementProgress(type, threshold) {
            let currentValue=0;
            switch(type){case'totalDaysStudied':currentValue=appData.stats.general.totalDaysStudied;break;case'totalCyclesCompleted':currentValue=appData.stats.general.totalCyclesCompleted;break;case'totalPureStudyHours':currentValue=appData.stats.general.totalPureStudySeconds/3600;break;case'totalFocusSessions':currentValue=appData.stats.general.totalFocusSessions;break;case'streak':currentValue=appData.stats.general.streak;break;case'totalShortBreakSeconds':currentValue=appData.stats.general.totalShortBreakSeconds;break;case'totalLongBreakSeconds':currentValue=appData.stats.general.totalLongBreakSeconds;break;case'dailyFocusSessions':currentValue=appData.stats.daily.focusSessions;break;case'dailyCyclesCompleted':currentValue=appData.stats.daily.cyclesCompleted;break;case'dailyPureStudyHours':currentValue=appData.stats.daily.pureStudySeconds/3600;break;}
            let displayThreshold=threshold,displayCurrentValue=currentValue;
            if(type==='totalShortBreakSeconds'||type==='totalLongBreakSeconds'){if(threshold>=3600){displayCurrentValue=(currentValue/3600).toFixed(1);displayThreshold=(threshold/3600).toFixed(1)+"h";}else{displayCurrentValue=(currentValue/60).toFixed(0);displayThreshold=(threshold/60).toFixed(0)+"m";}}else if(type==='totalPureStudyHours'||type==='dailyPureStudyHours'){displayCurrentValue=currentValue.toFixed(1);displayThreshold=threshold+"h";}else{displayCurrentValue=Math.floor(currentValue);displayThreshold=threshold;}
            return {current:currentValue,displayCurrent:displayCurrentValue,displayTarget:displayThreshold};
        }
        
        function setTimer(mode) {
            appData.timerState.currentMode = mode;
            appData.timerState.isRunning = false;
            startPauseButton.querySelector('span').textContent = getText('start_button');
            startPauseButton.querySelector('i').className = 'fas fa-play mr-2';
            if (timerWorker) timerWorker.postMessage({ command: 'pause' });
            let newTimeLeft;
            switch (mode) {
                case 'study': newTimeLeft = appData.settings.studyTime * 60; break;
                case 'shortBreak': newTimeLeft = appData.settings.shortBreakTime * 60; break;
                case 'longBreak': newTimeLeft = appData.settings.longBreakTime * 60; break;
                default: newTimeLeft = appData.settings.studyTime * 60, appData.timerState.currentMode = 'study';
            }
            appData.timerState.timeLeft = newTimeLeft;
            if (timerWorker) timerWorker.postMessage({ command: 'setMode', mode: appData.timerState.currentMode, duration: appData.timerState.timeLeft });
            updateTimerDisplay();
            saveData();
        }
        
        function startTimer() {
            if (appData.timerState.timeLeft <= 0) {
                setTimer(appData.timerState.currentMode);
                if (appData.timerState.timeLeft <= 0) {
                    startPauseButton.querySelector('span').textContent = getText('start_button');
                    startPauseButton.querySelector('i').className = 'fas fa-play mr-2';
                    appData.timerState.isRunning = false;
                    return;
                }
            }
            appData.timerState.isRunning = true;
            currentTimerInitialDuration = appData.timerState.timeLeft;
            startPauseButton.querySelector('span').textContent = getText('pause_button');
            startPauseButton.querySelector('i').className = 'fas fa-pause mr-2';
            if (timerWorker) timerWorker.postMessage({ command: 'start' });
            saveData();
        }
        
        function pauseTimer() {
            appData.timerState.isRunning = false;
            startPauseButton.querySelector('span').textContent = getText('resume_button');
            startPauseButton.querySelector('i').className = 'fas fa-play mr-2';
            if (timerWorker) timerWorker.postMessage({ command: 'pause' });
            saveData();
        }
        
        function handleTimerEnd(completedDurationInSeconds) {
            appData.timerState.isRunning = false;
            const endedMode = appData.timerState.currentMode;
            appData.timerState.lastTimerUsed = endedMode;
            let notificationTitleKey="",notificationBodyKey="",soundNoteForEndedMode='C4';
            let nextModeToTransitionTo=null,showCycleCompleteNotification=false,shouldAutoStart=true;
            appData.stats.daily.totalTimeSeconds+=completedDurationInSeconds;
            if (endedMode === 'study') {
                appData.stats.daily.focusSessions++; appData.stats.general.totalFocusSessions++;
                appData.stats.daily.pureStudySeconds+=completedDurationInSeconds; appData.stats.general.totalPureStudySeconds+=completedDurationInSeconds;
                appData.timerState.pomodorosInCycle++;
                notificationTitleKey="toast_study_complete_title"; notificationBodyKey="toast_study_complete_body"; soundNoteForEndedMode='C5';
                if (!appData.stats.daily.firstStudySessionCompletedToday) {
                    appData.stats.daily.firstStudySessionCompletedToday = true;
                    const todayStr = getTodayDateString();
                    if (appData.stats.general.lastStudyDate !== todayStr) {
                        appData.stats.general.totalDaysStudied++;
                        const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
                        const yesterdayStr = `${yesterday.getFullYear()}-${String(yesterday.getMonth()+1).padStart(2,'0')}-${String(yesterday.getDate()).padStart(2,'0')}`;
                        appData.stats.general.streak = appData.stats.general.lastStudyDate === yesterdayStr ? appData.stats.general.streak + 1 : 1;
                        appData.stats.general.lastStudyDate = todayStr;
                    }
                }
                if (appData.timerState.pomodorosInCycle >= POMODOROS_PER_CYCLE) {
                    nextModeToTransitionTo = 'longBreak';
                    appData.stats.daily.cyclesCompleted++;
                    appData.stats.general.totalCyclesCompleted++;
                    showCycleCompleteNotification = true;
                } else {
                    nextModeToTransitionTo = 'shortBreak';
                }
            } else if (endedMode === 'shortBreak') {
                appData.stats.general.totalShortBreakSeconds+=completedDurationInSeconds;
                notificationTitleKey="toast_break_over_title"; notificationBodyKey="toast_break_over_body"; soundNoteForEndedMode='E4'; nextModeToTransitionTo='study';
            } else if (endedMode === 'longBreak') {
                appData.stats.general.totalLongBreakSeconds+=completedDurationInSeconds;
                notificationTitleKey="toast_long_break_over_title"; notificationBodyKey="toast_long_break_over_body"; soundNoteForEndedMode='E4';
                appData.timerState.pomodorosInCycle = 0;
                nextModeToTransitionTo = 'study'; shouldAutoStart = false;
            }
            checkGoalProgress();
            checkAchievements();
            updateStatsDisplay();
            saveData();
            playSound(soundNoteForEndedMode, '4n', 'timerComplete');
            showToast(getText(notificationTitleKey), getText(notificationBodyKey), 'info');
            if (showCycleCompleteNotification) {
                showToast(getText("toast_cycle_complete_title"), getText("toast_cycle_complete_body"), 'success', 5000);
            }
            if (nextModeToTransitionTo) {
                setTimer(nextModeToTransitionTo);
                if (shouldAutoStart) startTimer();
            } else {
                startPauseButton.querySelector('span').textContent = getText('start_button');
                startPauseButton.querySelector('i').className = 'fas fa-play mr-2';
            }
        }
        
        function resetCurrentTimer() {
            if(appData.timerState.isRunning && timerWorker) timerWorker.postMessage({command:'pause'});
            appData.timerState.isRunning = false;
            let newTimeLeft;
            switch(appData.timerState.currentMode){case'study':newTimeLeft=appData.settings.studyTime*60;break;case'shortBreak':newTimeLeft=appData.settings.shortBreakTime*60;break;case'longBreak':newTimeLeft=appData.settings.longBreakTime*60;break;default:newTimeLeft=appData.settings.studyTime*60;}
            appData.timerState.timeLeft=newTimeLeft;
            if(timerWorker)timerWorker.postMessage({command:'setMode',mode:appData.timerState.currentMode,duration:appData.timerState.timeLeft});
            startPauseButton.querySelector('span').textContent=getText('start_button');
            startPauseButton.querySelector('i').className='fas fa-play mr-2';
            updateTimerDisplay();
            saveData();
        }
        
        function archiveGoalProgress() {
            const history = appData.stats.goalHistory || [];
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const recentHistory = history.filter(entry => new Date(entry.date) >= sevenDaysAgo);
            const todayStr = appData.stats.daily.date;
            if (appData.dailyGoal.target > 0) {
                const existingEntryIndex = recentHistory.findIndex(e => e.date === todayStr);
                const entry = { date: todayStr, target: appData.dailyGoal.target, progress: appData.dailyGoal.progress, completed: appData.dailyGoal.completed };
                if (existingEntryIndex > -1) {
                    recentHistory[existingEntryIndex] = entry;
                } else {
                    recentHistory.push(entry);
                }
            }
            appData.stats.goalHistory = recentHistory.slice(-7);
        }
        
        function resetDailyStats() {
            appData.stats.daily={date:getTodayDateString(),focusSessions:0,cyclesCompleted:0,pureStudySeconds:0,totalTimeSeconds:0,firstStudySessionCompletedToday:false};
            appData.dailyGoal.progress=0;appData.dailyGoal.completed=false;appData.dailyGoal.notificationShown=false;
        }
        
        function setTabStyling(isCollapsed) {
            tabButtons.forEach(btn => {
                const isActive = btn.dataset.tab === activeTabId;
                btn.classList.remove('active', 'text-sky-400', 'text-slate-400');
                if (isCollapsed) {
                    btn.classList.add('text-slate-400');
                } else {
                    if (isActive) {
                        btn.classList.add('active', 'text-sky-400');
                    } else {
                        btn.classList.add('text-slate-400');
                    }
                }
            });
        }
        
        function showTab(tabId) {
            activeTabId = tabId;
            setTabStyling(false);
            tabPanes.forEach(pane => {
                const isTargetPane = pane.id === `${tabId}Content`;
                pane.style.display = isTargetPane ? 'flex' : 'none';
                pane.classList.toggle('active', isTargetPane);
            });
            if (tabId === 'achievements') {
                justSeenAchievementIds = [];
                appData.achievements.forEach(ach => {
                    if (ach.unlocked && !ach.seen) justSeenAchievementIds.push(ach.id);
                    if (ach.unlocked) ach.seen = true;
                });
                appData.uiState.newAchievementsCount = 0;
                updateNotificationBadges();
                saveData();
                renderAchievements();
            } else if (tabId === 'dailyGoal') {
                requestAnimationFrame(() => {
                    renderGoalHistoryChart();
                });
                if (appData.dailyGoal.target <= 0) {
                    showGoalEditView(true);
                } else {
                    showGoalEditView(false);
                }
            }
        }
        
        function setTodaysGoal() {
            const settings = appData.dailyGoal.settings;
            const today = new Date().getDay();
            let newTarget = 0;
            switch(settings.mode){case'weekend':newTarget=(today===0||today===6)?settings.targetWeekend:settings.targetWeekday;break;case'custom':newTarget=settings.targetsCustom[today];break;case'all_days':default:newTarget=settings.targetAll;break;}
            appData.dailyGoal.target = newTarget || 0;
        }
        
        function checkGoalProgress() {
            const goal = appData.dailyGoal;
            if (goal.target <= 0) { renderDailyGoal(); return; }
            if(goal.completed) { renderDailyGoal(); if(goalHistoryChart) renderGoalHistoryChart(); return; }
            const currentProgress = appData.stats.daily.focusSessions;
            goal.progress = currentProgress;
            if (currentProgress >= goal.target) {
                goal.completed = true;
                if (!goal.notificationShown) {
                    showToast(getText('goal_completed_toast_title'), getText('goal_completed_toast_body'), 'success');
                    playSound('G5', '2n', 'goal');
                }
            }
            renderDailyGoal();
            if(goalHistoryChart) renderGoalHistoryChart();
        }
        
        function renderDailyGoal() {
            const goal = appData.dailyGoal;
            goalProgressContainer.style.display = goal.target > 0 ? 'block' : 'none';
            if (goal.target <= 0) {
                goalTextEl.textContent = getText('no_goal_set');
                editGoalButton.querySelector('span').textContent = getText('set_goal_button');
                goalProgressBarEl.style.width = '0%';
                goalProgressTextEl.textContent = '';
                return;
            }
            editGoalButton.querySelector('span').textContent = getText('edit_goal_button');
            goalTextEl.textContent = getPluralText('focusSessions', goal.target);
            const progressValue = Math.floor(goal.progress);
            goalProgressTextEl.textContent = `${progressValue} / ${goal.target}`;
            const progressPercent = Math.min(100, (goal.progress / goal.target) * 100);
            goalProgressBarEl.style.width = `${progressPercent}%`;
            goalProgressBarEl.classList.toggle('completed', goal.completed);
        }
        
        function renderGoalHistoryChart() {
            if (goalHistoryChart) {
                goalHistoryChart.destroy();
            }
            if (!goalHistoryChartCanvas) return;
            const history = appData.stats.goalHistory || [];
            const labels = [];
            const progressData = [];
            const targetData = [];
            let maxVal = 0;
            const today = new Date();
            const langCode = appData.settings.language.replace('_', '-');

            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateStr = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
                
                const dayOfWeek = date.toLocaleDateString(langCode, { weekday: 'short' });
                const dayMonth = `${String(date.getDate()).padStart(2,'0')}/${String(date.getMonth()+1).padStart(2,'0')}`;
                labels.push([dayOfWeek, dayMonth]);

                const entry = history.find(e => e.date === dateStr);
                let currentDayTarget = 0;

                if (i === 0) {
                    progressData.push(appData.dailyGoal.progress);
                    currentDayTarget = appData.dailyGoal.target;
                    targetData.push(currentDayTarget);
                } else if (entry) {
                    progressData.push(entry.progress);
                    currentDayTarget = entry.target;
                    targetData.push(currentDayTarget);
                } else {
                    progressData.push(0);
                    targetData.push(0);
                }
                maxVal = Math.max(maxVal, progressData[progressData.length - 1], currentDayTarget);
            }
            
            const suggestedMax = Math.max(4, Math.ceil(maxVal) + 1);
            const ctx = goalHistoryChartCanvas.getContext('2d');
            goalHistoryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: getText('progress_label'), data: progressData,
                        backgroundColor: (context) => context.index === 6 ? 'rgba(56, 189, 248, 1)' : 'rgba(56, 189, 248, 0.6)',
                        borderColor: 'rgba(56, 189, 248, 1)', borderWidth: 1, borderRadius: 2,
                    }, {
                        label: getText('chart_target_label'), data: targetData, type: 'line',
                        borderColor: 'rgba(239, 68, 68, 0.7)', backgroundColor: 'transparent',
                        pointBackgroundColor: 'rgba(239, 68, 68, 1)', borderDash: [5, 5], fill: false
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: suggestedMax, ticks: { color: '#94a3b8', stepSize: 1, precision: 0 }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                        x: { ticks: { color: (context) => context.index === 6 ? '#38bdf8' : '#94a3b8' }, grid: { display: false } }
                    },
                    plugins: {
                        legend: { display: true, position: 'top', align: 'end', labels: { color: '#cbd5e1', boxWidth: 12, padding: 20, font: { size: 10 } } },
                        tooltip: { callbacks: { label: function(context) { let label = context.dataset.label || ''; if (label) { label += ': '; } if (context.parsed.y !== null) { label += Math.floor(context.parsed.y); } return label; } } }
                    }
                }
            });
        }
        
        function showGoalEditView(show) {
            if (show) {
                goalDisplayView.classList.add('hidden'); goalEditView.classList.remove('hidden');
                const settings = appData.dailyGoal.settings;
                document.querySelector(`input[name="goalMode"][value="${settings.mode}"]`).checked = true;
                document.getElementById('goalValueInputAll').value=settings.targetAll;
                document.getElementById('goalValueInputWeekday').value=settings.targetWeekday;
                document.getElementById('goalValueInputWeekend').value=settings.targetWeekend;
                const customContainer=document.querySelector('#goalInputsCustom .custom-day-grid');
                customContainer.innerHTML='';
                const dayNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
                settings.targetsCustom.forEach((val,i)=>{const dayName=dayNames[i];const inputHtml=`<div class="custom-day-input-group"><label for="goalDay${i}" class="block">${dayName}</label><input type="number" id="goalDay${i}" data-day-index="${i}" min="0" value="${val}" class="w-full p-2 rounded bg-slate-600 text-white border border-slate-500 text-center focus:ring-sky-500 focus:border-sky-500"></div>`;customContainer.insertAdjacentHTML('beforeend',inputHtml);});
                document.querySelectorAll('input[name="goalMode"]').forEach(radio=>radio.dispatchEvent(new Event('change')));
            } else {
                goalDisplayView.classList.remove('hidden'); goalEditView.classList.add('hidden');
            }
        }
        
        function checkAchievements() {
            const newlyUnlocked = [];
            appData.achievements.forEach(ach => {
                if (!ach.unlocked) {
                    const progress = getAchievementProgress(ach.type, ach.threshold);
                    if (progress.current >= ach.threshold) {
                        ach.unlocked = true;
                        ach.unlockedDate = new Date().toISOString();
                        ach.seen = false;
                        newlyUnlocked.push(ach);
                    }
                }
            });

            if (newlyUnlocked.length > 0) {
                newlyUnlocked.forEach((ach, index) => {
                    setTimeout(() => {
                        const achName = getText(`achievements.${ach.id}.name`);
                        showToast(getText("toast_achievement_unlocked_title"), getText("toast_achievement_unlocked_body", achName), "success", 5000);
                        playSound("C5", "4n", "achievement");
                    }, 600 * index);
                });
                appData.uiState.newAchievementsCount += newlyUnlocked.length;
                updateNotificationBadges();
                if (activeTabId === "achievements") {
                    renderAchievements();
                }
            }
        }
        
        let timerWorker;
        if (window.Worker) {
            try {
                const workerScript = document.getElementById('timerWorkerScript').textContent;
                const blob = new Blob([workerScript], { type: 'application/javascript' });
                timerWorker = new Worker(URL.createObjectURL(blob));
                timerWorker.onmessage = function(e) {
                    const { type, timeLeft: workerTimeLeftUpdate, mode: workerMode } = e.data;
                    if(type==='tick'){appData.timerState.timeLeft=workerTimeLeftUpdate;if(appData.timerState.currentMode===workerMode)updateTimerDisplay();}else if(type==='end'){if(appData.timerState.currentMode===workerMode)handleTimerEnd(currentTimerInitialDuration);}else if(type==='modeSet'){appData.timerState.timeLeft=workerTimeLeftUpdate;updateTimerDisplay();}
                };
                timerWorker.onerror = function(error) { timerWorker = null; };
            } catch (e) {
                timerWorker = null;
            }
        }
        
        function startMidnightChecker() {
            setInterval(() => {
                const todayString = getTodayDateString();
                if (appData.stats.daily.date !== todayString) {
                    showToast(getText("toast_new_day_title"), getText("toast_new_day_body"), "info");
                    archiveGoalProgress(); resetDailyStats(); setTodaysGoal(); saveData(); updateStatsDisplay(); renderAllDynamicContent();
                }
            }, 60000);
        }
        
        function renderAllDynamicContent() {
             updateTimerDisplay(); updateStatsDisplay(); renderDailyGoal(); renderAchievements();
             if (document.getElementById('dailyGoalContent').classList.contains('active')) {
                 renderGoalHistoryChart();
             }
        }
        
        function initializeApp() {
            appContainer.style.display = 'block';
            appContainer.classList.remove('hidden');
            loadData();
            setTodaysGoal();
            checkGoalProgress();
            const todayStrInitialize = getTodayDateString();
            if (appData.stats.general.lastStudyDate && appData.stats.general.lastStudyDate !== todayStrInitialize) {
                const lastStudy=new Date(appData.stats.general.lastStudyDate), today=new Date(todayStrInitialize), yesterday=new Date(today);
                yesterday.setDate(today.getDate() - 1);
                lastStudy.setHours(0,0,0,0); yesterday.setHours(0,0,0,0);
                if (lastStudy.getTime() < yesterday.getTime()) {
                    appData.stats.general.streak = 0;
                }
            }
            const persistedState = { ...appData.timerState };
            appData.timerState.currentMode = persistedState.currentMode || 'study';
            appData.timerState.timeLeft = persistedState.timeLeft;
            appData.timerState.pomodorosInCycle = persistedState.pomodorosInCycle || 0;
            const wasRunning = persistedState.isRunning || false;
            appData.timerState.isRunning = false;
            if (timerWorker) {
                timerWorker.postMessage({ command: 'updateSettings', settings: appData.settings });
                timerWorker.postMessage({ command: 'setMode', mode: appData.timerState.currentMode, duration: appData.timerState.timeLeft });
            }
            applyTranslations();
            if (wasRunning && appData.timerState.timeLeft > 0) {
                appData.timerState.isRunning = true;
                startPauseButton.querySelector('span').textContent = getText('pause_button');
                startPauseButton.querySelector('i').className = 'fas fa-pause mr-2';
                if (timerWorker) timerWorker.postMessage({ command: 'start' });
            } else {
                startPauseButton.querySelector('span').textContent = getText('start_button');
                startPauseButton.querySelector('i').className = 'fas fa-play mr-2';
            }
            if (appData.uiState.tabsCollapsed) {
                tabContentEl.classList.add('collapsed');
                collapseIcon.className = 'fas fa-chevron-down';
                setTabStyling(true);
            } else {
                collapseIcon.className = 'fas fa-chevron-up';
                setTabStyling(false);
            }
            renderAllDynamicContent();
            updateNotificationBadges();
            startMidnightChecker();
        }
        
        function setupLanguageChoices() {
            const languageDisplayNames = { 'en': 'English', 'pt-BR': 'Portugu√™s', 'es': 'Espa√±ol', 'fr': 'Fran√ßais', 'de': 'Deutsch', 'ja': 'Êó•Êú¨Ë™û', 'ru': '–†—É—Å—Å–∫–∏–π', 'zh-CN': '‰∏≠Êñá', 'hi-IN': '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä' };
            Object.entries(languageDisplayNames).forEach(([code, name]) => {
                const option = document.createElement('option');
                option.value = code; option.textContent = name;
                languageSelect.appendChild(option);
                const button = document.createElement('button');
                button.textContent = name; button.dataset.lang = code;
                button.className = "w-full px-4 py-3 bg-slate-700 hover:bg-sky-500 rounded-lg transition-colors font-semibold text-sm";
                languageButtonsContainer.appendChild(button);
            });
            for (const lang in translations) {
                if (translations.hasOwnProperty(lang) && lang !== 'en') {
                    for (const key in translations.en) {
                        if (!translations[lang][key]) {
                            translations[lang][key] = translations.en[key];
                        }
                    }
                }
            }
        }
        
        function handleFirstVisit() {
            languageModal.classList.add('show');
            languageButtonsContainer.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && e.target.dataset.lang) {
                    const selectedLang = e.target.dataset.lang;
                    appData.settings.language = selectedLang;
                    saveData();
                    languageModal.classList.remove('show');
                    initializeApp();
                }
            });
        }
        
        window.addEventListener('beforeunload', () => {
            if (!blockUnloadSave) {
                archiveGoalProgress();
                saveData();
            }
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            setupLanguageChoices();
            if (!localStorage.getItem(STORAGE_KEY)) {
                handleFirstVisit();
            } else {
                initializeApp();
            }
        
            startPauseButton.addEventListener('click', () => {
                if (Tone.context.state !== 'running') { try { Tone.start(); } catch (e) {} }
                if (appData.timerState.isRunning) {
                    pauseTimer();
                } else {
                    startTimer();
                }
            });
        
            resetButton.addEventListener('click', resetCurrentTimer);
        
            resetCycleCountButtonEl.addEventListener('click', () => {
                showCustomAlert(getText('alert_reset_cycle_title'), getText('alert_reset_cycle_body'), 'fas fa-sync-alt text-sky-400', getText('confirm_button'), getText('cancel_button'),
                    () => {
                        appData.timerState.pomodorosInCycle = 0;
                        if(appData.timerState.currentMode !== 'study') { setTimer('study'); }
                        updateCycleInfo();
                        saveData();
                    }
                );
            });
        
            skipBreakButton.addEventListener('click', () => {
                if (appData.timerState.currentMode === 'shortBreak' || appData.timerState.currentMode === 'longBreak') {
                    handleTimerEnd(0);
                }
            });
        
            settingsButton.addEventListener('click', () => {
                studyTimeInput.value=appData.settings.studyTime; shortBreakTimeInput.value=appData.settings.shortBreakTime; longBreakTimeInput.value=appData.settings.longBreakTime;
                soundToggle.checked=appData.settings.soundEnabled; languageSelect.value=appData.settings.language;
                settingsModal.classList.add('show');
            });
        
            helpButton.addEventListener('click', () => {
                showCustomAlert(getText('alert_help_title'), getText('alert_help_body'), 'fas fa-question-circle text-sky-400', getText('got_it_button'), null, null, null, true);
            });
        
            cancelSettingsButton.addEventListener('click', () => {
                settingsModal.classList.remove('show');
            });
        
            saveSettingsButton.addEventListener('click', () => {
                const newStudyTime = parseInt(studyTimeInput.value);
                const newShortBreakTime = parseInt(shortBreakTimeInput.value);
                const newLongBreakTime = parseInt(longBreakTimeInput.value);
                const newLang = languageSelect.value;
                const soundEnabled = soundToggle.checked;
                const oldLang = appData.settings.language;
                if (newStudyTime>0)appData.settings.studyTime=newStudyTime;
                if (newShortBreakTime>0)appData.settings.shortBreakTime=newShortBreakTime;
                if (newLongBreakTime>0)appData.settings.longBreakTime=newLongBreakTime;
                appData.settings.language = newLang;
                appData.settings.soundEnabled = soundEnabled;
                if (newLang !== oldLang) {
                    appData.achievements = buildAchievements(newLang, appData.achievements);
                    applyTranslations();
                    renderAllDynamicContent();
                }
                if (timerWorker) {
                    timerWorker.postMessage({ command: 'updateSettings', settings: appData.settings });
                }
                if (!appData.timerState.isRunning) {
                    resetCurrentTimer();
                }
                saveData();
                settingsModal.classList.remove('show');
                showToast(getText('toast_settings_saved_title'), getText('toast_settings_saved_body'), 'success');
            });

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.dataset.tab;
                    if (tabContentEl.classList.contains('collapsed')) {
                        tabContentEl.classList.remove('collapsed');
                        appData.uiState.tabsCollapsed = false;
                        collapseIcon.className = 'fas fa-chevron-up';
                    }
                    if (activeTabId !== targetTab) {
                        showTab(targetTab);
                    }
                });
            });

            collapseTabsButton.addEventListener('click', () => {
                const isCollapsed = tabContentEl.classList.contains('collapsed');
                appData.uiState.tabsCollapsed = !isCollapsed;
                if (isCollapsed) {
                    tabContentEl.classList.remove('collapsed');
                    collapseIcon.className = 'fas fa-chevron-up';
                    setTabStyling(false); 
                } else {
                    tabContentEl.classList.add('collapsed');
                    collapseIcon.className = 'fas fa-chevron-down';
                    setTabStyling(true);
                }
                saveData();
            });

            editGoalButton.addEventListener('click', () => showGoalEditView(true));
            
            cancelGoalButton.addEventListener('click', () => {
                if(appData.dailyGoal.target > 0 || Object.values(appData.dailyGoal.settings).some(v => Array.isArray(v) ? v.some(n => n > 0) : v > 0)) {
                    showGoalEditView(false);
                }
            });

            saveGoalButton.addEventListener('click', () => {
                const settings = appData.dailyGoal.settings;
                settings.mode = document.querySelector('input[name="goalMode"]:checked').value;
                settings.targetAll = parseInt(document.getElementById('goalValueInputAll').value) || 0;
                settings.targetWeekday = parseInt(document.getElementById('goalValueInputWeekday').value) || 0;
                settings.targetWeekend = parseInt(document.getElementById('goalValueInputWeekend').value) || 0;
                document.querySelectorAll('#goalInputsCustom input').forEach(input => {
                    const dayIndex = parseInt(input.dataset.dayIndex);
                    settings.targetsCustom[dayIndex] = parseInt(input.value) || 0;
                });
                
                const studyTime = appData.settings.studyTime;
                const maxMinutes = 24 * 60;
                const allTargets = [settings.targetAll, settings.targetWeekday, settings.targetWeekend, ...settings.targetsCustom];
                if (allTargets.some(target => (target * studyTime) > maxMinutes)) {
                    showToast(getText('toast_goal_too_long_title'), getText('toast_goal_too_long_body'), 'error', 5000);
                    return;
                }

                setTodaysGoal();
                checkGoalProgress();
                saveData();
                showGoalEditView(false);
                showToast(getText("toast_settings_saved_title"), getText("toast_goal_saved_body"), "success");
            });

            importDataButton.addEventListener('click', () => { importFileInput.click(); });

            importFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) { event.target.value = ''; return; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedFileContent = e.target.result;
                        let importedData = JSON.parse(importedFileContent);

                        if (!importedData.settings || !importedData.stats) {
                            throw new Error("Invalid backup file structure.");
                        }

                        // Legacy data migration: Calculate totalFocusSessions from totalCyclesCompleted
                        if (importedData.stats && importedData.stats.general &&
                            (!importedData.stats.general.totalFocusSessions || importedData.stats.general.totalFocusSessions === 0) &&
                            importedData.stats.general.totalCyclesCompleted > 0) {
                            importedData.stats.general.totalFocusSessions = importedData.stats.general.totalCyclesCompleted * POMODOROS_PER_CYCLE;
                        }
                        
                        // Ensure achievements array exists for merging
                        if (!importedData.achievements) {
                            importedData.achievements = [];
                        }

                        const modifiedFileContent = JSON.stringify(importedData);

                        showCustomAlert(getText("alert_import_title"), getText("alert_import_body"), "fas fa-exclamation-triangle text-yellow-400", getText("confirm_button"), getText("cancel_button"),
                            () => {
                                localStorage.setItem(STORAGE_KEY, modifiedFileContent);
                                blockUnloadSave = true;
                                settingsModal.classList.remove('show');
                                location.reload();
                            },
                            () => { event.target.value = ''; }
                        );
                    } catch (error) {
                        console.error("Import Error: ", error);
                        showToast(getText('toast_import_error_title'), getText('toast_import_error_body'), 'error');
                        event.target.value = '';
                    }
                };
                reader.onerror = () => { showToast(getText('toast_import_error_title'), 'Could not read the selected file.', 'error'); event.target.value = ''; };
                reader.readAsText(file);
            });
            
            customAlertConfirmButton.addEventListener('click', () => { if (typeof currentConfirmCallback === 'function') currentConfirmCallback(); customAlertModal.classList.remove('show'); currentConfirmCallback = null; currentCancelCallback = null; });
            customAlertCancelButton.addEventListener('click', () => { if (typeof currentCancelCallback === 'function') currentCancelCallback(); customAlertModal.classList.remove('show'); currentConfirmCallback = null; currentCancelCallback = null; });

            document.querySelectorAll('input[name="goalMode"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    document.getElementById('goalInputsAllDays').classList.toggle('hidden', e.target.value !== 'all_days');
                    document.getElementById('goalInputsWeekend').classList.toggle('hidden', e.target.value !== 'weekend');
                    document.getElementById('goalInputsCustom').classList.toggle('hidden', e.target.value !== 'custom');
                });
            });
        });
    </script>
</body>
</html>
